name: ðŸ¦ Tadawul Dashboard Advanced Sync

on:
  schedule:
    # Runs at minute 0, 15, 30, 45 every hour (UTC) - more frequent during market hours
    # Note: GitHub Actions schedules are strictly UTC. Riyadh is UTC+3.
    - cron: "0,15,30,45 * * * *"
  workflow_dispatch:
    inputs:
      backend_url:
        description: "ðŸŒ Backend URL Override"
        required: false
        type: string
      sheet_id:
        description: "ðŸ“Š Spreadsheet ID Override"
        required: false
        type: string
      run_mode:
        description: "ðŸš€ Execution Mode"
        required: true
        default: "full_sync"
        type: choice
        options:
          - full_sync
          - health_only
          - single_key
      single_key:
        description: "ðŸ”‘ Specific Key (if single_key mode)"
        required: false
        default: "MARKET_LEADERS"
        type: string
      google_creds_json:
        description: "ðŸ” Service Account JSON (Emergency Only - Prefer Secrets)"
        required: false
        type: string
      enable_debug:
        description: "ðŸ› Enable Debug Logging"
        required: false
        default: false
        type: boolean

# Concurrency: Prevent overlapping runs and API rate limits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

# Minimal permissions with future-proofing for OIDC (Workload Identity)
permissions:
  contents: read
  id-token: write # Required for Google Cloud Workload Identity Federation
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  PYTHONUNBUFFERED: 1
  TZ: Asia/Riyadh  # Set timezone for market hours and logging

jobs:
  preflight-validation:
    name: ðŸ›¡ï¸ Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.validate.outputs.validated }}
    steps:
      - name: âœ… Validate Runner Environment
        id: validate
        run: |
          echo "::group::System Information"
          echo "OS: $(uname -a)"
          df -h /
          free -h
          echo "::endgroup::"
          
          # Check required tools
          MISSING_TOOLS=()
          for tool in curl jq python3 pip3 shred; do
            if ! command -v $tool &> /dev/null; then
              MISSING_TOOLS+=($tool)
            fi
          done
          
          if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
            echo "::error::Missing required tools: ${MISSING_TOOLS[*]}"
            exit 1
          fi
          
          echo "validated=true" >> "$GITHUB_OUTPUT"

  sync-dashboard:
    name: ðŸš€ Data Sync
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25
    needs: preflight-validation
    if: success()

    steps:
      - name: ðŸ“¥ Secure Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements*.txt'

      - name: ðŸ“¦ Install & Verify Dependencies
        run: |
          echo "::group::Pip Install Log"
          python -m pip install --upgrade pip setuptools wheel
          
          if [ -f "requirements-hashes.txt" ]; then
            echo "ðŸ”’ Installing from hashed requirements for maximum security"
            pip install --require-hashes -r requirements-hashes.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "::warning::No requirements.txt found, skipping dependency installation."
          fi
          echo "::endgroup::"
          
          echo "::group::Package Verification"
          # Gracefully check if critical packages exist without failing immediately if missing
          python -c "
          import sys
          critical = ['pandas', 'numpy', 'gspread', 'requests']
          missing = []
          for pkg in critical:
              try: __import__(pkg)
              except ImportError: missing.append(pkg)
          if missing:
              print(f'âš ï¸ Warning: Missing expected packages: {missing}')
          else:
              print('âœ… Critical packages loaded successfully')
          "
          echo "::endgroup::"

      # --- ADVANCED GCP OIDC OPTION (Uncomment to use instead of JSON Keys) ---
      # - name: ðŸ” Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
      #     service_account: 'my-service-account@my-project.iam.gserviceaccount.com'

      - name: âš™ï¸ Smart Configuration Resolution
        id: smart_config
        env:
          INPUT_URL: ${{ inputs.backend_url }}
          INPUT_SHEET: ${{ inputs.sheet_id }}
          INPUT_MODE: ${{ inputs.run_mode }}
          INPUT_KEY: ${{ inputs.single_key }}
          INPUT_DEBUG: ${{ inputs.enable_debug }}
          INPUT_CREDS: ${{ inputs.google_creds_json }}
          
          VAR_URL: ${{ vars.BACKEND_BASE_URL }}
          VAR_SHEET: ${{ vars.DEFAULT_SPREADSHEET_ID }}
          VAR_DEFAULT_KEYS: ${{ vars.DEFAULT_SYNC_KEYS }}
          SECRET_CREDS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SECRET_CREDS_B64: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_B64 }}
        run: |
          # Helper function to get first non-empty value
          get_val() {
            for v in "$@"; do
              if [[ -n "$v" && "$v" != "null" && "$v" != "undefined" ]]; then 
                echo "$v"
                return
              fi
            done
          }

          echo "::group::ðŸ”§ Configuration Resolution"

          # 1. URL Resolution
          URL=$(get_val "$INPUT_URL" "$VAR_URL" "https://tadawul-fast-bridge.onrender.com")
          URL=${URL%/} # Strip trailing slash
          if [[ ! "$URL" =~ ^https?:// ]]; then
            echo "::error::Invalid URL format: $URL"
            exit 1
          fi
          echo "TARGET_URL=$URL" >> "$GITHUB_ENV"
          echo "âœ… Backend URL: $URL"

          # 2. Spreadsheet ID Resolution
          SHEET=$(get_val "$INPUT_SHEET" "$VAR_SHEET" "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw")
          echo "TARGET_SHEET_ID=$SHEET" >> "$GITHUB_ENV"
          echo "âœ… Sheet ID: $SHEET"

          # 3. Mode & Keys Resolution
          MODE="${INPUT_MODE:-full_sync}"
          echo "RUN_MODE=$MODE" >> "$GITHUB_ENV"
          
          if [[ "$MODE" == "single_key" && -n "$INPUT_KEY" ]]; then
            KEYS="$INPUT_KEY"
          else
            DEFAULT_KEYS="MARKET_LEADERS GLOBAL_MARKETS KSA_TADAWUL MUTUAL_FUNDS COMMODITIES_FX MY_PORTFOLIO INSIGHTS_ANALYSIS"
            KEYS=$(get_val "$VAR_DEFAULT_KEYS" "$DEFAULT_KEYS")
          fi
          
          # Normalize keys (single spaces)
          KEYS=$(echo "$KEYS" | tr -s ' ' | xargs)
          echo "SYNC_KEYS=$KEYS" >> "$GITHUB_ENV"
          echo "ðŸ“‹ Mode: $MODE | Keys: $KEYS"

          # 4. Debug Flag
          DEBUG="${INPUT_DEBUG:-false}"
          echo "ENABLE_DEBUG=$DEBUG" >> "$GITHUB_ENV"

          # 5. Credentials Handling (Secure)
          RAW_CREDS=$(get_val "$INPUT_CREDS" "$SECRET_CREDS")
          
          if [[ -z "$RAW_CREDS" && -n "$SECRET_CREDS_B64" ]]; then
            echo "ðŸ”“ Decoding Base64 credentials..."
            RAW_CREDS=$(echo "$SECRET_CREDS_B64" | base64 --decode 2>/dev/null || echo "")
          fi

          if [[ -n "$RAW_CREDS" ]]; then
            # SECURITY: Mask credentials before processing
            echo "::add-mask::$RAW_CREDS"
            
            if echo "$RAW_CREDS" | jq empty 2>/dev/null; then
              CREDS_PATH="$RUNNER_TEMP/google_credentials.json"
              echo "$RAW_CREDS" > "$CREDS_PATH"
              chmod 600 "$CREDS_PATH"
              echo "GOOGLE_APPLICATION_CREDENTIALS=$CREDS_PATH" >> "$GITHUB_ENV"
              
              SA_EMAIL=$(echo "$RAW_CREDS" | jq -r '.client_email // "Unknown"')
              echo "ðŸ¤– Service Account Configured: $SA_EMAIL"
            else
              echo "::error::Invalid JSON structure in credentials."
              exit 1
            fi
          elif [[ "$MODE" != "health_only" ]]; then
            echo "::error::No valid Google credentials found for sync mode."
            exit 1
          fi

          echo "::endgroup::"

      - name: ðŸ’“ Intelligent Health Check
        id: health_check
        run: |
          echo "::group::ðŸ¥ Backend Health Check"
          
          HEALTH_ENDPOINTS=("/readyz" "/health" "/livez")
          MAX_RETRIES=4
          
          for endpoint in "${HEALTH_ENDPOINTS[@]}"; do
            echo "â–¶ï¸ Probing $TARGET_URL$endpoint..."
            
            for attempt in $(seq 1 $MAX_RETRIES); do
              BACKOFF=$(( 2 ** attempt )) # Exponential: 2, 4, 8, 16s
              
              RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "$TARGET_URL$endpoint" 2>&1 || echo -e "\n000")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
                echo "âœ… Healthy via $endpoint (HTTP $HTTP_CODE)"
                VERSION=$(echo "$BODY" | jq -r '.version // .build // "unknown"' 2>/dev/null || echo "unknown")
                
                echo "health_status=healthy" >> "$GITHUB_OUTPUT"
                echo "health_version=$VERSION" >> "$GITHUB_OUTPUT"
                echo "::endgroup::"
                exit 0
              fi
              
              echo "â³ Attempt $attempt/$MAX_RETRIES: HTTP $HTTP_CODE, retrying in ${BACKOFF}s..."
              sleep $BACKOFF
            done
          done
          
          echo "::warning::All health check endpoints failed. Backend may be degraded."
          echo "health_status=degraded" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: ðŸš€ Execute Dashboard Sync
        id: execute_sync
        env:
          BACKEND_URL: ${{ env.TARGET_URL }}
          SPREADSHEET_ID: ${{ env.TARGET_SHEET_ID }}
          SYNC_MODE: ${{ env.RUN_MODE }}
          DEBUG_MODE: ${{ env.ENABLE_DEBUG }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "::group::ðŸ“Š Sync Execution"
          
          # Construct Command
          CMD="python scripts/run_dashboard_sync.py --health-check"
          
          if [[ "$RUN_MODE" == "health_only" ]]; then
            CMD="$CMD --dry-run --health-only"
          elif [[ "$RUN_MODE" == "single_key" ]]; then
            CMD="$CMD --single-key"
          fi
          
          CMD="$CMD --keys $SYNC_KEYS"
          
          if [[ "$ENABLE_DEBUG" == "true" ]]; then
            CMD="$CMD --debug --verbose"
            echo "ðŸ” Debug mode active."
          fi
          
          echo "â±ï¸ Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“‹ Command: $CMD"
          
          # Using pipefail ensures the exit code of python is caught even when piping to tee
          set -o pipefail
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          LOG_FILE="sync_${TIMESTAMP}.log"
          
          START_TIME=$(date +%s)
          
          # Execute and log
          $CMD 2>&1 | tee "$LOG_FILE"
          EXIT_CODE=$?
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "âœ… Execution finished in ${DURATION}s (Exit Code: $EXIT_CODE)"
          
          # Log Analysis
          if grep -qiE "RateLimitError|Quota exceeded|429 Too Many Requests" "$LOG_FILE"; then
            echo "::warning::Google APIs Rate limits / Quotas may have been exhausted."
            echo "rate_limited=true" >> "$GITHUB_OUTPUT"
          fi
          
          if grep -qiE "AuthenticationError|InvalidGrant|401 Unauthorized" "$LOG_FILE"; then
            echo "::error::Google Sheets authentication failed. Check credentials."
            EXIT_CODE=1
          fi
          
          cp "$LOG_FILE" sync_execution.log
          echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Sync script failed. See logs above."
            exit $EXIT_CODE
          fi

      - name: ðŸ“ Generate Comprehensive Summary
        if: always()
        run: |
          RIYADH_TIME=$(TZ=Asia/Riyadh date '+%Y-%m-%d %H:%M:%S %Z')
          STATUS_ICON=$([[ "${{ job.status }}" == "success" ]] && echo "âœ… **SUCCESS**" || echo "âŒ **FAILED**")
          
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          # ðŸ¦ Tadawul Dashboard Sync Report
          
          ## ðŸ“‹ Execution Overview
          | Metric | Value |
          | :--- | :--- |
          | **Status** | $STATUS_ICON |
          | **Trigger** | \`${{ github.event_name }}\` |
          | **Time (Local)** | \`$RIYADH_TIME\` |
          | **Run Mode** | \`${{ env.RUN_MODE }}\` |
          | **Duration** | \`${{ steps.execute_sync.outputs.duration || '0' }} seconds\` |
          
          ## ðŸŽ¯ Target Information
          * **Sheet ID:** \`${{ env.TARGET_SHEET_ID }}\`
          * **Backend:** \`${{ env.TARGET_URL }}\` *(Status: ${{ steps.health_check.outputs.health_status || 'Unknown' }})*
          
          ## ðŸ”‘ Synced Keys
          \`\`\`text
          ${{ env.SYNC_KEYS }}
          \`\`\`
          EOF
          
          if [[ "${{ steps.execute_sync.outputs.rate_limited }}" == "true" ]]; then
            echo -e "\n> âš ï¸ **Notice:** Rate limiting was detected in the logs. Consider spacing out chron jobs." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ðŸ“¤ Upload Execution Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tadawul-sync-logs-${{ github.run_id }}
          path: |
            sync_*.log
            sync_execution.log
          retention-days: 7
          compression-level: 6

      - name: ðŸ”” Webhook Failure Notification
        if: failure() && github.event_name == 'schedule'
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }} # Set this in GitHub Repository Secrets
        run: |
          if [[ -z "$WEBHOOK_URL" ]]; then
            echo "::notice::No WEBHOOK_URL secret defined. Skipping failure notification."
            exit 0
          fi
          
          echo "::group::ðŸ“§ Sending Alert"
          PAYLOAD=$(jq -n \
            --arg title "âŒ Tadawul Sync Failed" \
            --arg run "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg mode "${{ env.RUN_MODE }}" \
            '{text: ($title + "\n\n*Run:* " + $run + "\n*Mode:* " + $mode)}')
            
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$WEBHOOK_URL" || true
          echo "::endgroup::"

      - name: ðŸ§¹ Secure Cleanup
        if: always()
        run: |
          echo "::group::Cleanup"
          if [[ -f "$GOOGLE_APPLICATION_CREDENTIALS" ]]; then
            shred -u -z "$GOOGLE_APPLICATION_CREDENTIALS" 2>/dev/null || rm -f "$GOOGLE_APPLICATION_CREDENTIALS"
            echo "âœ… Google Credentials securely shredded from runner."
          fi
          echo "::endgroup::"
