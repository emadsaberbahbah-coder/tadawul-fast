# .github/workflows/daily_sync.yml  (FULL REPLACEMENT)
name: Tadawul Dashboard Sync

on:
  schedule:
    # GitHub cron uses UTC. This runs at minute 0 every hour.
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      backend_url:
        description: "Backend URL (e.g. https://...onrender.com)"
        required: false
        default: "https://tadawul-fast-bridge.onrender.com"
      sheet_id:
        description: "Spreadsheet ID (Optional override)"
        required: false
        default: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      google_creds_json:
        description: "Service Account JSON (Paste here if Secret/Var fails)"
        required: false
      run_health_only:
        description: "If true: only /readyz + script --health, no sheet writes"
        required: false
        default: "false"
      keys:
        description: "Optional override keys list (space/comma separated). Default uses standard pages."
        required: false
        default: "MARKET_LEADERS GLOBAL_MARKETS KSA_TADAWUL MUTUAL_FUNDS COMMODITIES_FX MY_PORTFOLIO INSIGHTS_ANALYSIS"

# Prevent overlapping hourly runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  run-sync:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip check

      - name: Debug: Quick Repo Check
        run: |
          set -euo pipefail
          echo "PWD: $(pwd)"
          ls -la
          if [ ! -f scripts/run_dashboard_sync.py ]; then
            echo "::error::Missing scripts/run_dashboard_sync.py"
            exit 1
          fi
          echo "OK: scripts/run_dashboard_sync.py found"

      - name: Resolve Inputs / Defaults
        id: resolve
        env:
          # workflow_dispatch inputs
          DISPATCH_BACKEND_URL: ${{ github.event.inputs.backend_url }}
          DISPATCH_SHEET_ID: ${{ github.event.inputs.sheet_id }}
          DISPATCH_CREDS_JSON: ${{ github.event.inputs.google_creds_json }}
          DISPATCH_KEYS: ${{ github.event.inputs.keys }}
          DISPATCH_HEALTH_ONLY: ${{ github.event.inputs.run_health_only }}

          # repo variables/secrets (preferred)
          VAR_BACKEND_URL: ${{ vars.BACKEND_BASE_URL }}
          SECRET_BACKEND_URL: ${{ secrets.BACKEND_BASE_URL }}

          VAR_SHEET_ID: ${{ vars.DEFAULT_SPREADSHEET_ID }}
          SECRET_SHEET_ID: ${{ secrets.DEFAULT_SPREADSHEET_ID }}

          # credentials options
          SECRET_CREDS_JSON: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SECRET_CREDS_B64: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_B64 }}

          # optional backend auth token (if your script uses it)
          SECRET_APP_TOKEN: ${{ secrets.APP_TOKEN }}
        run: |
          set -euo pipefail

          pick_first_nonempty() {
            for v in "$@"; do
              if [ -n "${v:-}" ]; then
                printf "%s" "$v"
                return 0
              fi
            done
            return 0
          }

          # Normalize URL: trim spaces + remove trailing slash
          normalize_url() {
            local u
            u="$(printf "%s" "${1:-}" | sed 's/[[:space:]]\+$//; s/^[[:space:]]\+//')"
            u="${u%/}"
            printf "%s" "$u"
          }

          # Backend + Sheet
          BACKEND_BASE_URL="$(pick_first_nonempty "${DISPATCH_BACKEND_URL:-}" "${VAR_BACKEND_URL:-}" "${SECRET_BACKEND_URL:-}" "https://tadawul-fast-bridge.onrender.com")"
          BACKEND_BASE_URL="$(normalize_url "$BACKEND_BASE_URL")"

          DEFAULT_SPREADSHEET_ID="$(pick_first_nonempty "${DISPATCH_SHEET_ID:-}" "${VAR_SHEET_ID:-}" "${SECRET_SHEET_ID:-}" "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw")"

          # Keys: allow commas/spaces/newlines, dedupe, keep order-ish
          KEYS_RAW="$(pick_first_nonempty "${DISPATCH_KEYS:-}" "MARKET_LEADERS GLOBAL_MARKETS KSA_TADAWUL MUTUAL_FUNDS COMMODITIES_FX MY_PORTFOLIO INSIGHTS_ANALYSIS")"
          KEYS_NORM="$(printf "%s" "$KEYS_RAW" | tr ',\n\r\t' ' ' | tr -s ' ' | sed 's/^ *//; s/ *$//')"

          # Health only flag
          HEALTH_ONLY_RAW="$(printf "%s" "${DISPATCH_HEALTH_ONLY:-false}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"
          if [ "$HEALTH_ONLY_RAW" = "1" ] || [ "$HEALTH_ONLY_RAW" = "true" ] || [ "$HEALTH_ONLY_RAW" = "yes" ] || [ "$HEALTH_ONLY_RAW" = "y" ] || [ "$HEALTH_ONLY_RAW" = "on" ]; then
            HEALTH_ONLY="true"
          else
            HEALTH_ONLY="false"
          fi

          # Credentials: dispatch JSON > secret JSON > secret B64
          GOOGLE_SHEETS_CREDENTIALS="$(pick_first_nonempty "${DISPATCH_CREDS_JSON:-}" "${SECRET_CREDS_JSON:-}")"
          if [ -z "${GOOGLE_SHEETS_CREDENTIALS:-}" ] && [ -n "${SECRET_CREDS_B64:-}" ]; then
            # base64 decode (no printing)
            GOOGLE_SHEETS_CREDENTIALS="$(printf "%s" "$SECRET_CREDS_B64" | base64 --decode)"
          fi

          # Optional app token
          APP_TOKEN="$(pick_first_nonempty "${SECRET_APP_TOKEN:-}")"

          # Outputs
          {
            echo "BACKEND_BASE_URL=$BACKEND_BASE_URL"
            echo "DEFAULT_SPREADSHEET_ID=$DEFAULT_SPREADSHEET_ID"
            echo "KEYS_NORM=$KEYS_NORM"
            echo "HEALTH_ONLY=$HEALTH_ONLY"
          } >> "$GITHUB_OUTPUT"

          # Env for next steps
          {
            echo "BACKEND_BASE_URL=$BACKEND_BASE_URL"
            echo "DEFAULT_SPREADSHEET_ID=$DEFAULT_SPREADSHEET_ID"
            echo "KEYS_NORM=$KEYS_NORM"
            echo "HEALTH_ONLY=$HEALTH_ONLY"
          } >> "$GITHUB_ENV"

          # Export token if present (do not print)
          if [ -n "${APP_TOKEN:-}" ]; then
            echo "APP_TOKEN=$APP_TOKEN" >> "$GITHUB_ENV"
          fi

          # Export creds if present (do not print)
          if [ -n "${GOOGLE_SHEETS_CREDENTIALS:-}" ]; then
            echo "GOOGLE_SHEETS_CREDENTIALS<<EOF" >> "$GITHUB_ENV"
            echo "$GOOGLE_SHEETS_CREDENTIALS" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
          fi

          echo "Resolved (non-secret):"
          echo "  BACKEND_BASE_URL       = $BACKEND_BASE_URL"
          echo "  DEFAULT_SPREADSHEET_ID = $DEFAULT_SPREADSHEET_ID"
          echo "  KEYS                   = $KEYS_NORM"
          echo "  HEALTH_ONLY            = $HEALTH_ONLY"
          echo "  CREDS_SET              = $( [ -n "${GOOGLE_SHEETS_CREDENTIALS:-}" ] && echo yes || echo no )"
          echo "  APP_TOKEN_SET          = $( [ -n "${APP_TOKEN:-}" ] && echo yes || echo no )"

      - name: Backend Warmup (/readyz)
        env:
          URL: ${{ steps.resolve.outputs.BACKEND_BASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${URL:-}" ]; then
            echo "Backend URL missing, skipping ping..."
            exit 0
          fi

          echo "Pinging backend (best-effort): $URL/readyz"
          # Best-effort wake: don't fail the job if Render is cold
          for i in 1 2 3 4; do
            if curl -fsS --max-time 25 "$URL/readyz" >/dev/null; then
              echo "Backend readyz OK."
              exit 0
            fi
            echo "Ping attempt $i failed; retrying..."
            sleep 3
          done

          echo "Backend ping failed (backend may be cold). Continuing..."

      - name: Validate Required Config
        env:
          BACKEND_BASE_URL: ${{ steps.resolve.outputs.BACKEND_BASE_URL }}
          DEFAULT_SPREADSHEET_ID: ${{ steps.resolve.outputs.DEFAULT_SPREADSHEET_ID }}
          HEALTH_ONLY: ${{ steps.resolve.outputs.HEALTH_ONLY }}
        run: |
          set -euo pipefail

          if [ -z "${BACKEND_BASE_URL:-}" ]; then
            echo "::error::BACKEND_BASE_URL is missing!"
            exit 1
          fi

          if [ -z "${DEFAULT_SPREADSHEET_ID:-}" ]; then
            echo "::error::DEFAULT_SPREADSHEET_ID is missing!"
            exit 1
          fi

          if [ "${HEALTH_ONLY:-false}" != "true" ]; then
            if [ -z "${GOOGLE_SHEETS_CREDENTIALS:-}" ]; then
              echo "::error::GOOGLE_SHEETS_CREDENTIALS is missing! Add it in Settings > Secrets and variables > Actions."
              echo "Tip: Run workflow_dispatch with run_health_only=true to test backend without writing sheets."
              exit 1
            fi

            # Validate JSON is parseable (no printing)
            python - <<'PY'
import os, json, sys
s = os.environ.get("GOOGLE_SHEETS_CREDENTIALS","")
try:
  json.loads(s)
except Exception as e:
  print("::error::GOOGLE_SHEETS_CREDENTIALS is not valid JSON:", str(e))
  sys.exit(1)
print("Credentials JSON validated.")
PY
          else
            echo "Health-only mode: credentials not required."
          fi

          echo "Configuration OK."
          echo "Target Backend: ${BACKEND_BASE_URL}"
          echo "Target Sheet  : ${DEFAULT_SPREADSHEET_ID}"
          echo "Health Only   : ${HEALTH_ONLY}"

      - name: Prepare Google Credentials File (for libs that require a file)
        if: ${{ steps.resolve.outputs.HEALTH_ONLY != 'true' }}
        run: |
          set -euo pipefail
          CREDS_FILE="$RUNNER_TEMP/google_sa.json"
          printf "%s" "$GOOGLE_SHEETS_CREDENTIALS" > "$CREDS_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$CREDS_FILE" >> "$GITHUB_ENV"
          echo "Prepared GOOGLE_APPLICATION_CREDENTIALS (file path set)."

      - name: Run Dashboard Sync
        env:
          BACKEND_BASE_URL: ${{ steps.resolve.outputs.BACKEND_BASE_URL }}
          DEFAULT_SPREADSHEET_ID: ${{ steps.resolve.outputs.DEFAULT_SPREADSHEET_ID }}
          KEYS_NORM: ${{ steps.resolve.outputs.KEYS_NORM }}
          HEALTH_ONLY: ${{ steps.resolve.outputs.HEALTH_ONLY }}
        run: |
          set -euo pipefail

          # Build args
          ARGS=( "--health" )

          if [ -n "${KEYS_NORM:-}" ]; then
            # shellcheck disable=SC2206
            KEYS_ARR=( $KEYS_NORM )
            ARGS+=( "--keys" )
            ARGS+=( "${KEYS_ARR[@]}" )
          fi

          if [ "${HEALTH_ONLY:-false}" = "true" ]; then
            echo "Running in health-only mode (no sheet writes expected)."
            ARGS+=( "--dry-run" )
          fi

          echo "Executing:"
          echo "  python scripts/run_dashboard_sync.py ${ARGS[*]}"

          # Save a copy of logs to artifact-friendly file
          python scripts/run_dashboard_sync.py "${ARGS[@]}" 2>&1 | tee sync.log

      - name: Job Summary
        if: always()
        env:
          BACKEND_BASE_URL: ${{ steps.resolve.outputs.BACKEND_BASE_URL }}
          DEFAULT_SPREADSHEET_ID: ${{ steps.resolve.outputs.DEFAULT_SPREADSHEET_ID }}
          KEYS_NORM: ${{ steps.resolve.outputs.KEYS_NORM }}
          HEALTH_ONLY: ${{ steps.resolve.outputs.HEALTH_ONLY }}
        run: |
          set -euo pipefail
          {
            echo "## Tadawul Dashboard Sync"
            echo ""
            echo "**Backend:** \`${BACKEND_BASE_URL}\`"
            echo ""
            echo "**Sheet ID:** \`${DEFAULT_SPREADSHEET_ID}\`"
            echo ""
            echo "**Keys:** \`${KEYS_NORM}\`"
            echo ""
            echo "**Health-only:** \`${HEALTH_ONLY}\`"
            echo ""
            echo "**Run time (UTC):** \`$(date -u)\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Sync Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tadawul-sync-logs
          path: sync.log
          retention-days: 7
