name: Tadawul Dashboard Sync

on:
  schedule:
    # Runs at minute 0 every hour (UTC)
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      backend_url:
        description: "Backend URL (Override)"
        required: false
        type: string
      sheet_id:
        description: "Spreadsheet ID (Override)"
        required: false
        type: string
      run_health_only:
        description: "Dry Run (Health Check Only)"
        required: false
        type: boolean
        default: false
      keys:
        description: "Specific Keys (Space separated)"
        required: false
        default: "MARKET_LEADERS GLOBAL_MARKETS KSA_TADAWUL MUTUAL_FUNDS COMMODITIES_FX MY_PORTFOLIO INSIGHTS_ANALYSIS"
      google_creds_json:
        description: "Service Account JSON (Emergency Override)"
        required: false
        type: string

# Concurrency: Cancel previous runs if a new one starts to prevent API rate limits or write conflicts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Permissions: Minimal required permissions.
# 'id-token: write' is included for future upgrade to Google Workload Identity Federation (WIF)
permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  sync-dashboard:
    name: Sync Data
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
      # 1. Checkout Code
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. Setup Python
      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 3. Install Dependencies
      - name: ðŸ“¦ Install Libraries
        run: |
          echo "::group::Pip Install Output"
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          echo "::endgroup::"
          echo "âœ… Dependencies installed."

      # 4. Resolve Configuration (Advanced Hierarchy)
      - name: âš™ï¸ Resolve Configuration
        id: config
        env:
          # Inputs
          INPUT_URL: ${{ inputs.backend_url }}
          INPUT_SHEET: ${{ inputs.sheet_id }}
          INPUT_KEYS: ${{ inputs.keys }}
          INPUT_HEALTH: ${{ inputs.run_health_only }}
          INPUT_CREDS: ${{ inputs.google_creds_json }}
          # Secrets / Vars
          VAR_URL: ${{ vars.BACKEND_BASE_URL }}
          VAR_SHEET: ${{ vars.DEFAULT_SPREADSHEET_ID }}
          SECRET_CREDS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SECRET_CREDS_B64: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_B64 }}
        run: |
          # --- Helper Function ---
          get_val() {
            local val=""
            for v in "$@"; do
              if [[ -n "$v" && "$v" != "null" ]]; then val="$v"; break; fi
            done
            echo "$val"
          }

          echo "::group::Configuration Resolution"

          # 1. Backend URL
          URL=$(get_val "$INPUT_URL" "$VAR_URL" "https://tadawul-fast-bridge.onrender.com")
          # Remove trailing slashes
          URL=${URL%/}
          echo "TARGET_URL=$URL" >> $GITHUB_ENV
          echo "::notice::Backend set to: $URL"

          # 2. Sheet ID
          SHEET=$(get_val "$INPUT_SHEET" "$VAR_SHEET" "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw")
          echo "TARGET_SHEET_ID=$SHEET" >> $GITHUB_ENV

          # 3. Sync Keys
          KEYS=$(get_val "$INPUT_KEYS" "MARKET_LEADERS GLOBAL_MARKETS KSA_TADAWUL MUTUAL_FUNDS COMMODITIES_FX MY_PORTFOLIO INSIGHTS_ANALYSIS")
          # Normalize spaces
          KEYS=$(echo "$KEYS" | tr -s ' ')
          echo "SYNC_KEYS=$KEYS" >> $GITHUB_ENV

          # 4. Health Only Flag
          IS_HEALTH="${INPUT_HEALTH:-false}"
          echo "IS_HEALTH_ONLY=$IS_HEALTH" >> $GITHUB_ENV

          # 5. Credentials Handling
          # Priority: Input JSON > Secret JSON > Secret Base64
          RAW_CREDS=$(get_val "$INPUT_CREDS" "$SECRET_CREDS")
          
          if [[ -z "$RAW_CREDS" && -n "$SECRET_CREDS_B64" ]]; then
            echo "Decoding Base64 Credentials..."
            RAW_CREDS=$(echo "$SECRET_CREDS_B64" | base64 --decode)
          fi

          if [[ -n "$RAW_CREDS" ]]; then
            # Securely write to a temporary file
            CREDS_PATH="$RUNNER_TEMP/google_credentials.json"
            echo "$RAW_CREDS" > "$CREDS_PATH"
            echo "GOOGLE_APPLICATION_CREDENTIALS=$CREDS_PATH" >> $GITHUB_ENV
            echo "âœ… Credentials file created at $CREDS_PATH"
          elif [[ "$IS_HEALTH" == "true" ]]; then
             echo "âš ï¸ No credentials found, but running in Health-Only mode. Proceeding."
          else
             echo "::error::No Google Credentials found! Set GOOGLE_SHEETS_CREDENTIALS in secrets."
             exit 1
          fi

          echo "::endgroup::"

      # 5. Backend Health Check (With Retry)
      - name: ðŸ’“ Backend Health Check
        id: health
        run: |
          echo "Pinging $TARGET_URL/readyz..."
          
          # Retry loop: 5 attempts, waiting 5s between
          MAX_RETRIES=5
          COUNT=0
          SUCCESS=false
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s --max-time 10 "$TARGET_URL/readyz" > /dev/null; then
              echo "âœ… Backend is UP."
              SUCCESS=true
              break
            fi
            COUNT=$((COUNT+1))
            echo "â³ Attempt $COUNT/$MAX_RETRIES failed. Retrying in 5s..."
            sleep 5
          done

          if [ "$SUCCESS" = false ]; then
            echo "::warning::Backend failed health check. The sync script might fail."
          fi

      # 6. Execute Python Sync Script
      - name: ðŸš€ Run Dashboard Sync
        env:
          # Python script will look for these Envs automatically if written well,
          # otherwise we pass them as args below.
          BACKEND_URL: ${{ env.TARGET_URL }}
          SPREADSHEET_ID: ${{ env.TARGET_SHEET_ID }}
        run: |
          echo "::group::Sync Execution Logs"
          
          # Construct Command
          CMD="python scripts/run_dashboard_sync.py"
          
          # Add Flags
          CMD="$CMD --health" # Always check internal health
          
          if [[ "$IS_HEALTH_ONLY" == "true" ]]; then
             CMD="$CMD --dry-run"
          fi
          
          # Pass Keys (Bash array expansion)
          CMD="$CMD --keys $SYNC_KEYS"
          
          echo "Executing: $CMD"
          
          # Run and pipe output to tee for both console view and file logging
          # 2>&1 redirects stderr to stdout so we capture errors too
          $CMD 2>&1 | tee sync_execution.log
          
          EXIT_CODE=${PIPESTATUS[0]} # Get exit code of the python command, not tee
          echo "::endgroup::"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Sync script failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      # 7. Generate Summary (Visible in GitHub UI)
      - name: ðŸ“ Job Summary
        if: always()
        run: |
          echo "## ðŸ“Š Tadawul Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mode** | ${{ env.IS_HEALTH_ONLY == 'true' && 'ðŸ©º Health Check' || 'ðŸ”„ Full Sync' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | $TARGET_SHEET_ID |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend** | $TARGET_URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Keys" >> $GITHUB_STEP_SUMMARY
          echo "\`$SYNC_KEYS\`" >> $GITHUB_STEP_SUMMARY

      # 8. Upload Logs (Only on failure or request)
      - name: ðŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_id }}
          path: sync_execution.log
          retention-days: 5
```

### Key Improvements Explained

1.  **Cleaner Logic for Credentials**:
    * Instead of parsing JSON with Python inside Bash inside YAML, it strictly looks for the input strings.
    * It creates the standard `GOOGLE_APPLICATION_CREDENTIALS` environment variable. Most Google Client Libraries (Python included) automatically detect this file path, so you often don't even need to pass the JSON content into your Python script explicitlyâ€”the library handles it.

2.  **Robust Health Check**:
    * I replaced the simple loop with a cleaner `while` loop that includes a `sleep`.
    * It uses `::warning::` if the backend is down but doesn't immediately kill the job (allows the Python script to try and perhaps handle the error more gracefully or log specific details).

3.  **Visual Improvements**:
    * **Grouped Logs**: Steps like "Pip Install" and "Configuration" are wrapped in `::group::`. When you open the Actions run in GitHub, these will be collapsed by default, making it much easier to see the actual "Run Dashboard Sync" errors.
    * **Job Summary**: At the end of the run, a nice Markdown table appears on the Summary page showing the status, target sheet, and mode.

4.  **Bash Best Practices**:
    * Used `set -euo pipefail` implied by the defaults, but handled the pipe logging correctly using `${PIPESTATUS[0]}` to ensure if the Python script fails, the Action actually fails (common mistake when using `| tee`).

### Prerequisite

Ensure your `scripts/run_dashboard_sync.py` accepts arguments in this format:
```bash
python scripts/run_dashboard_sync.py --health --dry-run --keys KEY1 KEY2 KEY3
