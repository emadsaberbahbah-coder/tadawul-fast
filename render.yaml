# render.yaml
# ============================================================
# Tadawul Fast Bridge (FastAPI) — Render Blueprint
# EDITION: Advanced Production (v1.6.0) — Render/Free-Safe
# ============================================================
#
# Goals
# - Uses hardened start script: scripts/start_web.sh (auto workers + uvloop/httptools)
# - Riyadh timezone default
# - Secrets stay in Render Dashboard (sync: false)
# - Aligns with your available env keys list (APP_ENV/ENVIRONMENT, LOG_JSON, CORS, CACHE, etc.)
# - Healthcheck targets /readyz (boot completed)
#
# Notes
# - Do NOT commit real secrets here.
# - Keep APP_VERSION aligned with main.py (currently 6.6.0 in your enhanced main.py)

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: frankfurt
    autoDeploy: true

    # ----------------------------
    # Build
    # ----------------------------
    buildCommand: |
      python -m pip install --upgrade pip
      python -m pip install -r requirements.txt

    # ----------------------------
    # Start (delegates to hardened launcher)
    # ----------------------------
    startCommand: bash ./scripts/start_web.sh

    # ----------------------------
    # Health Check
    # ----------------------------
    healthCheckPath: /readyz
    healthCheckTimeout: 60

    # ----------------------------
    # Environment Variables
    # ----------------------------
    envVars:
      # --- Runtime Core ---
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHON_VERSION
        value: "3.11.9"
      - key: TZ
        value: "Asia/Riyadh"
      - key: TIMEZONE_DEFAULT
        value: "Asia/Riyadh"

      # --- Identity / Environment ---
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge"
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_VERSION
        value: "6.6.0"
      - key: SERVICE_VERSION
        value: "6.6.0"

      # --- Logging ---
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_JSON
        value: "false"
      # If you want a custom text format, set LOG_FORMAT in Render dashboard
      # - key: LOG_FORMAT
      #   value: "%(asctime)s | %(levelname)s | [%(request_id)s] %(name)s | %(message)s"

      # --- Docs / UI ---
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"

      # --- Fast Boot / Mounting ---
      - key: INIT_ENGINE_ON_BOOT
        value: "true"
      - key: DEFER_ROUTER_MOUNT
        value: "false"

      # --- Server Tuning (start_web.sh reads these) ---
      # Leave WEB_CONCURRENCY empty to auto-detect by CPU
      - key: WEB_CONCURRENCY
        value: ""
      - key: WEB_CONCURRENCY_MAX
        value: "4"
      - key: UVICORN_KEEPALIVE
        value: "120"
      - key: UVICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: UVICORN_ACCESS_LOG
        value: "1"
      - key: UVICORN_LIMIT_CONCURRENCY
        value: "0"
      - key: UVICORN_LIMIT_MAX_REQUESTS
        value: "0"
      - key: UVICORN_ROOT_PATH
        value: ""
      # Backlog is not used by your start_web.sh, but kept for future compatibility
      - key: UVICORN_BACKLOG
        value: "2048"

      # --- Security / Auth ---
      # REQUIRE_AUTH can be used by your auth layer (if implemented)
      - key: REQUIRE_AUTH
        value: "true"
      - key: AUTH_HEADER_NAME
        value: "X-APP-TOKEN"
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

      # --- Features ---
      - key: ADVISOR_ENABLED
        value: "true"
      - key: AI_ANALYSIS_ENABLED
        value: "true"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"

      # --- Providers / Routing ---
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam,tadawul"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      - key: KSA_DISALLOW_EODHD
        value: "true"
      - key: ENABLE_YAHOO_CHART_KSA
        value: "true"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "true"
      - key: ENABLE_YFINANCE_KSA
        value: "true"
      - key: NABLE_YAHOO_FUNDAMENTALS_KSA
        value: "true"

      # --- Provider API Keys (Secrets in Dashboard) ---
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ARGAAM_API_KEY
        sync: false
      - key: FMP_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: TWELVEDATA_API_KEY
        sync: false
      - key: MARKETSTACK_API_KEY
        sync: false

      # --- Provider Endpoint Overrides (optional / secrets if needed) ---
      - key: EODHD_BASE_URL
        sync: false
      - key: FMP_BASE_URL
        sync: false
      - key: ARGAAM_QUOTE_URL
        sync: false
      - key: ARGAAM_PROFILE_URL
        sync: false
      - key: TADAWUL_QUOTE_URL
        sync: false
      - key: TADAWUL_FUNDAMENTALS_URL
        sync: false
      - key: TADAWUL_MARKET_ENABLED
        value: "true"
      - key: TADAWUL_MAX_SYMBOLS
        value: "2500"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "120"

      # --- Google Sheets Integration (Secrets in Dashboard) ---
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_APPS_SCRIPT_URL
        sync: false
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        sync: false

      # --- Batch / Performance Controls ---
      - key: HTTP_TIMEOUT_SEC
        value: "45"
      - key: HTTP_TIMEOUT
        value: "45"
      - key: AI_BATCH_SIZE
        value: "25"
      - key: AI_MAX_TICKERS
        value: "800"
      - key: AI_BATCH_CONCURRENCY
        value: "8"
      - key: ADV_BATCH_SIZE
        value: "25"
      - key: BATCH_CONCURRENCY
        value: "8"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.5"

      # --- Cache Controls (aligns to your env key list) ---
      - key: CACHE_DEFAULT_TTL
        value: "20"
      - key: CACHE_MAX_SIZE
        value: "5000"
      - key: CACHE_SAVE_INTERVAL
        value: "60"
      - key: CACHE_BACKUP_ENABLED
        value: "true"

      # --- CORS ---
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"

      # --- Debug / Diagnostics ---
      - key: DEBUG
        value: "false"

      # --- Render API (optional, secrets) ---
      - key: RENDER_API_KEY
        sync: false
      - key: RENDER_SERVICE_ID
        sync: false
