# =============================================================================
# Tadawul Stock Analysis API - Render Deployment Configuration
# =============================================================================

services:
  - type: web
    name: tadawul-fast-1
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.8"
    
    # =========================================================================
    # Enhanced Build Configuration
    # =========================================================================
    buildCommand: |
      echo "ðŸš€ Building Tadawul Stock Analysis API v2.1.0..."
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt
      echo "âœ… Dependencies installed successfully"
      python -c "
      import sys
      print(f'ðŸ Python {sys.version}')
      try:
          import fastapi, uvicorn, gspread, pandas
          print(f'âœ… FastAPI {fastapi.__version__}')
          print(f'âœ… Uvicorn {uvicorn.__version__}')
          print(f'âœ… gspread {gspread.__version__}')
          print(f'âœ… pandas {pandas.__version__}')
      except ImportError as e:
          print(f'âŒ Import error: {e}')
      "
    
    # =========================================================================
    # Enhanced Start Command
    # =========================================================================
    startCommand: |
      echo "ðŸ”§ Starting Tadawul API with ${UVICORN_WORKERS:-1} worker(s) on port $PORT"
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${UVICORN_WORKERS:-1} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${UVICORN_LOG_LEVEL:-info} \
        --access-log \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30
    
    autoDeploy: true
    
    # =========================================================================
    # Enhanced Health Check Configuration
    # =========================================================================
    healthCheckPath: /health
    healthCheckTimeout: 30
    healthCheckInterval: 60
    initialDelay: 45

    # =========================================================================
    # Environment Variables - Comprehensive Configuration
    # =========================================================================
    envVars:
      # === Core Service Configuration ===
      - key: SERVICE_NAME
        value: "Tadawul Stock Analysis API"
      - key: SERVICE_VERSION
        value: "2.1.0"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # === FastAPI Configuration ===
      - key: FASTAPI_BASE
        value: "https://tadawul-fast-1.onrender.com"
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"
      - key: DOCS_URL
        value: "/docs"
      - key: REDOC_URL
        value: "/redoc"

      # === Authentication & Security ===
      - key: REQUIRE_AUTH
        value: "false"
      - key: ALLOWED_ORIGINS
        value: "*"
      - key: SECRET_KEY
        value: "tadawul-api-secret-key-change-in-production"
      - key: ALGORITHM
        value: "HS256"
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "30"

      # === Performance & Scaling ===
      - key: UVICORN_WORKERS
        value: "1"
      - key: UVICORN_LOG_LEVEL
        value: "info"
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHONPYCACHEPREFIX
        value: "/tmp/pycache"

      # === Cache & Storage Configuration ===
      - key: CACHE_PATH
        value: "./quote_cache.json"
      - key: CACHE_BACKUP_DIR
        value: "./cache_backups"
      - key: CACHE_AUTO_SAVE
        value: "true"
      - key: CACHE_BACKUP_RETENTION_DAYS
        value: "7"
      - key: CACHE_DEFAULT_TTL
        value: "300"

      # === Data Provider Configuration ===
      - key: DATA_PROVIDER
        value: "MULTI_SOURCE"
      - key: PRIMARY_DATA_SOURCE
        value: "GOOGLE_SHEETS"
      - key: SECONDARY_DATA_SOURCE
        value: "ARGAAM"
      - key: FALLBACK_DATA_SOURCE
        value: "MOCK"

      # === Yahoo Finance Configuration ===
      - key: YF_TIMEOUT
        value: "20"
      - key: YF_MAX_RETRIES
        value: "3"
      - key: YF_PERIOD
        value: "3mo"
      - key: YF_INTERVAL
        value: "1d"
      - key: YF_USER_AGENT
        value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

      # === Google Sheets Integration ===
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: SHEETS_SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_SHEETS_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"

      # === Sheet Names Configuration ===
      - key: SHEETS_SYMBOLS_TAB
        value: "Market_Leaders"
      - key: SHEETS_TAB_SYMBOLS
        value: "Market_Leaders"
      - key: SHEETS_DASHBOARD_TAB
        value: "Dashboard"
      - key: SHEETS_ANALYSIS_TAB
        value: "AI_Analysis"
      - key: SHEETS_PRICES_TAB
        value: "Prices"
      - key: SHEETS_FINANCIALS_TAB
        value: "Financials"
      - key: SHEETS_INDICATORS_TAB
        value: "Indicators"
      - key: SHEETS_SECTORS_TAB
        value: "Sectors"
      - key: SHEETS_REPORTS_TAB
        value: "Reports"
      - key: SHEETS_USERS_TAB
        value: "Users"
      - key: SHEETS_SETTINGS_TAB
        value: "Settings"

      # === Sheet Structure Configuration ===
      - key: SHEETS_HEADER_ROW
        value: "3"
      - key: SHEETS_DATA_START_ROW
        value: "4"
      - key: SHEETS_MAX_ROWS
        value: "1000"
      - key: SHEETS_BATCH_SIZE
        value: "100"

      # === Google Apps Script Integration ===
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"
      - key: GOOGLE_APPS_SCRIPT_TIMEOUT
        value: "30"

      # === Argaam Integration ===
      - key: ARGAAM_TIMEOUT
        value: "30"
      - key: ARGAAM_MAX_RETRIES
        value: "3"
      - key: ARGAAM_CACHE_TTL
        value: "600"
      - key: ARGAAM_USER_AGENT
        value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      - key: ARGAAM_BASE_URL
        value: "https://www.argaam.com"

      # === Financial Data API Keys ===
      - key: ALPHA_VANTAGE_API_KEY
        value: "Q0VIE9J6AXUCG99F"
      - key: ALPHA_VANTAGE_BASE_URL
        value: "https://www.alphavantage.co/query"
      - key: ALPHA_VANTAGE_TIMEOUT
        value: "15"

      - key: FINNHUB_API_KEY
        value: "d3uhd8pr01qil4aq3i5gd3uhd8pr01qil4aq3i60"
      - key: FINNHUB_BASE_URL
        value: "https://finnhub.io/api/v1"
      - key: FINNHUB_TIMEOUT
        value: "15"

      - key: EODHD_API_KEY
        value: "68fd1783ee7eb1.12039806"
      - key: EODHD_BASE_URL
        value: "https://eodhistoricaldata.com/api"
      - key: EODHD_TIMEOUT
        value: "15"

      - key: TWELVEDATA_API_KEY
        value: "ca363b090fbb421a84c05882e4f1e393"
      - key: TWELVEDATA_BASE_URL
        value: "https://api.twelvedata.com"
      - key: TWELVEDATA_TIMEOUT
        value: "15"

      - key: MARKETSTACK_API_KEY
        value: "657b972a96392c3cac405ccc48c36b0c"
      - key: MARKETSTACK_BASE_URL
        value: "http://api.marketstack.com/v1"
      - key: MARKETSTACK_TIMEOUT
        value: "15"

      - key: FMP_API_KEY
        value: "3weEgekBXByxCzDGIbXgQ0hgWGZfVKyt"
      - key: FMP_BASE_URL
        value: "https://financialmodelingprep.com/api/v3"
      - key: FMP_TIMEOUT
        value: "15"

      # === Feature Flags ===
      - key: ENABLE_ARGAAM_INTEGRATION
        value: "true"
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      - key: ENABLE_AI_ANALYSIS
        value: "true"
      - key: ENABLE_MARKET_DASHBOARD
        value: "true"
      - key: ENABLE_SYMBOLS_READER
        value: "true"
      - key: ENABLE_MULTI_SOURCE_DATA
        value: "true"
      - key: ENABLE_GOOGLE_APPS_SCRIPT
        value: "true"
      - key: ENABLE_CACHE_MANAGEMENT
        value: "true"
      - key: ENABLE_HEALTH_CHECKS
        value: "true"
      - key: ENABLE_BACKGROUND_TASKS
        value: "true"
      - key: ENABLE_SHEET_VERIFICATION
        value: "true"

      # === Market Data Settings ===
      - key: DEFAULT_MARKET
        value: "SAUDI"
      - key: DEFAULT_CURRENCY
        value: "SAR"
      - key: MARKET_OPEN_TIME
        value: "10:00"
      - key: MARKET_CLOSE_TIME
        value: "15:00"
      - key: MARKET_TIMEZONE
        value: "Asia/Riyadh"
      - key: MARKET_DAYS
        value: "Sunday,Monday,Tuesday,Wednesday,Thursday"
      - key: SUPPORTED_MARKETS
        value: "SAUDI,UAE,QATAR,BAHRAIN,OMAN,KUWAIT"

      # === Timezone & Scheduling ===
      - key: TZ
        value: "Asia/Riyadh"
      - key: TRADING_INTERVAL_MINUTES
        value: "5"

      # === Logging Configuration ===
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_FILE
        value: "./logs/application.log"
      - key: LOG_MAX_SIZE_MB
        value: "10"
      - key: LOG_BACKUP_COUNT
        value: "5"
      - key: LOG_FORMAT
        value: "json"
      - key: LOG_ENABLE_CONSOLE
        value: "true"
      - key: LOG_ENABLE_FILE
        value: "false"

      # === Request Rate Limiting ===
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "100"
      - key: RATE_LIMIT_MAX_SYMBOLS_PER_REQUEST
        value: "50"
      - key: RATE_LIMIT_API_CALLS_PER_MINUTE
        value: "200"
      - key: RATE_LIMIT_ENABLED
        value: "true"

      # === Multi-Source Data Fusion ===
      - key: DATA_SOURCE_PRIORITY
        value: "ALPHA_VANTAGE,FINNHUB,TWELVEDATA,MARKETSTACK,YF,ARGAAM"
      - key: PRICE_CONSENSUS_THRESHOLD
        value: "0.8"
      - key: MIN_DATA_SOURCES
        value: "2"
      - key: DATA_VALIDATION_ENABLED
        value: "true"
      - key: DATA_FRESHNESS_THRESHOLD
        value: "300"

      # === Monitoring & Health Checks ===
      - key: HEALTH_CHECK_INTERVAL
        value: "300"
      - key: METRICS_ENABLED
        value: "true"
      - key: API_STATUS_CHECK_INTERVAL
        value: "3600"
      - key: PERFORMANCE_MONITORING
        value: "true"
      - key: HEALTH_CHECK_TIMEOUT
        value: "30"

      # === Backup & Recovery ===
      - key: AUTO_BACKUP_ENABLED
        value: "true"
      - key: AUTO_BACKUP_INTERVAL_HOURS
        value: "24"
      - key: BACKUP_RETENTION_DAYS
        value: "30"
      - key: BACKUP_MAX_FILES
        value: "10"
      - key: ENABLE_AUTO_RESTORE
        value: "true"

      # === Security & Rate Limits ===
      - key: MAX_REQUEST_SIZE_MB
        value: "10"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: TRUSTED_PROXIES
        value: "*"
      - key: ENABLE_CORS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
      - key: ENABLE_HTTPS_REDIRECT
        value: "true"
      - key: TRUSTED_HOSTS
        value: "*"

      # === Performance Optimization ===
      - key: ENABLE_COMPRESSION
        value: "true"
      - key: ENABLE_CACHING_HEADERS
        value: "true"
      - key: STATIC_FILES_CACHE
        value: "3600"
      - key: API_RESPONSE_CACHE
        value: "60"
      - key: ENABLE_GZIP
        value: "true"

      # === Error Handling ===
      - key: ENABLE_DETAILED_ERRORS
        value: "true"
      - key: LOG_ERROR_STACKTRACES
        value: "true"
      - key: ERROR_REPORTING_ENABLED
        value: "true"
      - key: MAX_ERROR_REPORTS_PER_HOUR
        value: "10"

    # =========================================================================
    # Secrets Configuration (Set in Render Dashboard)
    # =========================================================================
    secrets:
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json
      - key: ALERT_EMAIL
        fromSecret: alert-email
      - key: SMTP_PASSWORD
        fromSecret: smtp-password

    # =========================================================================
    # Enhanced Previews Configuration
    # =========================================================================
    previews:
      enabled: true
      plan: free
      autodeploy: true
      buildFilter:
        paths:
          - "*.py"
          - "requirements.txt"
          - "render.yaml"
          - "Procfile"
          - "*.json"
          - "*.html"
      envVars:
        - key: ENVIRONMENT
          value: preview
        - key: ENABLE_SWAGGER
          value: "true"
        - key: ENABLE_REDOC
          value: "true"
        - key: LOG_LEVEL
          value: "DEBUG"

    # =========================================================================
    # Build Filter Configuration
    # =========================================================================
    buildFilter:
      paths:
        - "*.py"
        - "requirements.txt"
        - "render.yaml"
        - "Procfile"
        - "*.json"
        - "*.html"
        - "*.yaml"
        - "*.yml"
      ignoredPaths:
        - "tests/*"
        - "*.log"
        - "cache_backups/*"
        - "*.tmp"

    # =========================================================================
    # Disk Configuration for Cache Persistence
    # =========================================================================
    disk:
      name: tadawul-cache-data
      mountPath: /opt/render/cache
      sizeGB: 1

    # =========================================================================
    # Enhanced Headers for Security & Performance
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/*"
        name: "Strict-Transport-Security"
        value: "max-age=31536000; includeSubDomains"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
      - path: "/api/*"
        name: "Cache-Control"
        value: "public, max-age=60"
      - path: "/static/*"
        name: "Cache-Control"
        value: "public, max-age=3600"

    # =========================================================================
    # Advanced Health Check Configuration
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 45
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"

    # =========================================================================
    # Resource Scaling (Future Enhancement)
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70

    # =========================================================================
    # Deployment Hooks (Future Enhancement)
    # =========================================================================
    # deployHooks:
    #   - name: Run Migrations
    #     command: |
    #       echo "Running database migrations..."
    #       python -m alembic upgrade head
    #   - name: Cache Warmup
    #     command: |
    #       echo "Warming up cache..."
    #       curl -s https://${RENDER_SERVICE_NAME}.onrender.com/health > /dev/null

# =============================================================================
# Database Service (Future Enhancement)
# =============================================================================
# databases:
#   - name: tadawul-db
#     plan: free
#     databaseName: tadawul
#     user: tadawul_user

# =============================================================================
# Cron Jobs (Future Enhancement)
# =============================================================================
# jobs:
#   - name: daily-backup
#     plan: free
#     schedule: "0 2 * * *"  # 2 AM daily
#     command: |
#       curl -X POST https://${RENDER_SERVICE_NAME}.onrender.com/v1/cache/backup
#   - name: health-check
#     plan: free
#     schedule: "*/15 * * * *"  # Every 15 minutes
#     command: |
#       curl -f https://${RENDER_SERVICE_NAME}.onrender.com/health || exit 1
