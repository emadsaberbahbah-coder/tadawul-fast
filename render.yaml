# =============================================================================
# render.yaml
# =============================================================================
# TADAWUL FAST BRIDGE – RENDER BLUEPRINT (v7.5.0) — VALIDATED STRUCTURE
# Notes:
# - Uses Render Blueprint spec fields only (root + services + envVarGroups)
# - Cron jobs are defined as services with type: cron (no root-level cronJobs)
# - Key Value (Redis-compatible) uses type: keyvalue and ipAllowList: [] (internal-only)
# - Autoscaling uses supported fields only (min/max + targetCPU/Memory)
# - Security headers should be set in FastAPI middleware (Blueprint headers apply to static sites)
# =============================================================================

# Preview environments (multi-service). Optional.
previews:
  generation: automatic
  expireAfterDays: 7

services:
  # -------------------------------------------------------------------------
  # 1) Primary FastAPI Application (Web Service)
  # -------------------------------------------------------------------------
  - type: web
    name: tadawul-fast-bridge
    runtime: python
    region: frankfurt
    plan: pro
    branch: main

    # Zero-downtime health check endpoint
    healthCheckPath: /readyz

    # Auto deploys (replaces deprecated autoDeploy: true)
    autoDeployTrigger: commit

    # Pull request previews for this service (replaces pullRequestPreviewsEnabled)
    previews:
      generation: automatic
      plan: starter
      numInstances: 1

    buildFilter:
      paths:
        - main.py
        - core/**
        - routes/**
        - schemas/**
        - scripts/**
        - integrations/**
        - requirements.txt
        - runtime.txt
        - render.yaml
      ignoredPaths:
        - tests/**
        - docs/**
        - examples/**
        - .github/**
        - .vscode/**
        - .gitignore
        - README.md

    buildCommand: |
      set -euo pipefail

      # 1) Install uv (Astral) for fast dependency resolution
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"

      # 2) Install dependencies
      uv pip install --system --no-cache -r requirements.txt

      # 3) Optional performance/observability packages (safe if already pinned)
      uv pip install --system --no-cache uvloop httptools orjson opentelemetry-api opentelemetry-sdk prometheus-client

      # 4) Compile Python bytecode for faster cold start
      python -m compileall -q -f -x "(tests|examples|docs|venv|\.git|__pycache__)" .

      echo "✅ Build completed"

    startCommand: |
      set -euo pipefail
      chmod +x scripts/start_web.sh
      exec scripts/start_web.sh

    # Autoscaling (supported fields only)
    scaling:
      minInstances: 2
      maxInstances: 10
      targetMemoryPercent: 80
      targetCPUPercent: 75

    # Custom domains
    domains:
      - api.tadawulfb.com
      - api.tadawulfastbridge.com

    # Environment groups applied to this service
    envVars:
      - fromGroup: tfb-core
      - fromGroup: tfb-logging
      - fromGroup: tfb-server
      - fromGroup: tfb-security
      - fromGroup: tfb-features
      - fromGroup: tfb-providers
      - fromGroup: tfb-cache
      - fromGroup: tfb-sheets
      - fromGroup: tfb-resources

  # -------------------------------------------------------------------------
  # 2) Background Worker Service
  # -------------------------------------------------------------------------
  - type: worker
    name: tadawul-worker
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    autoDeployTrigger: commit

    buildFilter:
      paths:
        - main.py
        - core/**
        - routes/**
        - schemas/**
        - scripts/**
        - integrations/**
        - requirements.txt
        - runtime.txt
        - render.yaml
      ignoredPaths:
        - tests/**
        - docs/**
        - examples/**
        - .github/**
        - .vscode/**
        - .gitignore
        - README.md

    buildCommand: |
      set -euo pipefail
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      uv pip install --system --no-cache -r requirements.txt
      python -m compileall -q main.py core scripts

    startCommand: |
      set -euo pipefail
      python scripts/worker.py

    envVars:
      - fromGroup: tfb-core
      - fromGroup: tfb-logging
      - fromGroup: tfb-security
      - fromGroup: tfb-features
      - fromGroup: tfb-providers
      - fromGroup: tfb-cache
      - fromGroup: tfb-resources

  # -------------------------------------------------------------------------
  # 3) Redis-Compatible Cache (Render Key Value)
  # -------------------------------------------------------------------------
  - type: keyvalue
    name: tadawul-redis
    region: frankfurt
    plan: starter

    # Required for Key Value. Empty list => internal-only (no public internet access)
    ipAllowList: []

    maxmemoryPolicy: allkeys-lru

  # -------------------------------------------------------------------------
  # 4) Documentation Static Site
  # -------------------------------------------------------------------------
  - type: web
    name: tadawul-docs
    runtime: static
    region: frankfurt
    plan: free
    branch: main
    autoDeployTrigger: commit

    buildCommand: |
      set -euo pipefail
      mkdir -p public
      cp -r docs/* public/ || true
      echo "Tadawul Fast Bridge v7.5.0 Documentation" > public/index.html

    staticPublishPath: public

    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600

  # -------------------------------------------------------------------------
  # 5) Cron Jobs (defined as services with type: cron)
  # -------------------------------------------------------------------------
  - type: cron
    name: cache-cleanup
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    schedule: "0 3 * * *"

    buildCommand: |
      set -euo pipefail
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      uv pip install --system --no-cache -r requirements.txt

    startCommand: python scripts/cleanup_cache.py

    envVars:
      - fromGroup: tfb-core
      - fromGroup: tfb-logging
      - fromGroup: tfb-cache
      - fromGroup: tfb-resources

  - type: cron
    name: model-drift-check
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    schedule: "0 4 * * 0"

    buildCommand: |
      set -euo pipefail
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      uv pip install --system --no-cache -r requirements.txt

    startCommand: python scripts/drift_detection.py

    envVars:
      - fromGroup: tfb-core
      - fromGroup: tfb-logging
      - fromGroup: tfb-features
      - fromGroup: tfb-resources

  - type: cron
    name: refresh-provider-data
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    schedule: "*/30 * * * *"

    buildCommand: |
      set -euo pipefail
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      uv pip install --system --no-cache -r requirements.txt

    startCommand: python scripts/refresh_data.py

    envVars:
      - fromGroup: tfb-core
      - fromGroup: tfb-logging
      - fromGroup: tfb-providers
      - fromGroup: tfb-cache
      - fromGroup: tfb-resources

# =============================================================================
# ENVIRONMENT VARIABLE GROUPS
# =============================================================================
envVarGroups:
  # =======================================================================
  # CORE RUNTIME CONFIGURATION
  # =======================================================================
  - name: tfb-core
    envVars:
      - key: TZ
        value: "Asia/Riyadh"
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: APP_VERSION
        value: "7.5.0"
      - key: SERVICE_VERSION
        value: "7.5.0"
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONDONTWRITEBYTECODE
        value: "1"
      - key: PYTHONHASHSEED
        value: "random"

  # =======================================================================
  # LOGGING & OBSERVABILITY
  # =======================================================================
  - name: tfb-logging
    envVars:
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_JSON
        value: "1"
      - key: UVICORN_ACCESS_LOG
        value: "1"
      - key: ENABLE_TRACING
        value: "1"
      - key: CORE_TRACING_ENABLED
        value: "1"
      - key: DATA_ENGINE_PERF_MONITORING
        value: "1"

  # =======================================================================
  # WEB SERVER CONFIGURATION (app reads these; Render provides PORT automatically)
  # =======================================================================
  - name: tfb-server
    envVars:
      - key: HOST
        value: "0.0.0.0"
      - key: WORKERS
        value: "4"
      - key: WEB_CONCURRENCY_MAX
        value: "16"
      - key: WORKER_CLASS
        value: "uvicorn.workers.UvicornWorker"
      - key: WORKER_CONNECTIONS
        value: "2048"
      - key: WORKER_MAX_REQUESTS
        value: "10000"
      - key: TIMEOUT_KEEP_ALIVE
        value: "65"
      - key: TIMEOUT_GRACEFUL
        value: "30"
      - key: BACKLOG
        value: "4096"

  # =======================================================================
  # SECURITY & AUTHENTICATION
  # =======================================================================
  - name: tfb-security
    envVars:
      - key: REQUIRE_AUTH
        value: "1"
      - key: AUTH_HEADER_NAME
        value: "X-APP-TOKEN"
      - key: RATE_LIMIT_ENABLED
        value: "1"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"
      - key: RATE_LIMIT_BACKEND
        value: "redis"
      - key: CORS_ORIGINS
        value: "https://app.tadawulfb.com,https://tadawulfb.com"
      - key: ALLOWED_HOSTS
        value: "api.tadawulfb.com,api.tadawulfastbridge.com,localhost"
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

  # =======================================================================
  # FEATURE FLAGS & MACHINE LEARNING
  # =======================================================================
  - name: tfb-features
    envVars:
      - key: ADVISOR_ENABLED
        value: "1"
      - key: AI_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ADAPTIVE_CONCURRENCY
        value: "1"
      - key: CACHE_ENABLED
        value: "1"
      - key: CACHE_COMPRESSION
        value: "1"
      - key: CACHE_COMPRESSION_LEVEL
        value: "6"
      - key: CIRCUIT_BREAKER_ENABLED
        value: "1"

  # =======================================================================
  # DATA PROVIDERS
  # =======================================================================
  - name: tfb-providers
    envVars:
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub,yahoo_chart,yahoo_fundamentals"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam,tadawul"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ARGAAM_API_KEY
        sync: false

  # =======================================================================
  # CACHE CONFIGURATION
  # =======================================================================
  - name: tfb-cache
    envVars:
      - key: CACHE_BACKEND
        value: "redis"
      - key: CACHE_TTL_SEC
        value: "300"
      - key: CACHE_MAX_SIZE
        value: "20000"
      - key: REDIS_URL
        fromService:
          name: tadawul-redis
          type: keyvalue
          property: connectionString

  # =======================================================================
  # GOOGLE SHEETS INTEGRATION
  # =======================================================================
  - name: tfb-sheets
    envVars:
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: SHEETS_SAFE_MODE
        value: "strict"
      - key: SHEETS_USE_BATCH_UPDATE
        value: "true"

  # =======================================================================
  # RESOURCE MANAGEMENT (System Guardian)
  # =======================================================================
  - name: tfb-resources
    envVars:
      - key: GC_PRESSURE_MB
        value: "512"
      - key: DEGRADED_ENTER_LAG_MS
        value: "500"
      - key: DEGRADED_SHED_ENABLED
        value: "1"
      - key: MAX_FD_LIMIT
        value: "65536"
