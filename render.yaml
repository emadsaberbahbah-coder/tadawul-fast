# ============================================================
# render.yaml — Tadawul Fast Bridge (FastAPI) — Render Blueprint
# UPDATED: production-safe defaults (KSA-safe, Yahoo-safe)
# ============================================================
#
# Notes
# - Python version comes from runtime.txt
# - Keep WEB_CONCURRENCY=1 on free plan
# - KSA (.SR / numeric) must NOT rely on EODHD/Yahoo
# - Yahoo/yfinance is often blocked (401). Default OFF in production.
#

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    autoDeploy: true

    buildCommand: >
      pip install --upgrade pip &&
      pip install -r requirements.txt

    startCommand: >
      uvicorn main:app
      --host 0.0.0.0
      --port $PORT
      --proxy-headers
      --forwarded-allow-ips="*"
      --timeout-keep-alive ${UVICORN_KEEPALIVE:-75}
      --log-level ${LOG_LEVEL:-info}
      --workers ${WEB_CONCURRENCY:-1}

    healthCheckPath: /health

    envVars:
      # -------------------------
      # Runtime
      # -------------------------
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: UVICORN_KEEPALIVE
        value: "75"
      - key: LOG_LEVEL
        value: "info"

      # -------------------------
      # App identity
      # -------------------------
      - key: APP_NAME
        value: Tadawul Fast Bridge
      - key: APP_VERSION
        value: "4.6.0"
      - key: APP_ENV
        value: production
      - key: BACKEND_BASE_URL
        value: https://tadawul-fast-bridge.onrender.com

      # -------------------------
      # Security tokens (SECRETS)
      # -------------------------
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

      # -------------------------
      # Providers policy
      # -------------------------
      # Global providers (order matters in your app logic if you use it)
      # Recommended: Finnhub + FMP (EODHD optional)
      - key: ENABLED_PROVIDERS
        value: "finnhub,fmp,eodhd"
      - key: PRIMARY_PROVIDER
        value: "finnhub"

      # KSA routing flags (your code should enforce KSA-safe providers)
      - key: KSA_PROVIDERS
        value: "tadawul,argaam"
      - key: KSA_DISALLOW_EODHD
        value: "true"

      # Yahoo/yfinance often blocked (401). Keep OFF by default in production.
      # Turn ON only if you confirm it works in your region/environment.
      - key: ENABLE_YFINANCE
        value: "false"

      # Provider keys (SECRETS)
      - key: FMP_API_KEY
        sync: false
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false

      # -------------------------
      # Argaam (KSA)
      # -------------------------
      # ARGAAM_GATEWAY_URL is optional (if you ever add your own gateway)
      - key: ARGAAM_GATEWAY_URL
        value: ""
      - key: ARGAAM_API_KEY
        sync: false

      # Enable detail parsing (company overview page) to complete OHLC/prev close/etc.
      - key: ARGAAM_DETAIL_ENABLED
        value: "true"

      # -------------------------
      # HTTP + caching
      # -------------------------
      - key: HTTP_TIMEOUT_SEC
        value: "25"
      - key: CACHE_TTL_SEC
        value: "20"
      - key: QUOTE_TTL_SEC
        value: "30"
      - key: FUNDAMENTALS_TTL_SEC
        value: "21600"
      - key: ARGAAM_SNAPSHOT_TTL_SEC
        value: "30"
      - key: ARGAAM_DETAIL_TTL_SEC
        value: "20"

      # -------------------------
      # Batch controls
      # -------------------------
      - key: ENRICHED_BATCH_SIZE
        value: "40"
      - key: ENRICHED_BATCH_TIMEOUT_SEC
        value: "45"
      - key: ENRICHED_MAX_TICKERS
        value: "250"
      - key: ENRICHED_BATCH_CONCURRENCY
        value: "5"

      - key: AI_BATCH_SIZE
        value: "20"
      - key: AI_BATCH_TIMEOUT_SEC
        value: "45"
      - key: AI_MAX_TICKERS
        value: "500"
      - key: AI_BATCH_CONCURRENCY
        value: "5"

      - key: ADV_BATCH_SIZE
        value: "25"
      - key: ADV_BATCH_TIMEOUT_SEC
        value: "45"
      - key: ADV_MAX_TICKERS
        value: "500"
      - key: ADV_BATCH_CONCURRENCY
        value: "6"

      # -------------------------
      # Google Sheets integration (SECRETS)
      # -------------------------
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false

      # Sheets client tuning (google_sheets_service.py)
      - key: SHEETS_BACKEND_TIMEOUT_SEC
        value: "120"
      - key: SHEETS_BACKEND_RETRIES
        value: "2"
      - key: SHEETS_BACKEND_RETRY_SLEEP
        value: "1.0"
      - key: SHEETS_API_RETRIES
        value: "3"
      - key: SHEETS_API_RETRY_BASE_SLEEP
        value: "1.0"
      - key: SHEETS_MAX_ROWS_PER_WRITE
        value: "500"

      # -------------------------
      # CORS
      # -------------------------
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"

      # -------------------------
      # Sheet names (align with GAS)
      # -------------------------
      - key: SHEET_KSA_TADAWUL
        value: KSA_Tadawul_Market
      - key: SHEET_GLOBAL_MARKETS
        value: Global_Markets
      - key: SHEET_MUTUAL_FUNDS
        value: Mutual_Funds
      - key: SHEET_COMMODITIES_FX
        value: Commodities_FX
      - key: SHEET_MARKET_LEADERS
        value: Market_Leaders
      - key: SHEET_MY_PORTFOLIO
        value: My_Portfolio
      - key: SHEET_INSIGHTS_ANALYSIS
        value: Insights_Analysis
      - key: SHEET_INVESTMENT_ADVISOR
        value: Investment_Advisor
      - key: SHEET_ECONOMIC_CALENDAR
        value: Economic_Calendar
      - key: SHEET_INVESTMENT_INCOME
        value: Investment_Income_Statement
