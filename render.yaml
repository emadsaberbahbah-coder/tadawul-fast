# render.yaml
# ============================================================
# Tadawul Fast Bridge (FastAPI) — Render Blueprint
# EDITION: Advanced Production (v1.6.2) — Render/Free-Safe
# ============================================================
#
# Key Enhancements (v1.6.2)
# - Booleans use "0"/"1" to avoid string parsing ambiguity (fixes DEFER_ROUTER_MOUNT confusion).
# - Aligns APP/SERVICE version to 6.6.1 (matches your runtime log).
# - WEB_CONCURRENCY set to "1" to match your current start_web.sh clamp1() logic.
# - Keeps compileall limited to app folders (avoids tests causing build failure).
#
# NOTE:
# - Render Dashboard env vars override this file. If you see DEFER_ROUTER_MOUNT=1 in logs,
#   you must remove/override it in Render Dashboard.

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: frankfurt
    autoDeploy: true

    # ----------------------------
    # Build
    # ----------------------------
    buildCommand: |
      python -m pip install --upgrade pip
      python -m pip install -r requirements.txt
      # Compile ONLY app code (skip tests to avoid build failure)
      python -m compileall -q main.py core routes scripts
      echo "COMPILEALL_OK"

    # ----------------------------
    # Start (delegates to hardened launcher)
    # ----------------------------
    startCommand: sh scripts/start_web.sh

    # ----------------------------
    # Health Check
    # ----------------------------
    healthCheckPath: /readyz
    healthCheckTimeout: 60

    # ----------------------------
    # Environment Variables
    # ----------------------------
    envVars:
      # --- Runtime Core ---
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHON_VERSION
        value: "3.11.9"
      - key: TZ
        value: "Asia/Riyadh"
      - key: TIMEZONE_DEFAULT
        value: "Asia/Riyadh"

      # --- Identity / Environment ---
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge"
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_VERSION
        value: "6.6.1"
      - key: SERVICE_VERSION
        value: "6.6.1"

      # --- Logging ---
      - key: LOG_LEVEL
        value: "info"
      - key: LOG_JSON
        value: "0"
      # Only set LOG_FORMAT if it is a real python logging %-format string
      # - key: LOG_FORMAT
      #   value: "%(asctime)s | %(levelname)s | [%(request_id)s] %(name)s | %(message)s"

      # --- Docs / UI ---
      - key: ENABLE_SWAGGER
        value: "1"
      - key: ENABLE_REDOC
        value: "1"

      # --- Fast Boot / Mounting ---
      # Use numeric flags to avoid ambiguity (and to match log behavior)
      - key: INIT_ENGINE_ON_BOOT
        value: "1"
      - key: DEFER_ROUTER_MOUNT
        value: "0"

      # --- Server Tuning (start_web.sh reads these) ---
      # IMPORTANT: Your current start_web.sh clamps WEB_CONCURRENCY to >= 1
      - key: WEB_CONCURRENCY
        value: "1"
      - key: WEB_CONCURRENCY_MAX
        value: "4"
      - key: UVICORN_KEEPALIVE
        value: "120"
      - key: UVICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: UVICORN_ACCESS_LOG
        value: "1"
      # 0 => treated as "not set" by your launcher helper (pos_int_or_empty)
      - key: UVICORN_LIMIT_CONCURRENCY
        value: "0"
      - key: UVICORN_LIMIT_MAX_REQUESTS
        value: "0"
      - key: UVICORN_ROOT_PATH
        value: ""
      - key: UVICORN_BACKLOG
        value: "2048"

      # --- Security / Auth ---
      - key: REQUIRE_AUTH
        value: "1"
      - key: AUTH_HEADER_NAME
        value: "X-APP-TOKEN"
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

      # --- Features ---
      - key: ADVISOR_ENABLED
        value: "1"
      - key: AI_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "1"
      - key: ENABLE_RATE_LIMITING
        value: "1"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"

      # --- Providers / Routing ---
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam,tadawul"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      - key: KSA_DISALLOW_EODHD
        value: "1"
      - key: ENABLE_YAHOO_CHART_KSA
        value: "1"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "1"
      - key: ENABLE_YFINANCE_KSA
        value: "1"
      - key: ENABLE_YAHOO_FUNDAMENTALS_KSA
        value: "1"

      # --- Provider API Keys (Secrets in Dashboard) ---
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ARGAAM_API_KEY
        sync: false
      - key: FMP_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: TWELVEDATA_API_KEY
        sync: false
      - key: MARKETSTACK_API_KEY
        sync: false

      # --- Provider Endpoint Overrides (optional / secrets if needed) ---
      - key: EODHD_BASE_URL
        sync: false
      - key: FMP_BASE_URL
        sync: false
      - key: ARGAAM_QUOTE_URL
        sync: false
      - key: ARGAAM_PROFILE_URL
        sync: false
      - key: TADAWUL_QUOTE_URL
        sync: false
      - key: TADAWUL_FUNDAMENTALS_URL
        sync: false

      - key: TADAWUL_MARKET_ENABLED
        value: "1"
      - key: TADAWUL_MAX_SYMBOLS
        value: "2500"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "120"

      # --- Google Sheets Integration (Secrets in Dashboard) ---
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_APPS_SCRIPT_URL
        sync: false
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        sync: false

      # --- Sheets Safety ---
      - key: SHEETS_SAFE_MODE
        value: "1"
      - key: SHEETS_BLOCK_ON_EMPTY_ROWS
        value: "0"

      # --- Batch / Performance Controls ---
      - key: HTTP_TIMEOUT_SEC
        value: "45"
      - key: HTTP_TIMEOUT
        value: "45"
      - key: AI_BATCH_SIZE
        value: "25"
      - key: AI_MAX_TICKERS
        value: "800"
      - key: AI_BATCH_CONCURRENCY
        value: "8"
      - key: ADV_BATCH_SIZE
        value: "25"
      - key: BATCH_CONCURRENCY
        value: "8"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.5"

      # --- Cache Controls ---
      - key: CACHE_DEFAULT_TTL
        value: "20"
      - key: CACHE_MAX_SIZE
        value: "5000"
      - key: CACHE_SAVE_INTERVAL
        value: "60"
      - key: CACHE_BACKUP_ENABLED
        value: "1"

      # --- CORS ---
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "1"
      - key: CORS_ALL_ORIGINS
        value: "1"
      - key: CORS_ORIGINS
        value: "*"

      # --- Debug / Diagnostics ---
      - key: DEBUG
        value: "0"
      - key: DEBUG_ERRORS
        value: "0"

      # --- Render API (optional, secrets) ---
      - key: RENDER_API_KEY
        sync: false
      - key: RENDER_SERVICE_ID
        sync: false
