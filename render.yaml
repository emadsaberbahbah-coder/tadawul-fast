# ============================================================
# render.yaml — Tadawul Fast Bridge (FastAPI) — Render Blueprint
# PROD-SAFE + Backward-Compatible env var names (v1.1.0)
# ============================================================
#
# Key fixes vs your draft:
# - Adds SAFE KSA toggles that match your engine defaults:
#     ENABLE_YAHOO_CHART_KSA=true
#     ENABLE_YAHOO_CHART_SUPPLEMENT=true
#     ENABLE_YFINANCE_KSA=false
# - Adds missing compatibility envs your code may read:
#     HTTP_TIMEOUT (in addition to HTTP_TIMEOUT_SEC)
#     CACHE_DEFAULT_TTL (in addition to CACHE_TTL_SEC)
#     ENABLE_RATE_LIMITING / MAX_REQUESTS_PER_MINUTE
# - Aligns batch env name for /v1/enriched/quotes:
#     ENRICHED_BATCH_CONCURRENCY (in addition to ENRICHED_CONCURRENCY)
# - Adds DEFER_ROUTER_MOUNT / INIT_ENGINE_ON_BOOT explicit defaults.
#

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    autoDeploy: true

    buildCommand: pip install -r requirements.txt

    # Render-friendly deterministic startup:
    # - lowercases LOG_LEVEL for uvicorn
    # - only adds --workers if WEB_CONCURRENCY > 1
    startCommand: >
      sh -c 'LOG_LEVEL_LC="$(echo "${LOG_LEVEL:-info}" | tr "[:upper:]" "[:lower:]")";
      if [ "${WEB_CONCURRENCY:-1}" -gt 1 ]; then WORKERS="--workers ${WEB_CONCURRENCY}"; else WORKERS=""; fi;
      exec uvicorn main:app
      --host 0.0.0.0
      --port "${PORT:-8000}"
      --proxy-headers
      --forwarded-allow-ips "*"
      --lifespan on
      --timeout-keep-alive "${UVICORN_KEEPALIVE:-75}"
      --log-level "$LOG_LEVEL_LC"
      $WORKERS
      --no-server-header'

    healthCheckPath: /healthz

    envVars:
      # -------------------------
      # Runtime
      # -------------------------
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: TZ
        value: "Asia/Riyadh"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: UVICORN_KEEPALIVE
        value: "75"
      - key: LOG_LEVEL
        value: "info"
      - key: LOG_JSON
        value: "false"
      - key: DEBUG
        value: "false"

      # Fast-boot controls (match main.py defaults but explicit here)
      - key: DEFER_ROUTER_MOUNT
        value: "true"
      - key: INIT_ENGINE_ON_BOOT
        value: "true"

      # -------------------------
      # App identity (compat keys)
      # -------------------------
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"

      # Version (compat keys)
      - key: APP_VERSION
        value: "5.0.0"
      - key: SERVICE_VERSION
        value: "5.0.0"
      - key: VERSION
        value: "5.0.0"

      # Public base url of this service
      - key: BACKEND_BASE_URL
        value: "https://tadawul-fast-bridge.onrender.com"

      # -------------------------
      # Security tokens (SECRETS)
      # -------------------------
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false
      - key: REQUIRE_AUTH
        value: "false"

      # -------------------------
      # Providers policy
      # -------------------------
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: PRIMARY_PROVIDER
        value: "finnhub"

      # KSA routing order
      - key: KSA_PROVIDERS
        value: "tadawul,argaam,yahoo_chart"

      # Hard safety: never use EODHD for KSA
      - key: KSA_DISALLOW_EODHD
        value: "true"

      # Yahoo Chart fallbacks (KSA-safe)
      - key: ENABLE_YAHOO_CHART_KSA
        value: "true"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "true"

      # yfinance policy
      - key: ENABLE_YFINANCE
        value: "true"       # global fallback if your engine uses it
      - key: ENABLE_YFINANCE_KSA
        value: "false"      # IMPORTANT: keep KSA yfinance OFF unless you explicitly want it

      # Provider keys (SECRETS) — keep Render names (config.py exports aliases)
      - key: FMP_API_KEY
        sync: false
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false

      # Argaam (optional)
      - key: ARGAAM_GATEWAY_URL
        value: ""
      - key: ARGAAM_API_KEY
        sync: false

      # -------------------------
      # HTTP + caching (set BOTH styles for compatibility)
      # -------------------------
      - key: HTTP_TIMEOUT_SEC
        value: "25"
      - key: HTTP_TIMEOUT
        value: "25"

      - key: CACHE_TTL_SEC
        value: "20"
      - key: CACHE_DEFAULT_TTL
        value: "20"

      - key: QUOTE_TTL_SEC
        value: "30"
      - key: FUNDAMENTALS_TTL_SEC
        value: "21600"
      - key: ARGAAM_SNAPSHOT_TTL_SEC
        value: "30"

      # -------------------------
      # Rate limiting (SlowAPI)
      # -------------------------
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "240"

      # -------------------------
      # Batch controls (set BOTH names where code differs)
      # -------------------------
      - key: ENRICHED_BATCH_SIZE
        value: "40"
      - key: ENRICHED_MAX_TICKERS
        value: "250"
      - key: ENRICHED_BATCH_CONCURRENCY
        value: "5"
      - key: ENRICHED_CONCURRENCY
        value: "5"
      - key: ENRICHED_TIMEOUT_SEC
        value: "45"

      - key: AI_BATCH_SIZE
        value: "20"
      - key: AI_MAX_TICKERS
        value: "500"
      - key: AI_CONCURRENCY
        value: "5"
      - key: AI_TIMEOUT_SEC
        value: "45"

      - key: ADV_BATCH_SIZE
        value: "25"
      - key: ADV_MAX_TICKERS
        value: "500"
      - key: ADV_CONCURRENCY
        value: "6"
      - key: ADV_TIMEOUT_SEC
        value: "45"

      # -------------------------
      # Google Sheets integration (SECRETS)
      # -------------------------
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false

      # -------------------------
      # CORS
      # -------------------------
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
