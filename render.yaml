# render.yaml  — FULL REPLACEMENT
# ============================================================
# Tadawul Fast Bridge (FastAPI) — Render Blueprint
# PROD-SAFE + Backward-Compatible env var names (v1.1.4)
# ============================================================
#
# v1.1.4 changes vs v1.1.3
# - ✅ Fix: startCommand quoting/argv building hardened (less shell edge-cases)
# - ✅ Fix: WEB_CONCURRENCY parsing fully numeric-safe + clamps to >=1
# - ✅ Add: UVICORN_GRACEFUL_TIMEOUT + UVICORN_TIMEOUT (optional)
# - ✅ Keep: Option A KSA_PROVIDERS=yahoo_chart (quiet + stable KSA)
# - ✅ Keep: full env compat (both *_SEC and legacy aliases)
#
# NOTE:
# - If you rename the service, update BACKEND_BASE_URL/TFB_BASE_URL (or set in Render dashboard).
# - Secrets must be set in Render Environment UI or via `sync: false` placeholders below.

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    autoDeploy: true

    buildCommand: pip install -r requirements.txt

    # Deterministic + safe startup (no "integer expression" crash)
    startCommand: >
      sh -c '
      set -eu;

      LOG_LEVEL_LC="$(printf "%s" "${LOG_LEVEL:-info}" | tr "[:upper:]" "[:lower:]")";
      PORT_VAL="${PORT:-8000}";
      KEEPALIVE_VAL="${UVICORN_KEEPALIVE:-75}";
      GRACE_VAL="${UVICORN_GRACEFUL_TIMEOUT:-30}";
      TIMEOUT_VAL="${UVICORN_TIMEOUT:-0}";

      # WEB_CONCURRENCY numeric-safe (default 1). Clamp to >=1.
      CONC_RAW="${WEB_CONCURRENCY:-1}";
      case "$CONC_RAW" in
        (""|*[!0-9]*) CONC="1" ;;
        (*)           CONC="$CONC_RAW" ;;
      esac;
      if [ "$CONC" -lt 1 ]; then CONC="1"; fi;

      # Build argv deterministically
      set -- uvicorn main:app \
        --host 0.0.0.0 \
        --port "$PORT_VAL" \
        --proxy-headers \
        --forwarded-allow-ips "*" \
        --lifespan on \
        --timeout-keep-alive "$KEEPALIVE_VAL" \
        --log-level "$LOG_LEVEL_LC" \
        --no-server-header;

      # Optional: request timeout (0 means disabled for uvicorn)
      case "$TIMEOUT_VAL" in
        (""|*[!0-9]*) : ;;
        (*) if [ "$TIMEOUT_VAL" -gt 0 ]; then set -- "$@" --timeout-graceful-shutdown "$GRACE_VAL"; fi ;;
      esac;

      # Workers only when >1
      if [ "$CONC" -gt 1 ]; then
        set -- "$@" --workers "$CONC";
      fi;

      # Access log toggle
      case "${UVICORN_ACCESS_LOG:-1}" in
        (0|false|no|off) set -- "$@" --no-access-log ;;
        (*)              set -- "$@" --access-log ;;
      esac;

      # Optional tuning flags (only if numeric)
      case "${UVICORN_LIMIT_CONCURRENCY:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --limit-concurrency "${UVICORN_LIMIT_CONCURRENCY}" ;;
      esac;

      case "${UVICORN_LIMIT_MAX_REQUESTS:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --limit-max-requests "${UVICORN_LIMIT_MAX_REQUESTS}" ;;
      esac;

      case "${UVICORN_BACKLOG:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --backlog "${UVICORN_BACKLOG}" ;;
      esac;

      if [ -n "${UVICORN_ROOT_PATH:-}" ]; then
        set -- "$@" --root-path "${UVICORN_ROOT_PATH}";
      fi;

      exec "$@"'

    healthCheckPath: /healthz

    envVars:
      # -------------------------
      # Runtime
      # -------------------------
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: TZ
        value: "Asia/Riyadh"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: UVICORN_KEEPALIVE
        value: "75"
      - key: UVICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: UVICORN_TIMEOUT
        value: "0"
      - key: LOG_LEVEL
        value: "info"
      - key: LOG_JSON
        value: "false"
      - key: DEBUG
        value: "false"

      # Fast-boot controls
      - key: DEFER_ROUTER_MOUNT
        value: "true"
      - key: INIT_ENGINE_ON_BOOT
        value: "true"

      # -------------------------
      # App identity (compat keys)
      # -------------------------
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: ENVIRONMENT
        value: "production"

      # Version (align with deployed)
      - key: APP_VERSION
        value: "5.3.1"
      - key: SERVICE_VERSION
        value: "5.3.1"
      - key: VERSION
        value: "5.3.1"

      # Base URLs
      - key: BACKEND_BASE_URL
        value: "https://tadawul-fast-bridge.onrender.com"
      - key: TFB_BASE_URL
        value: "https://tadawul-fast-bridge.onrender.com"

      # -------------------------
      # Security / auth
      # -------------------------
      - key: REQUIRE_AUTH
        value: "false"
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false
      - key: TFB_APP_TOKEN
        sync: false

      # -------------------------
      # Feature flags
      # -------------------------
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"
      - key: AI_ANALYSIS_ENABLED
        value: "true"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "true"

      # -------------------------
      # Providers policy (GLOBAL)
      # -------------------------
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: PROVIDERS
        value: "eodhd,finnhub"
      - key: PRIMARY_PROVIDER
        value: "eodhd"

      # -------------------------
      # KSA routing order (Option A: quiet + stable)
      # -------------------------
      - key: KSA_PROVIDERS
        value: "yahoo_chart"

      # Hard safety: never use EODHD for KSA
      - key: KSA_DISALLOW_EODHD
        value: "true"

      # Yahoo Chart fallbacks
      - key: ENABLE_YAHOO_CHART_KSA
        value: "true"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "true"

      # yfinance policy (if engine references it)
      - key: ENABLE_YFINANCE
        value: "true"
      - key: ENABLE_YFINANCE_KSA
        value: "false"

      # Yahoo fundamentals toggles (if your engine supports them)
      - key: ENABLE_YAHOO_FUNDAMENTALS_KSA
        value: "true"
      - key: ENABLE_YAHOO_FUNDAMENTALS_GLOBAL
        value: "false"

      # -------------------------
      # Provider keys (SECRETS)
      # -------------------------
      - key: FMP_API_KEY
        sync: false
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false

      # Optional Argaam (not used in Option A)
      - key: ARGAAM_GATEWAY_URL
        value: ""
      - key: ARGAAM_API_KEY
        sync: false

      # Optional explicit URLs (empty is fine)
      - key: TADAWUL_QUOTE_URL
        value: ""
      - key: TADAWUL_FUNDAMENTALS_URL
        value: ""
      - key: ARGAAM_QUOTE_URL
        value: ""
      - key: ARGAAM_PROFILE_URL
        value: ""

      # -------------------------
      # HTTP + caching (compat)
      # -------------------------
      - key: HTTP_TIMEOUT_SEC
        value: "25"
      - key: HTTP_TIMEOUT
        value: "25"

      - key: CACHE_TTL_SEC
        value: "20"
      - key: CACHE_DEFAULT_TTL
        value: "20"

      - key: ENGINE_CACHE_TTL_SEC
        value: "20"

      - key: QUOTE_TTL_SEC
        value: "30"
      - key: FUNDAMENTALS_TTL_SEC
        value: "21600"
      - key: ARGAAM_SNAPSHOT_TTL_SEC
        value: "30"

      # -------------------------
      # Rate limiting (SlowAPI)
      # -------------------------
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "240"

      # -------------------------
      # Batch controls
      # -------------------------
      - key: ENRICHED_BATCH_SIZE
        value: "40"
      - key: ENRICHED_MAX_TICKERS
        value: "250"
      - key: ENRICHED_BATCH_CONCURRENCY
        value: "5"
      - key: ENRICHED_CONCURRENCY
        value: "5"
      - key: ENRICHED_TIMEOUT_SEC
        value: "45"

      - key: AI_BATCH_SIZE
        value: "20"
      - key: AI_MAX_TICKERS
        value: "500"
      - key: AI_CONCURRENCY
        value: "5"
      - key: AI_TIMEOUT_SEC
        value: "45"

      - key: ADV_BATCH_SIZE
        value: "25"
      - key: ADV_MAX_TICKERS
        value: "500"
      - key: ADV_CONCURRENCY
        value: "6"
      - key: ADV_TIMEOUT_SEC
        value: "45"

      # -------------------------
      # Google Sheets integration (SECRETS)
      # -------------------------
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false

      # -------------------------
      # CORS
      # -------------------------
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
