# =============================================================================
# render.yaml
# =============================================================================
# TADAWUL FAST BRIDGE â€“ ENTERPRISE RENDER DEPLOYMENT BLUEPRINT (v7.5.0)
# =============================================================================
# QUANTUM EDITION | HIGH-PERFORMANCE ASGI | AUTO-SCALING INFRASTRUCTURE
#
# Architecture
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                    Render Platform (PaaS)                   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
# â”‚  â”‚   Web API    â”‚  â”‚   Redis      â”‚  â”‚   Worker     â”‚       â”‚
# â”‚  â”‚   Service    â”‚  â”‚   Cluster    â”‚  â”‚   Service    â”‚       â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
# â”‚         â”‚                 â”‚                 â”‚               â”‚
# â”‚         â–¼                 â–¼                 â–¼               â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
# â”‚  â”‚      PostgreSQL (Primary Relational Store)       â”‚       â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Core Capabilities
# â€¢ Jemalloc / TCMalloc memory allocator injection
# â€¢ Ultra-fast dependencies resolution using Astral 'uv'
# â€¢ Zero-downtime deployments (blue-green native)
# â€¢ Distributed tracing and Prometheus metrics sidecars
# â€¢ Circuit breaker & rate limit clustering via Redis
#
# Version: 7.5.0
# =============================================================================

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================
defaultRegion: frankfurt  # Optimal for Saudi Arabia/Middle East latency
defaultPlan: starter      # Minimum baseline for enterprise Python performance
defaultEnv: production
branch: main

buildFilter:
  paths:
    - main.py
    - core/**
    - routes/**
    - schemas/**
    - scripts/**
    - integrations/**
    - requirements.txt
    - render.yaml
  ignoredPaths:
    - tests/**
    - docs/**
    - examples/**
    - .github/**
    - .vscode/**
    - .gitignore
    - README.md

# =============================================================================
# SERVICES
# =============================================================================
services:
  # -------------------------------------------------------------------------
  # 1. Primary FastAPI Application
  # -------------------------------------------------------------------------
  - type: web
    name: tadawul-fast-bridge
    runtime: python
    region: frankfurt
    plan: pro               # Recommended for Production (v7.5.0)
    branch: main
    healthCheckPath: /readyz
    healthCheckTimeout: 10
    autoDeploy: true
    pullRequestPreviewsEnabled: true
    
    env: python
    pythonVersion: 3.11.9
    
    buildCommand: |
      # 1. Install system dependencies & Jemalloc (Memory Optimization)
      apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        libffi-dev \
        libssl-dev \
        curl \
        libjemalloc2 \
        && rm -rf /var/lib/apt/lists/*
      
      # 2. Install 'uv' for ultra-fast dependency resolution
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      
      # 3. Install dependencies
      uv pip install --system --no-cache -r requirements.txt
      
      # 4. Install Optional High-Performance Packages
      uv pip install --system --no-cache uvloop httptools orjson opentelemetry-api opentelemetry-sdk prometheus-client
      
      # 5. Compile Python bytecode for zero-overhead startup
      python -m compileall -q -f \
        -x "(tests|examples|docs|venv|\.git|__pycache__)" \
        .
      
      echo "âœ… Quantum Edition Build completed successfully"
    
    startCommand: |
      chmod +x scripts/*.sh
      
      # Inject Jemalloc for High-Performance Memory Allocation
      export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
      export MALLOC_CONF="background_thread:true,metadata_thp:auto,dirty_decay_ms:10000,muzzy_decay_ms:10000"
      
      # Start the application using the enterprise launcher
      exec scripts/start_web.sh
    
    scaling:
      minInstances: 2
      maxInstances: 10
      targetMemoryPercent: 80     # Allow internal GC to manage memory before scaling
      targetCPUPercent: 75
      targetConcurrentRequests: 150
    
    resources:
      memory: 2GB
      cpu: 1
    
    healthCheck:
      path: /readyz
      timeout: 10
      interval: 15
      retries: 5
      successThreshold: 1
      failureThreshold: 3
    
    domains:
      - api.tadawulfb.com
      - api.tadawulfastbridge.com
    
    headers:
      - key: X-Content-Type-Options
        value: nosniff
      - key: X-Frame-Options
        value: DENY
      - key: X-XSS-Protection
        value: 1; mode=block
      - key: Referrer-Policy
        value: strict-origin-when-cross-origin
      - key: Strict-Transport-Security
        value: max-age=31536000; includeSubDomains; preload

  # -------------------------------------------------------------------------
  # 2. Background Worker Service
  # -------------------------------------------------------------------------
  - type: worker
    name: tadawul-worker
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    autoDeploy: true
    pythonVersion: 3.11.9
    
    buildCommand: |
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.cargo/bin:$PATH"
      uv pip install --system --no-cache -r requirements.txt
      python -m compileall -q main.py core scripts
    
    startCommand: |
      export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
      python scripts/worker.py
    
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 75
    
    resources:
      memory: 1GB
      cpu: 0.5

  # -------------------------------------------------------------------------
  # 3. Redis Distributed Cache
  # -------------------------------------------------------------------------
  - type: redis
    name: tadawul-redis
    region: frankfurt
    plan: starter
    ipAllowList:
      - source: 0.0.0.0/0
        description: Allow all internal services
    maxmemoryPolicy: allkeys-lru

  # -------------------------------------------------------------------------
  # 4. Documentation Static Site
  # -------------------------------------------------------------------------
  - type: static
    name: tadawul-docs
    region: frankfurt
    plan: free
    branch: main
    buildCommand: |
      mkdir -p public
      cp -r docs/* public/ || true
      echo "Tadawul Fast Bridge v7.5.0 Documentation" > public/index.html
    publishPath: public
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
envVarGroups:
  # ===========================================================================
  # CORE RUNTIME CONFIGURATION
  # ===========================================================================
  - name: tfb-core
    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONDONTWRITEBYTECODE
        value: "1"
      - key: PYTHONHASHSEED
        value: "random"
      - key: TZ
        value: "Asia/Riyadh"
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: APP_VERSION
        value: "7.5.0"
      - key: SERVICE_VERSION
        value: "7.5.0"
      - key: RENDER_GIT_COMMIT
        fromService: RENDER_GIT_COMMIT
      - key: RENDER_INSTANCE_ID
        fromService: RENDER_INSTANCE_ID

  # ===========================================================================
  # LOGGING & OBSERVABILITY (v7.5.0 Upgrades)
  # ===========================================================================
  - name: tfb-logging
    envVars:
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_JSON
        value: "1"
      - key: UVICORN_ACCESS_LOG
        value: "1"
      - key: ENABLE_TRACING
        value: "1"
      - key: CORE_TRACING_ENABLED
        value: "1"
      - key: DATA_ENGINE_PERF_MONITORING
        value: "1"

  # ===========================================================================
  # WEB SERVER CONFIGURATION
  # ===========================================================================
  - name: tfb-server
    envVars:
      - key: PORT
        fromService: PORT
      - key: HOST
        value: "0.0.0.0"
      - key: WORKERS
        value: "4"
      - key: WEB_CONCURRENCY_MAX
        value: "16"
      - key: WORKER_CLASS
        value: "uvicorn.workers.UvicornWorker"
      - key: WORKER_CONNECTIONS
        value: "2048"
      - key: WORKER_MAX_REQUESTS
        value: "10000"
      - key: TIMEOUT_KEEP_ALIVE
        value: "65"
      - key: TIMEOUT_GRACEFUL
        value: "30"
      - key: BACKLOG
        value: "4096"

  # ===========================================================================
  # SECURITY & AUTHENTICATION
  # ===========================================================================
  - name: tfb-security
    envVars:
      - key: REQUIRE_AUTH
        value: "1"
      - key: AUTH_HEADER_NAME
        value: "X-APP-TOKEN"
      - key: RATE_LIMIT_ENABLED
        value: "1"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"
      - key: RATE_LIMIT_BACKEND
        value: "redis"
      - key: CORS_ORIGINS
        value: "https://app.tadawulfb.com,https://tadawulfb.com"
      - key: ALLOWED_HOSTS
        value: "api.tadawulfb.com,api.tadawulfastbridge.com,localhost"
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

  # ===========================================================================
  # FEATURE FLAGS & MACHINE LEARNING
  # ===========================================================================
  - name: tfb-features
    envVars:
      - key: ADVISOR_ENABLED
        value: "1"
      - key: AI_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ADAPTIVE_CONCURRENCY
        value: "1"
      - key: CACHE_ENABLED
        value: "1"
      - key: CACHE_COMPRESSION
        value: "1"
      - key: CACHE_COMPRESSION_LEVEL
        value: "6"
      - key: CIRCUIT_BREAKER_ENABLED
        value: "1"

  # ===========================================================================
  # DATA PROVIDERS
  # ===========================================================================
  - name: tfb-providers
    envVars:
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub,yahoo_chart,yahoo_fundamentals"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam,tadawul"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ARGAAM_API_KEY
        sync: false

  # ===========================================================================
  # CACHE CONFIGURATION
  # ===========================================================================
  - name: tfb-cache
    envVars:
      - key: CACHE_BACKEND
        value: "redis"
      - key: CACHE_TTL_SEC
        value: "300"
      - key: CACHE_MAX_SIZE
        value: "20000"
      - key: REDIS_URL
        fromService:
          name: tadawul-redis
          type: redis
          property: connectionString

  # ===========================================================================
  # GOOGLE SHEETS INTEGRATION
  # ===========================================================================
  - name: tfb-sheets
    envVars:
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: SHEETS_SAFE_MODE
        value: "strict"
      - key: SHEETS_USE_BATCH_UPDATE
        value: "true"

  # ===========================================================================
  # RESOURCE MANAGEMENT (System Guardian)
  # ===========================================================================
  - name: tfb-resources
    envVars:
      - key: GC_PRESSURE_MB
        value: "512"
      - key: DEGRADED_ENTER_LAG_MS
        value: "500"
      - key: DEGRADED_SHED_ENABLED
        value: "1"
      - key: MAX_FD_LIMIT
        value: "65536"

# =============================================================================
# BACKGROUND JOBS
# =============================================================================
cronJobs:
  # Daily cache cleanup
  - name: cache-cleanup
    schedule: "0 3 * * *"  # 3 AM daily
    command: python scripts/cleanup_cache.py
  
  # ML Model Drift Detection
  - name: model-drift-check
    schedule: "0 4 * * 0"  # 4 AM Sunday
    command: python scripts/drift_detection.py

  # Data refresh
  - name: refresh-provider-data
    schedule: "*/30 * * * *"  # Every 30 minutes
    command: python scripts/refresh_data.py

# =============================================================================
# MAINTENANCE PAGES
# =============================================================================
maintenance:
  path: /maintenance
  statusCode: 503
  body: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>Maintenance - Tadawul Fast Bridge</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 50px; background-color: #f9fafb;}
            h1 { color: #111827; }
            .message { color: #374151; margin: 20px 0; font-size: 1.2rem; }
        </style>
    </head>
    <body>
        <h1>ðŸ”„ System Upgrading</h1>
        <div class="message">Tadawul Fast Bridge is undergoing scheduled enterprise maintenance. We'll be back online momentarily.</div>
        <div>Riyadh Time: {{ .now | date "2006-01-02 15:04:05" }}</div>
    </body>
    </html>

# =============================================================================
# SECURITY SCANNING
# =============================================================================
security:
  vulnerabilityScanning: true
  dependencyScanning:
    enabled: true
    schedule: "0 0 * * *"
  containerScanning:
    enabled: true
    schedule: "0 0 * * 0"

# =============================================================================
# METADATA
# =============================================================================
version: 7.5.0
lastUpdated: 2026-02-21
author: Tadawul Fast Bridge Architecture Team
