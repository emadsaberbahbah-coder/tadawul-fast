# =============================================================================
# Tadawul Fast Bridge - Render Deployment Configuration
# Version: 3.1.1 | Python: 3.11.9 | Environment: Production
# =============================================================================

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"

    # =========================================================================
    # Build Configuration
    # =========================================================================
    buildCommand: |
      echo "ðŸš€ Building Tadawul Fast Bridge v3.1.1..."
      echo "ðŸ Python 3.11.9 | FastAPI | Production"

      # Upgrade pip and install dependencies
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt

      # Create necessary directories
      mkdir -p logs cache_backups scripts static
      echo "âœ… Project structure created"

      # -----------------------------------------------------------------------
      # dependency_check.py  â€“ verify core libs & versions
      # -----------------------------------------------------------------------
      cat > scripts/dependency_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Dependency Validation for Tadawul Fast Bridge
      """
      import sys
      import platform

      def check_dependencies():
          print(f'ðŸ Python: {sys.version.split()[0]}')
          print(f'ðŸ’» Platform: {platform.system()} {platform.release()}')

          required_packages = [
              ('fastapi', '0.104.1'),
              ('uvicorn', '0.24.0'),
              ('gspread', '5.12.4'),
              ('google.auth', None),
              ('pandas', '2.1.4'),
              ('aiohttp', '3.8.6'),
              ('pydantic', '2.5.3'),
              ('pydantic_settings', '2.1.0'),
          ]

          missing = []
          version_mismatch = []

          for package, expected_version in required_packages:
              try:
                  module = __import__(package.replace('-', '_').split('.')[0])
                  version = getattr(module, '__version__', 'unknown')

                  if expected_version and version != expected_version:
                      version_mismatch.append(
                          f'{package} (expected: {expected_version}, got: {version})'
                      )
                      print(f'âš ï¸  {package}: {version} (version mismatch)')
                  else:
                      print(f'âœ… {package}: {version}')
              except ImportError as e:
                  missing.append(package)
                  print(f'âŒ {package}: MISSING - {e}')

          try:
              from gspread.exceptions import APIError, SpreadsheetNotFound  # type: ignore
              print("âœ… gspread exceptions: APIError, SpreadsheetNotFound available")
          except Exception:
              print("âš ï¸  Could not import gspread exceptions cleanly (APIError).")

          if missing:
              print(f'ðŸš¨ Missing packages: {missing}')
          if version_mismatch:
              print(f'ðŸš¨ Version mismatches: {version_mismatch}')

          return not missing

      if __name__ == "__main__":
          success = check_dependencies()
          # Do NOT fail the build on version mismatch; only fail if core missing
          sys.exit(0 if success else 1)
      EOF

      # -----------------------------------------------------------------------
      # validate_credentials.py  â€“ basic GOOGLE_SHEETS_CREDENTIALS JSON check
      # -----------------------------------------------------------------------
      cat > scripts/validate_credentials.py << 'EOF'
      #!/usr/bin/env python3
      """
      Google Sheets Credentials Validation Script
      """
      import os
      import json
      import sys

      def validate_google_credentials():
          credentials_str = os.getenv('GOOGLE_SHEETS_CREDENTIALS')
          if not credentials_str:
              print("âš ï¸ GOOGLE_SHEETS_CREDENTIALS environment variable is not set")
              return True  # Do not block startup if you want to use Apps Script only

          try:
              credentials = json.loads(credentials_str)
              print("âœ… Google Sheets credentials JSON format is valid")

              required_fields = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email']
              missing_fields = [field for field in required_fields if field not in credentials]

              if missing_fields:
                  print(f"âŒ Missing required fields: {missing_fields}")
                  return False

              private_key = credentials.get('private_key', '')
              if not private_key.startswith('-----BEGIN PRIVATE KEY-----'):
                  print("âŒ Private key format invalid - must start with '-----BEGIN PRIVATE KEY-----'")
                  return False

              if '-----END PRIVATE KEY-----' not in private_key:
                  print("âŒ Private key format invalid - must end with '-----END PRIVATE KEY-----'")
                  return False

              print("âœ… Private key format is valid")
              print(f"âœ… Service account: {credentials.get('client_email')}")
              return True

          except json.JSONDecodeError as e:
              print(f"âŒ Invalid JSON in GOOGLE_SHEETS_CREDENTIALS: {e}")
              return False
          except Exception as e:
              print(f"âŒ Error validating credentials: {e}")
              return False

      if __name__ == "__main__":
          success = validate_google_credentials()
          sys.exit(0 if success else 1)
      EOF

      # -----------------------------------------------------------------------
      # startup_check.py â€“ validate required environment variables
      # -----------------------------------------------------------------------
      cat > scripts/startup_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Startup Environment Check for Tadawul Fast Bridge
      """
      import os
      import sys

      def check_environment():
          required_vars = ['SPREADSHEET_ID', 'GOOGLE_APPS_SCRIPT_URL']
          optional_vars = ['GOOGLE_SHEETS_CREDENTIALS', 'APP_TOKEN']

          missing = [var for var in required_vars if not os.getenv(var)]
          missing_optional = [var for var in optional_vars if not os.getenv(var)]

          if missing:
              print(f"âŒ Missing required environment variables: {missing}")
              return False

          if missing_optional:
              print(f"âš ï¸ Missing optional environment variables: {missing_optional}")
          else:
              print("âœ… All required and optional environment variables present")

          return True

      if __name__ == "__main__":
          success = check_environment()
          sys.exit(0 if success else 1)
      EOF

      chmod +x scripts/dependency_check.py scripts/startup_check.py scripts/validate_credentials.py

      echo "ðŸ”§ Running dependency checks..."
      python scripts/dependency_check.py

      echo "ðŸ”§ Running startup checks..."
      python scripts/startup_check.py

      echo "âœ… Build completed successfully"

    # =========================================================================
    # Start Command
    # =========================================================================
    startCommand: |
      echo "ðŸ”§ Starting Tadawul Fast Bridge v3.1.1"
      echo "ðŸŒ Environment: ${ENVIRONMENT:-production}"
      echo "ðŸ‘¥ Workers: ${WEB_CONCURRENCY:-2}"
      echo "ðŸ”— Port: $PORT"
      echo "ðŸ“Š Log Level: ${LOG_LEVEL:-info}"

      echo "ðŸ”§ Validating Google Sheets credentials..."
      python scripts/validate_credentials.py || echo "âš ï¸ Credentials validation failed (continuing)"

      echo "ðŸ”§ Running startup checks..."
      python scripts/startup_check.py || echo "âš ï¸ Startup checks reported issues (continuing)"

      echo "ðŸš€ Starting FastAPI application..."
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${WEB_CONCURRENCY:-2} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${LOG_LEVEL:-info} \
        --access-log \
        --loop asyncio \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30 \
        --header x-powered-by:"TadawulFastBridge/3.1.1" \
        --header x-server:"FastAPI-Uvicorn" || \
      {
        echo "âš ï¸ Primary start failed, starting with single worker..."
        uvicorn main:app \
          --host 0.0.0.0 \
          --port $PORT \
          --workers 1 \
          --log-level warning \
          --access-log
      }

    autoDeploy: true

    # =========================================================================
    # Health Check (Render native)
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 45
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"
        - name: X-Health-Check
          value: "true"

    # =========================================================================
    # Environment Variables (non-secret)
    # =========================================================================
    envVars:
      # Core Application Configuration
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_VERSION
        value: "3.1.1"
      - key: ENVIRONMENT
        value: "production"
      - key: DEBUG
        value: "false"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # FastAPI & Server Configuration
      - key: WEB_CONCURRENCY
        value: "2"
      - key: PYTHONUNBUFFERED
        value: "true"

      # Documentation
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"

      # Security & Authentication
      - key: REQUIRE_AUTH
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "120"

      # CORS Configuration
      - key: CORS_ORIGINS
        value: '["http://localhost:3000", "https://tadawul-fast-bridge.onrender.com", "https://your-app.com"]'

      # Cache Configuration (matches main.py Settings)
      - key: CACHE_DEFAULT_TTL
        value: "1800"
      - key: CACHE_MAX_SIZE
        value: "50000"
      - key: CACHE_BACKUP_ENABLED
        value: "true"
      - key: CACHE_SAVE_INTERVAL
        value: "10"

      # Google Sheets Integration
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"

      # HTTP / Retry Configuration
      - key: HTTP_TIMEOUT
        value: "30"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.0"

      # Tadawul-Specific Settings
      - key: TADAWUL_MARKET_ENABLED
        value: "true"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "60"
      - key: TADAWUL_MAX_SYMBOLS
        value: "200"
      - key: TZ
        value: "Asia/Riyadh"

      # Logging Configuration
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_FORMAT
        value: "detailed"
      - key: LOG_ENABLE_FILE
        value: "false"

    # =========================================================================
    # Secrets (managed in Render dashboard)
    # =========================================================================
    secrets:
      # Auth tokens
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: BACKUP_APP_TOKEN
        fromSecret: tadawul-backup-token

      # Google Service Account (JSON)
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

      # Financial API Keys
      - key: ALPHA_VANTAGE_API_KEY
        fromSecret: alpha-vantage-api-key
      - key: FINNHUB_API_KEY
        fromSecret: finnhub-api-key
      - key: EODHD_API_KEY
        fromSecret: eodhd-api-key
      - key: TWELVEDATA_API_KEY
        fromSecret: twelvedata-api-key
      - key: MARKETSTACK_API_KEY
        fromSecret: marketstack-api-key
      - key: FMP_API_KEY
        fromSecret: fmp-api-key

    # =========================================================================
    # Security Headers
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
      - path: "/*"
        name: "X-Powered-By"
        value: "TadawulFastBridge/3.1.1"

    # =========================================================================
    # Scaling Configuration (free plan: single instance)
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70
