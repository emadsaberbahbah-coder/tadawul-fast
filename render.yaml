# render.yaml  (FULL REPLACEMENT)
# ============================================================
# Tadawul Fast Bridge (FastAPI) — Render Blueprint
# PROD-SAFE + Backward-Compatible env var names (v1.1.3)
# ============================================================
#
# v1.1.3 changes vs v1.1.2
# - ✅ KSA_PROVIDERS set to "yahoo_chart" (Option A: remove Tadawul/Argaam warnings, keep KSA stable)
# - ✅ keeps integer-safe WEB_CONCURRENCY handling (no shell integer crash)
# - ✅ keeps deterministic uvicorn argv building + optional tuning flags
# - ✅ keeps full env compat (both *_SEC and legacy aliases)
#
# NOTE:
# - Do NOT hardcode your public URL if you use a different Render service name.
#   You can set BACKEND_BASE_URL in Render dashboard after first deploy.

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    autoDeploy: true

    buildCommand: pip install -r requirements.txt

    # Deterministic + safe startup (no "integer expression" crash)
    startCommand: >
      sh -c '
      LOG_LEVEL_LC="$(printf "%s" "${LOG_LEVEL:-info}" | tr "[:upper:]" "[:lower:]")";
      PORT_VAL="${PORT:-8000}";
      KEEPALIVE_VAL="${UVICORN_KEEPALIVE:-75}";
      case "${WEB_CONCURRENCY:-1}" in (""|*[!0-9]*) CONC=1 ;; (*) CONC="${WEB_CONCURRENCY:-1}" ;; esac;

      set -- uvicorn main:app
        --host 0.0.0.0
        --port "$PORT_VAL"
        --proxy-headers
        --forwarded-allow-ips "*"
        --lifespan on
        --timeout-keep-alive "$KEEPALIVE_VAL"
        --log-level "$LOG_LEVEL_LC"
        --no-server-header;

      if [ "$CONC" -gt 1 ]; then
        set -- "$@" --workers "$CONC";
      fi;

      case "${UVICORN_ACCESS_LOG:-1}" in
        (0|false|no|off) set -- "$@" --no-access-log ;;
        (*)              set -- "$@" --access-log ;;
      esac;

      case "${UVICORN_LIMIT_CONCURRENCY:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --limit-concurrency "${UVICORN_LIMIT_CONCURRENCY}" ;;
      esac;

      case "${UVICORN_LIMIT_MAX_REQUESTS:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --limit-max-requests "${UVICORN_LIMIT_MAX_REQUESTS}" ;;
      esac;

      case "${UVICORN_BACKLOG:-}" in
        (""|*[!0-9]*) : ;;
        (*) set -- "$@" --backlog "${UVICORN_BACKLOG}" ;;
      esac;

      if [ -n "${UVICORN_ROOT_PATH:-}" ]; then
        set -- "$@" --root-path "${UVICORN_ROOT_PATH}";
      fi;

      exec "$@"'

    healthCheckPath: /healthz

    envVars:
      # -------------------------
      # Runtime
      # -------------------------
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: TZ
        value: "Asia/Riyadh"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: UVICORN_KEEPALIVE
        value: "75"
      - key: LOG_LEVEL
        value: "info"
      - key: LOG_JSON
        value: "false"
      - key: DEBUG
        value: "false"

      # Fast-boot controls (match main.py defaults but explicit here)
      - key: DEFER_ROUTER_MOUNT
        value: "true"
      - key: INIT_ENGINE_ON_BOOT
        value: "true"

      # -------------------------
      # App identity (compat keys)
      # -------------------------
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge"
      - key: APP_ENV
        value: "production"
      - key: ENVIRONMENT
        value: "production"

      # Version (compat keys) — keep aligned with your deployed version
      - key: APP_VERSION
        value: "5.3.1"
      - key: SERVICE_VERSION
        value: "5.3.1"
      - key: VERSION
        value: "5.3.1"

      # Public base url of this service (adjust to your real Render URL)
      - key: BACKEND_BASE_URL
        value: "https://tadawul-fast-bridge.onrender.com"
      - key: TFB_BASE_URL
        value: "https://tadawul-fast-bridge.onrender.com"

      # -------------------------
      # Security tokens (SECRETS)
      # -------------------------
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false
      - key: REQUIRE_AUTH
        value: "false"

      # -------------------------
      # Feature flags (FastAPI docs + routers)
      # -------------------------
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"

      - key: AI_ANALYSIS_ENABLED
        value: "true"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "true"

      # -------------------------
      # Providers policy
      # -------------------------
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: PROVIDERS
        value: "eodhd,finnhub"
      - key: PRIMARY_PROVIDER
        value: "finnhub"

      # KSA routing order (Option A: stable + no "tadawul skipped" warning)
      - key: KSA_PROVIDERS
        value: "yahoo_chart"

      # Hard safety: never use EODHD for KSA
      - key: KSA_DISALLOW_EODHD
        value: "true"

      # Yahoo Chart fallbacks (KSA-safe)
      - key: ENABLE_YAHOO_CHART_KSA
        value: "true"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "true"

      # yfinance policy
      - key: ENABLE_YFINANCE
        value: "true"       # global fallback if your engine uses it
      - key: ENABLE_YFINANCE_KSA
        value: "false"      # IMPORTANT: keep KSA yfinance OFF unless explicitly desired

      # Provider keys (SECRETS) — keep Render names (config.py exports aliases)
      - key: FMP_API_KEY
        sync: false
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false

      # Argaam (optional)
      - key: ARGAAM_GATEWAY_URL
        value: ""
      - key: ARGAAM_API_KEY
        sync: false

      # Optional explicit URLs (only if you use them in engine)
      - key: TADAWUL_QUOTE_URL
        value: ""
      - key: TADAWUL_FUNDAMENTALS_URL
        value: ""
      - key: ARGAAM_QUOTE_URL
        value: ""
      - key: ARGAAM_PROFILE_URL
        value: ""

      # -------------------------
      # HTTP + caching (set BOTH styles for compatibility)
      # -------------------------
      - key: HTTP_TIMEOUT_SEC
        value: "25"
      - key: HTTP_TIMEOUT
        value: "25"

      - key: CACHE_TTL_SEC
        value: "20"
      - key: CACHE_DEFAULT_TTL
        value: "20"

      - key: ENGINE_CACHE_TTL_SEC
        value: "20"

      - key: QUOTE_TTL_SEC
        value: "30"
      - key: FUNDAMENTALS_TTL_SEC
        value: "21600"
      - key: ARGAAM_SNAPSHOT_TTL_SEC
        value: "30"

      # -------------------------
      # Rate limiting (SlowAPI)
      # -------------------------
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "240"

      # -------------------------
      # Batch controls (set BOTH names where code differs)
      # -------------------------
      - key: ENRICHED_BATCH_SIZE
        value: "40"
      - key: ENRICHED_MAX_TICKERS
        value: "250"
      - key: ENRICHED_BATCH_CONCURRENCY
        value: "5"
      - key: ENRICHED_CONCURRENCY
        value: "5"
      - key: ENRICHED_TIMEOUT_SEC
        value: "45"

      - key: AI_BATCH_SIZE
        value: "20"
      - key: AI_MAX_TICKERS
        value: "500"
      - key: AI_CONCURRENCY
        value: "5"
      - key: AI_TIMEOUT_SEC
        value: "45"

      - key: ADV_BATCH_SIZE
        value: "25"
      - key: ADV_MAX_TICKERS
        value: "500"
      - key: ADV_CONCURRENCY
        value: "6"
      - key: ADV_TIMEOUT_SEC
        value: "45"

      # -------------------------
      # Google Sheets integration (SECRETS)
      # -------------------------
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false

      # -------------------------
      # CORS
      # -------------------------
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
