# =============================================================================
# Tadawul Stock Analysis API - Render Deployment Configuration
# =============================================================================

services:
  - type: web
    name: tadawul-fast-1
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.8"
    
    # =========================================================================
    # Build Configuration
    # =========================================================================
    buildCommand: |
      echo "üöÄ Building Tadawul Stock Analysis API v2.2.0..."
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt
      
      # Create necessary directories
      mkdir -p logs cache_backups static templates
      echo "‚úÖ Directories created successfully"
      
      # Minimal dependency validation
      python -c "
      import sys
      print(f'üêç Python {sys.version}')
      try:
          import fastapi, uvicorn, gspread, pandas, aiohttp, httpx
          print(f'‚úÖ FastAPI {fastapi.__version__}')
          print(f'‚úÖ Uvicorn {uvicorn.__version__}')
          print(f'‚úÖ gspread {gspread.__version__}')
          print(f'‚úÖ pandas {pandas.__version__}')
          print('‚úÖ Core dependencies installed successfully')
      except ImportError as e:
          print(f'‚ùå Import error: {e}')
          sys.exit(1)
      "
      echo "‚úÖ Build completed successfully"
    
    # =========================================================================
    # Start Command
    # =========================================================================
    startCommand: |
      echo "üîß Starting Tadawul API v2.2.0 with ${UVICORN_WORKERS:-1} worker(s) on port $PORT"
      echo "üìä Environment: ${ENVIRONMENT:-production}"
      echo "üîó Service URL: ${FASTAPI_BASE:-https://tadawul-fast-1.onrender.com}"
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${UVICORN_WORKERS:-1} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${UVICORN_LOG_LEVEL:-info} \
        --access-log \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30
    
    autoDeploy: true
    
    # =========================================================================
    # Simple Health Check (Render top-level)
    # =========================================================================
    healthCheckPath: /health
    healthCheckTimeout: 30
    healthCheckInterval: 60
    initialDelay: 45

    # =========================================================================
    # Environment Variables
    # =========================================================================
    envVars:
      # === Core Service Configuration ===
      - key: SERVICE_NAME
        value: "Tadawul Stock Analysis API"
      - key: SERVICE_VERSION
        value: "2.2.0"
      - key: API_VERSION
        value: "v1"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # === FastAPI Configuration ===
      - key: FASTAPI_BASE
        value: "https://tadawul-fastap.onrender.com"
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"
      - key: DOCS_URL
        value: "/docs"
      - key: REDOC_URL
        value: "/redoc"
      - key: OPENAPI_URL
        value: "/openapi.json"

      # === Authentication & Security ===
      - key: REQUIRE_AUTH
        value: "true"        # <-- turned ON to use APP_TOKEN
      - key: ALLOWED_ORIGINS
        value: "*"
      - key: SECRET_KEY
        value: "tadawul-api-secret-key-change-in-production"
      - key: ALGORITHM
        value: "HS256"
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "30"

      # === Performance & Scaling ===
      - key: UVICORN_WORKERS
        value: "1"
      - key: UVICORN_LOG_LEVEL
        value: "info"
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: PYTHONPYCACHEPREFIX
        value: "/tmp/pycache"

      # === Cache & Storage Configuration ===
      - key: CACHE_PATH
        value: "./quote_cache.json"
      - key: CACHE_BACKUP_DIR
        value: "./cache_backups"
      - key: CACHE_AUTO_SAVE
        value: "true"
      - key: CACHE_BACKUP_RETENTION_DAYS
        value: "7"
      - key: CACHE_DEFAULT_TTL
        value: "300"

      # === Data Provider Configuration ===
      - key: DATA_PROVIDER
        value: "MULTI_SOURCE"
      - key: PRIMARY_DATA_SOURCE
        value: "GOOGLE_SHEETS"
      - key: SECONDARY_DATA_SOURCE
        value: "ARGAAM"
      - key: FALLBACK_DATA_SOURCE
        value: "MOCK"

      # === Google Sheets Integration ===
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: SHEETS_SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_SHEETS_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"

      # === Sheet Names Configuration (kept for future use) ===
      - key: SHEETS_SYMBOLS_TAB
        value: "Market_Leaders"
      - key: SHEETS_TAB_SYMBOLS
        value: "Market_Leaders"
      - key: SHEETS_DASHBOARD_TAB
        value: "Dashboard"
      - key: SHEETS_ANALYSIS_TAB
        value: "AI_Analysis"
      - key: SHEETS_PRICES_TAB
        value: "Prices"
      - key: SHEETS_FINANCIALS_TAB
        value: "Financials"
      - key: SHEETS_INDICATORS_TAB
        value: "Indicators"
      - key: SHEETS_SECTORS_TAB
        value: "Sectors"
      - key: SHEETS_REPORTS_TAB
        value: "Reports"
      - key: SHEETS_USERS_TAB
        value: "Users"
      - key: SHEETS_SETTINGS_TAB
        value: "Settings"

      # === Google Apps Script Integration ===
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"
      - key: GOOGLE_APPS_SCRIPT_TIMEOUT
        value: "30"

      # === Argaam Integration ===
      - key: ARGAAM_TIMEOUT
        value: "30"
      - key: ARGAAM_MAX_RETRIES
        value: "3"
      - key: ARGAAM_CACHE_TTL
        value: "600"
      - key: ARGAAM_USER_AGENT
        value: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      - key: ARGAAM_BASE_URL
        value: "https://www.argaam.com"

      # === Feature Flags ===
      - key: ENABLE_ARGAAM_INTEGRATION
        value: "true"
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      - key: ENABLE_AI_ANALYSIS
        value: "true"
      - key: ENABLE_MARKET_DASHBOARD
        value: "true"
      - key: ENABLE_SYMBOLS_READER
        value: "true"
      - key: ENABLE_MULTI_SOURCE_DATA
        value: "true"
      - key: ENABLE_GOOGLE_APPS_SCRIPT
        value: "true"
      - key: ENABLE_CACHE_MANAGEMENT
        value: "true"
      - key: ENABLE_HEALTH_CHECKS
        value: "true"
      - key: ENABLE_BACKGROUND_TASKS
        value: "true"
      - key: ENABLE_SHEET_VERIFICATION
        value: "true"

      # === Market Data Settings ===
      - key: DEFAULT_MARKET
        value: "SAUDI"
      - key: DEFAULT_CURRENCY
        value: "SAR"
      - key: MARKET_OPEN_TIME
        value: "10:00"
      - key: MARKET_CLOSE_TIME
        value: "15:00"
      - key: MARKET_TIMEZONE
        value: "Asia/Riyadh"
      - key: MARKET_DAYS
        value: "Sunday,Monday,Tuesday,Wednesday,Thursday"

      # === Timezone & Scheduling ===
      - key: TZ
        value: "Asia/Riyadh"
      - key: TRADING_INTERVAL_MINUTES
        value: "5"

      # === Logging Configuration ===
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_FILE
        value: "./logs/application.log"
      - key: LOG_MAX_SIZE_MB
        value: "10"
      - key: LOG_BACKUP_COUNT
        value: "5"
      - key: LOG_FORMAT
        value: "json"
      - key: LOG_ENABLE_CONSOLE
        value: "true"
      - key: LOG_ENABLE_FILE
        value: "false"

      # === Request Rate Limiting ===
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "100"
      - key: RATE_LIMIT_ENABLED
        value: "true"

      # === Security & CORS ===
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: TRUSTED_PROXIES
        value: "*"
      - key: ENABLE_CORS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
      - key: ENABLE_HTTPS_REDIRECT
        value: "true"
      - key: TRUSTED_HOSTS
        value: "*"

    # =========================================================================
    # Secrets (do NOT hard-code keys in this file)
    # =========================================================================
    secrets:
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: BACKUP_APP_TOKEN
        fromSecret: tadawul-backup-token
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

      # Financial APIs ‚Äì create these secrets in Render dashboard
      - key: ALPHA_VANTAGE_API_KEY
        fromSecret: alpha-vantage-api-key
      - key: FINNHUB_API_KEY
        fromSecret: finnhub-api-key
      - key: EODHD_API_KEY
        fromSecret: eodhd-api-key
      - key: TWELVEDATA_API_KEY
        fromSecret: twelvedata-api-key
      - key: MARKETSTACK_API_KEY
        fromSecret: marketstack-api-key
      - key: FMP_API_KEY
        fromSecret: fmp-api-key

    # =========================================================================
    # Optional advanced health check (matches your /health endpoint)
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 45
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"

    # =========================================================================
    # Disk Configuration for Cache Persistence
    # =========================================================================
    disk:
      name: tadawul-cache-data
      mountPath: /opt/render/cache
      sizeGB: 1

    # =========================================================================
    # Basic Security Headers
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/*"
        name: "Strict-Transport-Security"
        value: "max-age=31536000; includeSubDomains"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"

    # =========================================================================
    # Scaling (keep 1 instance on free plan)
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70

# =============================================================================
# Cron Jobs ‚Äì OPTIONAL (you can leave as-is or comment out if endpoints don't exist)
# =============================================================================
jobs:
  - name: health-monitoring
    plan: free
    schedule: "*/15 * * * *"
    command: |
      echo "üè• Running health monitoring..."
      curl -f "https://${RENDER_SERVICE_NAME}.onrender.com/health" || exit 1
    envVars:
      - key: ENVIRONMENT
        value: production
