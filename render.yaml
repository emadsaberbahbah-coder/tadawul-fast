# =============================================================================
# =============================================================================
# Tadawul Fast Bridge - Enhanced Render Deployment Configuration
# Version: 3.1.0 | Python: 3.11.9 | Environment: Production
# =============================================================================

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    # =========================================================================
    # Enhanced Build Configuration
    # =========================================================================
    buildCommand: |
      echo "ðŸš€ Building Tadawul Fast Bridge v3.1.0..."
      echo "ðŸ Python 3.11.9 | FastAPI | Production"
      
      # Upgrade pip and install dependencies
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt
      
      # Create necessary directories
      mkdir -p logs cache_backups scripts static
      echo "âœ… Project structure created"
      
      # Enhanced dependency validation
      python -c "
      import sys, platform
      print(f'ðŸ Python {sys.version}')
      print(f'ðŸ’» Platform: {platform.system()} {platform.release()}')
      
      required_packages = [
          'fastapi', 'uvicorn', 'gspread', 'google.auth', 
          'pandas', 'aiohttp', 'pydantic', 'pydantic_settings'
      ]
      
      missing = []
      for package in required_packages:
          try:
              __import__(package.replace('-', '_'))
              version = getattr(__import__(package), '__version__', 'unknown')
              print(f'âœ… {package}: {version}')
          except ImportError as e:
              missing.append(package)
              print(f'âŒ {package}: MISSING - {e}')
      
      if missing:
          print(f'ðŸš¨ Missing packages: {missing}')
          sys.exit(1)
      else:
          print('âœ… All core dependencies verified')
      "
      
      # Create startup script for health monitoring
      cat > scripts/startup_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Startup Health Check for Tadawul Fast Bridge
      """
      import os
      import sys
      
      def check_environment():
          required_vars = ['SPREADSHEET_ID', 'GOOGLE_APPS_SCRIPT_URL']
          missing = [var for var in required_vars if not os.getenv(var)]
          
          if missing:
              print(f"âŒ Missing required environment variables: {missing}")
              return False
          
          print("âœ… Environment variables check passed")
          return True
      
      if __name__ == "__main__":
          success = check_environment()
          sys.exit(0 if success else 1)
      EOF
      
      python scripts/startup_check.py
      echo "âœ… Build completed successfully"

    # =========================================================================
    # Enhanced Start Command
    # =========================================================================
    startCommand: |
      echo "ðŸ”§ Starting Tadawul Fast Bridge v3.1.0"
      echo "ðŸŒ Environment: ${ENVIRONMENT:-production}"
      echo "ðŸ‘¥ Workers: ${WEB_CONCURRENCY:-2}"
      echo "ðŸ”— Port: $PORT"
      echo "ðŸ“Š Log Level: ${LOG_LEVEL:-info}"
      
      # Run startup checks
      python scripts/startup_check.py
      
      # Start the application with enhanced configuration
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${WEB_CONCURRENCY:-2} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${LOG_LEVEL:-info} \
        --access-log \
        --loop asyncio \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30 \
        --header x-powered-by:"TadawulFastBridge/3.1.0" \
        --header x-server:"FastAPI-Uvicorn"

    autoDeploy: true
    
    # =========================================================================
    # Enhanced Health Check Configuration
    # =========================================================================
    healthCheckPath: /health
    healthCheckTimeout: 25
    healthCheckInterval: 60
    initialDelay: 30

    # =========================================================================
    # Optimized Environment Variables
    # =========================================================================
    envVars:
      # === Core Application Configuration ===
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_VERSION
        value: "3.1.0"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # === FastAPI & Server Configuration ===
      - key: WEB_CONCURRENCY
        value: "2"
      - key: LOG_LEVEL
        value: "INFO"
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"
      - key: PYTHONUNBUFFERED
        value: "true"

      # === Security & Authentication ===
      - key: REQUIRE_AUTH
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "120"

      # === CORS Configuration ===
      - key: CORS_ORIGINS
        value: '["http://localhost:3000", "https://tadawul-fast-1.onrender.com", "https://your-app.com"]'

      # === Cache Configuration ===
      - key: CACHE_DEFAULT_TTL
        value: "1800"
      - key: CACHE_MAX_SIZE
        value: "50000"
      - key: CACHE_BACKUP_ENABLED
        value: "true"
      - key: CACHE_CLEANUP_INTERVAL
        value: "300"

      # === Google Sheets Integration ===
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"

      # === Performance & HTTP Configuration ===
      - key: HTTP_TIMEOUT
        value: "30"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.0"
      - key: CONNECTION_POOL_SIZE
        value: "100"

      # === Tadawul-Specific Settings ===
      - key: TADAWUL_MARKET_ENABLED
        value: "true"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "60"
      - key: TADAWUL_MAX_SYMBOLS
        value: "200"
      - key: TZ
        value: "Asia/Riyadh"

      # === Monitoring & Health ===
      - key: HEALTH_CHECK_INTERVAL
        value: "30"
      - key: HEALTH_MONITOR_TIMEOUT
        value: "10"
      - key: ENABLE_HEALTH_MONITOR
        value: "true"

      # === Feature Flags ===
      - key: ENABLE_CACHE_WORKER
        value: "true"
      - key: ENABLE_BACKUP_SCHEDULER
        value: "true"
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      - key: ENABLE_MULTI_SOURCE_DATA
        value: "true"

      # === Logging Configuration ===
      - key: LOG_ENABLE_FILE
        value: "false"
      - key: LOG_FORMAT
        value: "detailed"
      - key: LOG_RETENTION_DAYS
        value: "7"

    # =========================================================================
    # Secrets Management
    # =========================================================================
    secrets:
      # Authentication Tokens
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: BACKUP_APP_TOKEN
        fromSecret: tadawul-backup-token

      # Google Services - Use GOOGLE_SHEETS_CREDENTIALS to match our AppConfig
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

      # Optional Financial APIs
      - key: ALPHA_VANTAGE_API_KEY
        fromSecret: alpha-vantage-api-key
      - key: FINNHUB_API_KEY
        fromSecret: finnhub-api-key
      - key: EODHD_API_KEY
        fromSecret: eodhd-api-key
      - key: TWELVEDATA_API_KEY
        fromSecret: twelvedata-api-key
      - key: MARKETSTACK_API_KEY
        fromSecret: marketstack-api-key
      - key: FMP_API_KEY
        fromSecret: fmp-api-key

    # =========================================================================
    # Enhanced Health Check Configuration
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 30
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"
        - name: X-Health-Check
          value: "true"

    # =========================================================================
    # Security Headers
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
      - path: "/*"
        name: "X-Powered-By"
        value: "TadawulFastBridge/3.1.0"

    # =========================================================================
    # Scaling Configuration
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70

# =============================================================================
# Background Worker Services
# =============================================================================
  - type: worker
    name: tadawul-cache-worker
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    
    startCommand: |
      echo "ðŸ”§ Starting Cache Worker..."
      python scripts/cache_manager.py --mode worker --cleanup-interval 300
    
    envVars:
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"

    secrets:
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

# =============================================================================
# Health Monitoring Worker
# =============================================================================
  - type: worker
    name: tadawul-health-monitor
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    
    startCommand: |
      echo "ðŸ”§ Starting Health Monitor..."
      python scripts/health_monitor.py \
        --api-url https://tadawul-fast-bridge.onrender.com \
        --interval 30 \
        --timeout 10
    
    envVars:
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"

# =============================================================================
# Cron Jobs for Maintenance
# =============================================================================
jobs:
  - name: health-monitoring
    plan: free
    schedule: "*/15 * * * *"
    command: |
      echo "ðŸ¥ Running scheduled health check..."
      curl -f -H "X-Health-Check: true" \
        "https://tadawul-fast-bridge.onrender.com/health" || exit 1
    
    envVars:
      - key: ENVIRONMENT
        value: production

  - name: cache-cleanup
    plan: free
    schedule: "0 2 * * *"  # Daily at 2 AM
    command: |
      echo "ðŸ§¹ Running cache cleanup..."
      curl -X POST -H "Authorization: Bearer $APP_TOKEN" \
        "https://tadawul-fast-bridge.onrender.com/v1/cache/cleanup"
    
    envVars:
      - key: ENVIRONMENT
        value: production
    secrets:
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
