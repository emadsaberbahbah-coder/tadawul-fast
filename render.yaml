# =============================================================================
# Tadawul Fast Bridge - Render Deployment Configuration
# Version: 3.2.0 | Python: 3.11.9 | Environment: Production
# =============================================================================

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"

    # =========================================================================
    # Build Configuration
    # =========================================================================
    buildCommand: |
      echo "ðŸš€ Building Tadawul Fast Bridge v3.2.0..."
      echo "ðŸ Python 3.11.9 | FastAPI | Production"
      echo "ðŸ“Š Adding enhanced counting and monitoring features..."

      # Upgrade pip and install dependencies
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt

      # Create necessary directories
      mkdir -p logs cache_backups scripts static
      echo "âœ… Project structure created"

      # -----------------------------------------------------------------------
      # dependency_check.py  â€“ verify core libs & versions
      # -----------------------------------------------------------------------
      cat > scripts/dependency_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Dependency Validation for Tadawul Fast Bridge
      """
      import sys
      import platform

      def check_dependencies():
          print(f'ðŸ Python: {sys.version.split()[0]}')
          print(f'ðŸ’» Platform: {platform.system()} {platform.release()}')

          required_packages = [
              ('fastapi', '0.104.1'),
              ('uvicorn', '0.24.0'),
              ('gspread', '5.12.4'),
              ('google.auth', None),
              ('pandas', '2.1.4'),
              ('aiohttp', '3.8.6'),
              ('pydantic', '2.5.3'),
              ('pydantic_settings', '2.1.0'),
          ]

          missing = []
          version_mismatch = []
          total_packages = len(required_packages)
          checked_count = 0

          for package, expected_version in required_packages:
              checked_count += 1
              try:
                  module = __import__(package.replace('-', '_').split('.')[0])
                  version = getattr(module, '__version__', 'unknown')

                  if expected_version and version != expected_version:
                      version_mismatch.append(
                          f'{package} (expected: {expected_version}, got: {version})'
                      )
                      print(f'âš ï¸  {package}: {version} (version mismatch)')
                  else:
                      print(f'âœ… {package}: {version}')
              except ImportError as e:
                  missing.append(package)
                  print(f'âŒ {package}: MISSING - {e}')

          try:
              from gspread.exceptions import APIError, SpreadsheetNotFound  # type: ignore
              print("âœ… gspread exceptions: APIError, SpreadsheetNotFound available")
          except Exception:
              print("âš ï¸  Could not import gspread exceptions cleanly (APIError).")

          if missing:
              print(f'ðŸš¨ Missing packages: {missing}')
          if version_mismatch:
              print(f'ðŸš¨ Version mismatches: {version_mismatch}')

          print(f'ðŸ“Š Dependency check summary:')
          print(f'   Total packages: {total_packages}')
          print(f'   Checked: {checked_count}')
          print(f'   Missing: {len(missing)}')
          print(f'   Version mismatches: {len(version_mismatch)}')
          print(f'   Success rate: {((total_packages - len(missing)) / total_packages * 100):.1f}%')

          return not missing

      if __name__ == "__main__":
          success = check_dependencies()
          # Do NOT fail the build on version mismatch; only fail if core missing
          sys.exit(0 if success else 1)
      EOF

      # -----------------------------------------------------------------------
      # validate_credentials.py  â€“ basic GOOGLE_SHEETS_CREDENTIALS JSON check
      # -----------------------------------------------------------------------
      cat > scripts/validate_credentials.py << 'EOF'
      #!/usr/bin/env python3
      """
      Google Sheets Credentials Validation Script with Counting
      """
      import os
      import json
      import sys

      def validate_google_credentials():
          credentials_str = os.getenv('GOOGLE_SHEETS_CREDENTIALS')
          validation_stats = {
              'checks_passed': 0,
              'checks_failed': 0,
              'total_checks': 6
          }

          if not credentials_str:
              print("âš ï¸ GOOGLE_SHEETS_CREDENTIALS environment variable is not set")
              print("ðŸ“Š Credential check: 0/6 passed")
              return True  # Do not block startup if you want to use Apps Script only

          try:
              credentials = json.loads(credentials_str)
              validation_stats['checks_passed'] += 1
              print("âœ… Google Sheets credentials JSON format is valid")

              required_fields = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email']
              missing_fields = [field for field in required_fields if field not in credentials]

              if not missing_fields:
                  validation_stats['checks_passed'] += 1
                  print(f"âœ… All required fields present")
              else:
                  validation_stats['checks_failed'] += 1
                  print(f"âŒ Missing required fields: {missing_fields}")

              # Check private key format
              private_key = credentials.get('private_key', '')
              if private_key.startswith('-----BEGIN PRIVATE KEY-----'):
                  validation_stats['checks_passed'] += 1
                  print("âœ… Private key starts correctly")
              else:
                  validation_stats['checks_failed'] += 1
                  print("âŒ Private key format invalid - must start with '-----BEGIN PRIVATE KEY-----'")

              if '-----END PRIVATE KEY-----' in private_key:
                  validation_stats['checks_passed'] += 1
                  print("âœ… Private key ends correctly")
              else:
                  validation_stats['checks_failed'] += 1
                  print("âŒ Private key format invalid - must end with '-----END PRIVATE KEY-----'")

              # Check client email format
              client_email = credentials.get('client_email', '')
              if client_email and '@' in client_email and '.iam.gserviceaccount.com' in client_email:
                  validation_stats['checks_passed'] += 1
                  print(f"âœ… Service account email format valid: {client_email}")
              else:
                  validation_stats['checks_failed'] += 1
                  print(f"âš ï¸  Service account email may be invalid: {client_email}")

              # Check for token URI
              if credentials.get('token_uri'):
                  validation_stats['checks_passed'] += 1
                  print("âœ… Token URI present")
              else:
                  print("â„¹ï¸  Token URI not specified (optional)")

              print(f"ðŸ“Š Credential validation summary:")
              print(f"   Total checks: {validation_stats['total_checks']}")
              print(f"   Passed: {validation_stats['checks_passed']}")
              print(f"   Failed: {validation_stats['checks_failed']}")
              print(f"   Success rate: {(validation_stats['checks_passed'] / validation_stats['total_checks'] * 100):.1f}%")

              return validation_stats['checks_failed'] == 0

          except json.JSONDecodeError as e:
              print(f"âŒ Invalid JSON in GOOGLE_SHEETS_CREDENTIALS: {e}")
              return False
          except Exception as e:
              print(f"âŒ Error validating credentials: {e}")
              return False

      if __name__ == "__main__":
          success = validate_google_credentials()
          sys.exit(0 if success else 1)
      EOF

      # -----------------------------------------------------------------------
      # startup_check.py â€“ validate required environment variables with counting
      # -----------------------------------------------------------------------
      cat > scripts/startup_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Startup Environment Check for Tadawul Fast Bridge with Enhanced Counting
      """
      import os
      import sys

      def check_environment():
          required_vars = [
              'SPREADSHEET_ID',
              'GOOGLE_APPS_SCRIPT_URL'
          ]
          
          optional_vars = [
              'GOOGLE_SHEETS_CREDENTIALS',
              'APP_TOKEN',
              'ALPHA_VANTAGE_API_KEY',
              'FINNHUB_API_KEY',
              'EODHD_API_KEY',
              'TWELVEDATA_API_KEY',
              'MARKETSTACK_API_KEY',
              'FMP_API_KEY'
          ]

          print("ðŸ” Starting environment variable scan...")
          
          # Count and check required variables
          missing_required = []
          present_required = []
          
          for var in required_vars:
              if os.getenv(var):
                  present_required.append(var)
                  print(f"âœ… Required: {var} = Present")
              else:
                  missing_required.append(var)
                  print(f"âŒ Required: {var} = MISSING")

          # Count and check optional variables
          missing_optional = []
          present_optional = []
          
          for var in optional_vars:
              if os.getenv(var):
                  present_optional.append(var)
                  print(f"âœ… Optional: {var} = Present")
              else:
                  missing_optional.append(var)
                  print(f"âš ï¸  Optional: {var} = Not set")

          # Summary statistics
          total_vars = len(required_vars) + len(optional_vars)
          present_vars = len(present_required) + len(present_optional)
          
          print(f"\nðŸ“Š Environment Variable Summary:")
          print(f"   Total variables checked: {total_vars}")
          print(f"   Required variables: {len(required_vars)}")
          print(f"   - Present: {len(present_required)}")
          print(f"   - Missing: {len(missing_required)}")
          print(f"   Optional variables: {len(optional_vars)}")
          print(f"   - Present: {len(present_optional)}")
          print(f"   - Missing: {len(missing_optional)}")
          print(f"   Overall completion: {(present_vars / total_vars * 100):.1f}%")

          if missing_required:
              print(f"\nðŸš¨ CRITICAL: Missing required environment variables: {missing_required}")
              print("   These must be set for the application to function properly.")
              return False

          if len(missing_optional) > 0:
              print(f"\nâš ï¸  WARNING: {len(missing_optional)} optional variables not set")
              print("   Some features may be limited. Consider setting these for full functionality.")

          print("\nâœ… Environment check completed successfully")
          return True

      if __name__ == "__main__":
          success = check_environment()
          sys.exit(0 if success else 1)
      EOF

      # -----------------------------------------------------------------------
      # performance_counter.py â€“ monitor and count performance metrics
      # -----------------------------------------------------------------------
      cat > scripts/performance_counter.py << 'EOF'
      #!/usr/bin/env python3
      """
      Performance Counter for Tadawul Fast Bridge
      Tracks and counts various application metrics
      """
      import os
      import time
      import psutil
      import sys

      def count_performance_metrics():
          print("ðŸ“Š Performance Metrics Counter")
          print("=" * 40)
          
          metrics = {
              'start_time': time.time(),
              'checks_performed': 0,
              'checks_passed': 0,
              'checks_failed': 0
          }

          # CPU Count
          try:
              cpu_count = psutil.cpu_count()
              logical_cpu_count = psutil.cpu_count(logical=True)
              metrics['checks_performed'] += 1
              metrics['checks_passed'] += 1
              print(f"âœ… CPU Cores: {cpu_count} physical, {logical_cpu_count} logical")
          except Exception as e:
              metrics['checks_performed'] += 1
              metrics['checks_failed'] += 1
              print(f"âŒ CPU check failed: {e}")

          # Memory Count
          try:
              memory = psutil.virtual_memory()
              metrics['checks_performed'] += 1
              metrics['checks_passed'] += 1
              print(f"âœ… Memory: {memory.available / (1024**3):.2f} GB available of {memory.total / (1024**3):.2f} GB total")
          except Exception as e:
              metrics['checks_performed'] += 1
              metrics['checks_failed'] += 1
              print(f"âŒ Memory check failed: {e}")

          # Disk Space Count
          try:
              disk = psutil.disk_usage('/')
              metrics['checks_performed'] += 1
              metrics['checks_passed'] += 1
              print(f"âœ… Disk: {disk.free / (1024**3):.2f} GB free of {disk.total / (1024**3):.2f} GB total")
          except Exception as e:
              metrics['checks_performed'] += 1
              metrics['checks_failed'] += 1
              print(f"âŒ Disk check failed: {e}")

          # Process Count
          try:
              process_count = len(psutil.pids())
              metrics['checks_performed'] += 1
              metrics['checks_passed'] += 1
              print(f"âœ… Running processes: {process_count}")
          except Exception as e:
              metrics['checks_performed'] += 1
              metrics['checks_failed'] += 1
              print(f"âŒ Process count failed: {e}")

          # Environment Variables Count
          try:
              env_vars_count = len(os.environ)
              metrics['checks_performed'] += 1
              metrics['checks_passed'] += 1
              print(f"âœ… Environment variables: {env_vars_count}")
          except Exception as e:
              metrics['checks_performed'] += 1
              metrics['checks_failed'] += 1
              print(f"âŒ Environment count failed: {e}")

          # Calculate elapsed time
          metrics['elapsed_time'] = time.time() - metrics['start_time']
          
          print(f"\nðŸ“Š Performance Counter Summary:")
          print(f"   Total checks performed: {metrics['checks_performed']}")
          print(f"   Checks passed: {metrics['checks_passed']}")
          print(f"   Checks failed: {metrics['checks_failed']}")
          print(f"   Success rate: {(metrics['checks_passed'] / metrics['checks_performed'] * 100):.1f}%")
          print(f"   Total execution time: {metrics['elapsed_time']:.3f} seconds")

          return metrics['checks_failed'] == 0

      if __name__ == "__main__":
          success = count_performance_metrics()
          sys.exit(0 if success else 1)
      EOF

      chmod +x scripts/dependency_check.py scripts/startup_check.py scripts/validate_credentials.py scripts/performance_counter.py

      echo "ðŸ”§ Running dependency checks with counting..."
      python scripts/dependency_check.py

      echo "ðŸ”§ Running startup checks with counting..."
      python scripts/startup_check.py

      echo "ðŸ”§ Running performance counter..."
      python scripts/performance_counter.py

      echo "âœ… Build completed successfully with enhanced counting features"

    # =========================================================================
    # Start Command
    # =========================================================================
    startCommand: |
      echo "ðŸ”§ Starting Tadawul Fast Bridge v3.2.0"
      echo "ðŸŒ Environment: ${ENVIRONMENT:-production}"
      echo "ðŸ‘¥ Workers: ${WEB_CONCURRENCY:-2}"
      echo "ðŸ”— Port: $PORT"
      echo "ðŸ“Š Log Level: ${LOG_LEVEL:-info}"

      echo "ðŸ”§ Validating Google Sheets credentials with counting..."
      python scripts/validate_credentials.py || echo "âš ï¸ Credentials validation failed (continuing)"

      echo "ðŸ”§ Running startup checks with counting..."
      python scripts/startup_check.py || echo "âš ï¸ Startup checks reported issues (continuing)"

      echo "ðŸ”§ Initializing performance counter..."
      python scripts/performance_counter.py || echo "âš ï¸ Performance counter failed (continuing)"

      echo "ðŸš€ Starting FastAPI application..."
      echo "ðŸ“ˆ Application metrics will be counted and logged..."
      
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${WEB_CONCURRENCY:-2} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${LOG_LEVEL:-info} \
        --access-log \
        --loop asyncio \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30 \
        --header x-powered-by:"TadawulFastBridge/3.2.0" \
        --header x-server:"FastAPI-Uvicorn" \
        --header x-metrics:"counting-enabled" || \
      {
        echo "âš ï¸ Primary start failed, starting with single worker..."
        uvicorn main:app \
          --host 0.0.0.0 \
          --port $PORT \
          --workers 1 \
          --log-level warning \
          --access-log \
          --header x-metrics:"counting-fallback"
      }

    autoDeploy: true

    # =========================================================================
    # Health Check (Render native) - Enhanced with counting
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 45
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"
        - name: X-Health-Check
          value: "true"
        - name: X-Metrics-Count
          value: "enabled"

    # =========================================================================
    # Environment Variables (non-secret) - Updated for counting
    # =========================================================================
    envVars:
      # Core Application Configuration
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_VERSION
        value: "3.2.0"
      - key: ENVIRONMENT
        value: "production"
      - key: DEBUG
        value: "false"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # FastAPI & Server Configuration
      - key: WEB_CONCURRENCY
        value: "2"
      - key: PYTHONUNBUFFERED
        value: "true"

      # Documentation
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"

      # Security & Authentication
      - key: REQUIRE_AUTH
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "120"

      # CORS Configuration
      - key: CORS_ORIGINS
        value: '["http://localhost:3000", "https://tadawul-fast-bridge.onrender.com", "https://your-app.com"]'

      # Cache Configuration (matches main.py Settings)
      - key: CACHE_DEFAULT_TTL
        value: "1800"
      - key: CACHE_MAX_SIZE
        value: "50000"
      - key: CACHE_BACKUP_ENABLED
        value: "true"
      - key: CACHE_SAVE_INTERVAL
        value: "10"

      # Google Sheets Integration
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"

      # HTTP / Retry Configuration
      - key: HTTP_TIMEOUT
        value: "30"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.0"

      # Tadawul-Specific Settings
      - key: TADAWUL_MARKET_ENABLED
        value: "true"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "60"
      - key: TADAWUL_MAX_SYMBOLS
        value: "200"
      - key: TZ
        value: "Asia/Riyadh"

      # Logging Configuration
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_FORMAT
        value: "detailed"
      - key: LOG_ENABLE_FILE
        value: "false"

      # Counting & Metrics Configuration
      - key: ENABLE_METRICS_COUNTING
        value: "true"
      - key: METRICS_INTERVAL_SECONDS
        value: "300"
      - key: COUNT_API_REQUESTS
        value: "true"
      - key: COUNT_CACHE_HITS
        value: "true"
      - key: COUNT_ERRORS
        value: "true"
      - key: MAX_METRICS_HISTORY
        value: "1000"

    # =========================================================================
    # Secrets (managed in Render dashboard)
    # =========================================================================
    secrets:
      # Auth tokens
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: BACKUP_APP_TOKEN
        fromSecret: tadawul-backup-token

      # Google Service Account (JSON)
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

      # Financial API Keys
      - key: ALPHA_VANTAGE_API_KEY
        fromSecret: alpha-vantage-api-key
      - key: FINNHUB_API_KEY
        fromSecret: finnhub-api-key
      - key: EODHD_API_KEY
        fromSecret: eodhd-api-key
      - key: TWELVEDATA_API_KEY
        fromSecret: twelvedata-api-key
      - key: MARKETSTACK_API_KEY
        fromSecret: marketstack-api-key
      - key: FMP_API_KEY
        fromSecret: fmp-api-key

    # =========================================================================
    # Security Headers - Updated for metrics
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
      - path: "/*"
        name: "X-Powered-By"
        value: "TadawulFastBridge/3.2.0"
      - path: "/*"
        name: "X-Metrics-Enabled"
        value: "true"

    # =========================================================================
    # Scaling Configuration (free plan: single instance) - Added metrics
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70
      metrics:
        - type: cpu
          target: 70
        - type: memory
          target: 70
