# =============================================================================
# render.yaml
# =============================================================================
# TADAWUL FAST BRIDGE â€“ ENTERPRISE RENDER DEPLOYMENT BLUEPRINT (v2.5.0)
# =============================================================================
# Production-Grade Infrastructure as Code for Financial API Platform
#
# Architecture
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                    Render Platform                          â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
# â”‚  â”‚   Web API    â”‚  â”‚   Redis      â”‚  â”‚   Worker     â”‚     â”‚
# â”‚  â”‚   Service    â”‚  â”‚   (Optional) â”‚  â”‚   Service    â”‚     â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
# â”‚         â”‚                â”‚                 â”‚               â”‚
# â”‚         â–¼                â–¼                 â–¼               â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
# â”‚  â”‚         PostgreSQL (Coming Soon)                 â”‚     â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Core Capabilities
# â€¢ Multi-environment deployment (production/staging/development)
# â€¢ Auto-scaling with performance monitoring
# â€¢ Zero-downtime deployments (blue-green)
# â€¢ Integrated health checking
# â€¢ Secret management with Render
# â€¢ Custom domain support with SSL
# â€¢ CDN integration for static assets
# â€¢ Background job processing
# â€¢ Cache layer with Redis
# â€¢ Database integration ready
# â€¢ Monitoring and alerting
# â€¢ Cost optimization (free/paid hybrid)
#
# Security Features
# â€¢ All secrets synced (never committed)
# â€¢ Environment isolation
# â€¢ Rate limiting pre-configured
# â€¢ CORS properly configured
# â€¢ Security headers enabled
# â€¢ DDoS protection via Render
#
# Version: 2.5.0
# Last Updated: 2024-03-20
# =============================================================================

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================
# These apply to all services unless overridden
# =============================================================================

# Default region for all services
# Options: frankfurt, oregon, singapore, ohio, frankfurt
# frankfurt is optimal for Saudi Arabia/Middle East latency
defaultRegion: frankfurt

# Default plan for all services
# Options: free, starter, professional, pro, pro-max, pro-plus
# Using starter as base for better performance (can be overridden per service)
defaultPlan: starter

# Default environment (can be overridden per service)
# Options: production, staging, development, review
defaultEnv: production

# Default branch to deploy
branch: main

# Build filter - only deploy on changes to these paths
buildFilter:
  paths:
    - main.py
    - core/**
    - routes/**
    - schemas/**
    - scripts/**
    - integrations/**
    - requirements.txt
    - runtime.txt
    - render.yaml
  ignoredPaths:
    - tests/**
    - docs/**
    - examples/**
    - .github/**
    - .vscode/**
    - .gitignore
    - README.md

# =============================================================================
# WEB API SERVICE
# =============================================================================
services:
  # Primary FastAPI application
  - type: web
    name: tadawul-fast-bridge
    runtime: python
    region: frankfurt
    plan: starter  # Override default to starter for better performance
    branch: main
    healthCheckPath: /readyz
    healthCheckTimeout: 60
    autoDeploy: true
    pullRequestPreviewsEnabled: true  # Auto-deploy PR previews
    
    # Runtime environment
    env: python
    pythonVersion: 3.11.9
    
    # Build configuration
    buildCommand: |
      # Install system dependencies
      apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        libffi-dev \
        libssl-dev \
        curl \
        && rm -rf /var/lib/apt/lists/*
      
      # Upgrade pip and install build tools
      python -m pip install --upgrade pip setuptools wheel
      
      # Install dependencies
      pip install --no-cache-dir -r requirements.txt
      
      # Install optional performance packages if available
      pip install --no-cache-dir uvloop httptools || true
      
      # Compile Python bytecode for faster startup
      python -m compileall -q -f \
        -x "(tests|examples|docs|venv|\.git|__pycache__)" \
        .
      
      # Verify critical imports
      python -c "import sys; sys.path.insert(0, '.'); import main; print('âœ… Main imported successfully')"
      
      # Run security checks (optional, can be disabled for speed)
      if [ "${RUN_SECURITY_CHECKS:-0}" = "1" ]; then
        pip install bandit safety
        bandit -r main.py core routes -f json -o security_report.json || true
        safety check -r requirements.txt --full-report || true
      fi
      
      echo "âœ… Build completed successfully"
    
    # Start command (delegates to advanced launcher)
    startCommand: |
      # Ensure scripts are executable
      chmod +x scripts/*.sh
      
      # Run database migrations if applicable
      # python scripts/migrate.py || true
      
      # Start the application
      exec scripts/start_web.sh
    
    # Scaling configuration
    scaling:
      # Minimum number of instances
      minInstances: 1
      # Maximum number of instances (auto-scaling)
      maxInstances: 3
      # Target memory usage for scaling (percentage)
      targetMemoryPercent: 75
      # Target concurrent requests per instance
      targetConcurrentRequests: 50
    
    # Resource limits
    resources:
      memory: 2GB  # 2GB RAM for starter plan
      cpu: 1       # 1 vCPU
    
    # Health check configuration
    healthCheck:
      path: /readyz
      timeout: 60
      interval: 30
      retries: 3
      successThreshold: 1
      failureThreshold: 3
    
    # Custom domain configuration
    domains:
      - api.tadawulfb.com
      - api.tadawulfastbridge.com
    
    # Headers for all responses (adds security headers)
    headers:
      - key: X-Content-Type-Options
        value: nosniff
      - key: X-Frame-Options
        value: DENY
      - key: X-XSS-Protection
        value: 1; mode=block
      - key: Referrer-Policy
        value: strict-origin-when-cross-origin
      - key: Strict-Transport-Security
        value: max-age=31536000; includeSubDomains; preload

# =============================================================================
# BACKGROUND WORKER SERVICE
# =============================================================================
  # Dedicated worker for background tasks
  - type: worker
    name: tadawul-worker
    runtime: python
    region: frankfurt
    plan: starter
    branch: main
    autoDeploy: true
    
    pythonVersion: 3.11.9
    
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      python -m compileall -q main.py core scripts
    
    startCommand: |
      python scripts/worker.py  # Runs background tasks
    
    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 70
    
    resources:
      memory: 1GB
      cpu: 0.5

# =============================================================================
# REDIS SERVICE (OPTIONAL - FOR PRODUCTION)
# =============================================================================
  # Redis for caching, rate limiting, and pub/sub
  - type: redis
    name: tadawul-redis
    region: frankfurt
    plan: free  # Use 'starter' for production
    ipAllowList:
      - source: 0.0.0.0/0
        description: Allow all internal services
    
    maxmemoryPolicy: allkeys-lru  # Evict least recently used keys

# =============================================================================
# STATIC SITE (OPTIONAL - FOR DOCS)
# =============================================================================
  # Documentation site
  - type: static
    name: tadawul-docs
    region: frankfurt
    plan: free
    branch: main
    buildCommand: |
      # Build documentation (if using MkDocs)
      # pip install mkdocs mkdocs-material
      # mkdocs build -d public
      mkdir -p public
      cp -r docs/* public/ || true
      echo "Documentation site" > public/index.html
    
    publishPath: public
    
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
envVarGroups:
  # ===========================================================================
  # CORE RUNTIME CONFIGURATION
  # ===========================================================================
  - name: tfb-core
    envVars:
      # Python runtime
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONDONTWRITEBYTECODE
        value: "1"
      - key: PYTHONFAULTHANDLER
        value: "1"
      - key: PYTHONHASHSEED
        value: "random"
      
      # Timezone (Riyadh)
      - key: TZ
        value: "Asia/Riyadh"
      - key: TIMEZONE_DEFAULT
        value: "Asia/Riyadh"
      - key: APP_TIMEZONE
        value: "Asia/Riyadh"
      
      # Service identity
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_TITLE
        value: "Tadawul Fast Bridge API"
      - key: SERVICE_NAME
        value: "tadawul-fast-bridge"
      - key: APP_ENV
        value: "production"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_VERSION
        value: "7.5.0"
      - key: SERVICE_VERSION
        value: "7.5.0"
      
      # Build info
      - key: BUILD_DATE
        value: "2024-03-20"
      - key: GIT_COMMIT
        fromService: GIT_COMMIT
      - key: RENDER_GIT_COMMIT
        fromService: RENDER_GIT_COMMIT
      - key: RENDER_INSTANCE_ID
        fromService: RENDER_INSTANCE_ID

  # ===========================================================================
  # LOGGING & OBSERVABILITY
  # ===========================================================================
  - name: tfb-logging
    envVars:
      # Log levels (DEBUG, INFO, WARNING, ERROR, CRITICAL)
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_JSON
        value: "1"
      - key: LOG_FORMAT
        value: "detailed"
      - key: LOG_DATEFMT
        value: "%Y-%m-%d %H:%M:%S"
      
      # Access logs
      - key: UVICORN_ACCESS_LOG
        value: "1"
      - key: GUNICORN_ACCESS_LOG
        value: "1"
      
      # Log file (optional)
      - key: LOG_FILE
        value: "/var/log/app.log"
      - key: LOG_MAX_BYTES
        value: "104857600"  # 100MB
      - key: LOG_BACKUP_COUNT
        value: "10"
      
      # Debug flags
      - key: DEBUG
        value: "0"
      - key: DEBUG_ERRORS
        value: "0"

  # ===========================================================================
  # WEB SERVER CONFIGURATION
  # ===========================================================================
  - name: tfb-server
    envVars:
      # Port (Render sets PORT automatically)
      - key: PORT
        fromService: PORT
      - key: HOST
        value: "0.0.0.0"
      
      # Worker configuration
      - key: WORKERS
        value: "2"
      - key: WEB_CONCURRENCY
        value: "2"
      - key: WEB_CONCURRENCY_MAX
        value: "8"
      - key: WORKER_CLASS
        value: "uvicorn.workers.UvicornWorker"
      - key: WORKER_CONNECTIONS
        value: "1000"
      - key: WORKER_MAX_REQUESTS
        value: "1000"
      - key: WORKER_MAX_REQUESTS_JITTER
        value: "200"
      
      # Timeouts
      - key: TIMEOUT_KEEP_ALIVE
        value: "65"
      - key: TIMEOUT_GRACEFUL
        value: "30"
      - key: TIMEOUT_REQUEST
        value: "60"
      - key: TIMEOUT_STARTUP
        value: "30"
      - key: TIMEOUT_SHUTDOWN
        value: "30"
      
      # Backlog
      - key: BACKLOG
        value: "2048"
      
      # Uvicorn specific
      - key: UVICORN_KEEPALIVE
        value: "65"
      - key: UVICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: UVICORN_ACCESS_LOG
        value: "1"
      - key: UVICORN_LIMIT_CONCURRENCY
        value: "0"
      - key: UVICORN_LIMIT_MAX_REQUESTS
        value: "0"
      - key: UVICORN_BACKLOG
        value: "2048"
      - key: UVICORN_ROOT_PATH
        value: ""

  # ===========================================================================
  # BOOT & ROUTER CONFIGURATION
  # ===========================================================================
  - name: tfb-boot
    envVars:
      # Router mounting (0 = mount at boot, 1 = lazy mount)
      - key: DEFER_ROUTER_MOUNT
        value: "0"
      
      # Engine initialization
      - key: INIT_ENGINE_ON_BOOT
        value: "1"
      - key: ENGINE_REQUIRED_FOR_READYZ
        value: "0"
      
      # Swagger/Redoc
      - key: ENABLE_SWAGGER
        value: "1"
      - key: ENABLE_REDOC
        value: "1"

  # ===========================================================================
  # SECURITY & AUTHENTICATION
  # ===========================================================================
  - name: tfb-security
    envVars:
      # Authentication
      - key: REQUIRE_AUTH
        value: "1"
      - key: AUTH_HEADER_NAME
        value: "X-APP-TOKEN"
      - key: ALLOW_QUERY_TOKEN
        value: "0"
      - key: OPEN_MODE
        value: "0"
      
      # Rate limiting
      - key: ENABLE_RATE_LIMITING
        value: "1"
      - key: RATE_LIMIT_ENABLED
        value: "1"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"
      - key: RATE_LIMIT_STRATEGY
        value: "fixed-window"
      - key: RATE_LIMIT_BACKEND
        value: "memory"
      
      # CORS
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "0"
      - key: CORS_ALL_ORIGINS
        value: "0"
      - key: CORS_ORIGINS
        value: "https://app.tadawulfb.com,https://tadawulfb.com"
      
      # Host filtering (production only)
      - key: ALLOWED_HOSTS
        value: "api.tadawulfb.com,api.tadawulfastbridge.com,localhost"
      
      # Secrets (to be set in Render dashboard)
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false

  # ===========================================================================
  # FEATURE FLAGS
  # ===========================================================================
  - name: tfb-features
    envVars:
      # Core features
      - key: ADVISOR_ENABLED
        value: "1"
      - key: AI_ANALYSIS_ENABLED
        value: "1"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "1"
      
      # Advanced features
      - key: ADVANCED_ENABLED
        value: "1"
      - key: METRICS_ENABLED
        value: "1"
      - key: TRACING_ENABLED
        value: "0"
      - key: PROFILING_ENABLED
        value: "0"
      - key: CACHE_ENABLED
        value: "1"
      - key: CIRCUIT_BREAKER_ENABLED
        value: "1"
      
      # Chaos engineering (disabled by default)
      - key: CHAOS_ENABLED
        value: "0"
      - key: CHAOS_FAILURE_RATE
        value: "0"
      - key: CHAOS_LATENCY_MS
        value: "0"

  # ===========================================================================
  # DATA PROVIDERS
  # ===========================================================================
  - name: tfb-providers
    envVars:
      # Provider lists
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub,alphavantage,fmp"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam,tadawul,saudi_exchange"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      - key: KSA_DISALLOW_EODHD
        value: "1"
      
      # KSA provider flags
      - key: ENABLE_YAHOO_CHART_KSA
        value: "1"
      - key: ENABLE_YFINANCE_KSA
        value: "1"
      - key: ENABLE_YAHOO_FUNDAMENTALS_KSA
        value: "1"
      - key: ENABLE_YAHOO_CHART_SUPPLEMENT
        value: "1"
      
      # API Keys (set in dashboard)
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: FMP_API_KEY
        sync: false
      - key: TWELVEDATA_API_KEY
        sync: false
      - key: MARKETSTACK_API_KEY
        sync: false
      - key: POLYGON_API_KEY
        sync: false
      - key: IEXCLOUD_API_KEY
        sync: false
      
      # Argaam
      - key: ARGAAM_API_KEY
        sync: false
      - key: ARGAAM_QUOTE_URL
        sync: false
      - key: ARGAAM_PROFILE_URL
        sync: false
      
      # Tadawul
      - key: TADAWUL_QUOTE_URL
        sync: false
      - key: TADAWUL_FUNDAMENTALS_URL
        sync: false
      - key: TADAWUL_MARKET_ENABLED
        value: "1"
      - key: TADAWUL_MAX_SYMBOLS
        value: "2500"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "120"
      
      # Base URLs
      - key: EODHD_BASE_URL
        value: "https://eodhd.com/api"
      - key: FMP_BASE_URL
        value: "https://financialmodelingprep.com/api/v3"

  # ===========================================================================
  # PERFORMANCE TUNING
  # ===========================================================================
  - name: tfb-performance
    envVars:
      # HTTP timeouts
      - key: HTTP_TIMEOUT_SEC
        value: "45"
      - key: HTTP_TIMEOUT
        value: "45"
      
      # Retries
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.5"
      
      # Batch sizes
      - key: AI_BATCH_SIZE
        value: "25"
      - key: AI_MAX_TICKERS
        value: "800"
      - key: AI_BATCH_CONCURRENCY
        value: "8"
      - key: ADV_BATCH_SIZE
        value: "25"
      - key: ADV_BATCH_CONCURRENCY
        value: "8"
      - key: QUOTE_BATCH_SIZE
        value: "50"
      - key: BATCH_CONCURRENCY
        value: "8"
      
      # Concurrency limits
      - key: LIMIT_CONCURRENCY
        value: "100"
      - key: LIMIT_MAX_REQUESTS
        value: "1000"

  # ===========================================================================
  # CACHE CONFIGURATION
  # ===========================================================================
  - name: tfb-cache
    envVars:
      # Cache backend (memory, redis)
      - key: CACHE_BACKEND
        value: "memory"
      - key: CACHE_TTL_SEC
        value: "300"
      - key: CACHE_DEFAULT_TTL
        value: "20"
      - key: CACHE_MAX_SIZE
        value: "10000"
      - key: CACHE_SAVE_INTERVAL
        value: "60"
      - key: CACHE_BACKUP_ENABLED
        value: "1"
      
      # Redis (if using)
      - key: REDIS_URL
        fromService:
          name: tadawul-redis
          type: redis
          property: connectionString

  # ===========================================================================
  # GOOGLE SHEETS INTEGRATION
  # ===========================================================================
  - name: tfb-sheets
    envVars:
      # Credentials (set in dashboard)
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: GOOGLE_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false
      - key: SPREADSHEET_ID
        sync: false
      - key: GOOGLE_SHEETS_ID
        sync: false
      
      # Apps Script
      - key: GOOGLE_APPS_SCRIPT_URL
        sync: false
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        sync: false
      
      # Safety flags
      - key: SHEETS_SAFE_MODE
        value: "1"
      - key: SHEETS_BLOCK_ON_EMPTY_ROWS
        value: "0"
      
      # Row standards
      - key: TFB_SYMBOL_HEADER_ROW
        value: "5"
      - key: TFB_SYMBOL_START_ROW
        value: "6"

  # ===========================================================================
  # MONITORING & ALERTING
  # ===========================================================================
  - name: tfb-monitoring
    envVars:
      # Metrics
      - key: METRICS_PORT
        value: "9090"
      - key: ENABLE_METRICS
        value: "1"
      - key: PROMETHEUS_MULTIPROC_DIR
        value: "/tmp/prometheus"
      - key: PROMETHEUS_NAMESPACE
        value: "tfb"
      
      # Health checks
      - key: HEALTH_CHECK_PATH
        value: "/health"
      - key: HEALTH_CHECK_INTERVAL
        value: "30"
      - key: HEALTH_CHECK_TIMEOUT
        value: "5"
      
      # Sentry (error tracking)
      - key: SENTRY_DSN
        sync: false
      - key: SENTRY_TRACES_SAMPLE_RATE
        value: "0.1"
      
      # Datadog
      - key: DATADOG_API_KEY
        sync: false
      - key: DATADOG_APP_KEY
        sync: false
      
      # New Relic
      - key: NEWRELIC_LICENSE_KEY
        sync: false
      - key: NEWRELIC_APP_NAME
        value: "tadawul-fast-bridge"
      
      # OpenTelemetry
      - key: ENABLE_TRACING
        value: "0"
      - key: TRACING_SAMPLE_RATE
        value: "0.1"
      - key: TRACING_EXPORTER
        value: "console"
      - key: OTLP_ENDPOINT
        sync: false

  # ===========================================================================
  # RESOURCE MANAGEMENT
  # ===========================================================================
  - name: tfb-resources
    envVars:
      # Memory management
      - key: GC_PRESSURE_MB
        value: "420"
      - key: GC_COOLDOWN_SEC
        value: "60"
      
      # Degraded mode thresholds
      - key: DEGRADED_ENTER_LAG_MS
        value: "500"
      - key: DEGRADED_EXIT_LAG_MS
        value: "150"
      - key: DEGRADED_SHED_ENABLED
        value: "1"
      - key: DEGRADED_SHED_PATHS
        value: "/v1/analysis,/v1/advanced,/v1/advisor,/v1/compute"
      
      # Memory thresholds
      - key: MEMORY_WARNING_PERCENT
        value: "0.8"
      - key: MEMORY_CRITICAL_PERCENT
        value: "0.95"
      - key: MAX_FD_LIMIT
        value: "65536"

  # ===========================================================================
  # DATABASE CONFIGURATION (POSTGRESQL)
  # ===========================================================================
  # Uncomment when database is added
  # - name: tfb-database
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: tadawul-db
  #         property: connectionString
  #     - key: DATABASE_POOL_SIZE
  #       value: "20"
  #     - key: DATABASE_MAX_OVERFLOW
  #       value: "10"
  #     - key: DATABASE_POOL_TIMEOUT
  #       value: "30"
  #     - key: DATABASE_POOL_RECYCLE
  #       value: "3600"
  #     - key: DATABASE_ECHO
  #       value: "0"

  # ===========================================================================
  # A/B TESTING & FEATURE FLAGS
  # ===========================================================================
  - name: tfb-experiments
    envVars:
      # A/B testing
      - key: AB_TESTING_ENABLED
        value: "0"
      - key: AB_TESTING_CONFIG_PATH
        value: "config/ab_tests.yaml"
      
      # Feature flags
      - key: FEATURE_FLAGS_PATH
        value: "config/features.yaml"
      - key: FEATURE_FLAGS_REFRESH_SEC
        value: "60"

  # ===========================================================================
  # WEBSOCKET CONFIGURATION
  # ===========================================================================
  - name: tfb-websocket
    envVars:
      - key: WEBSOCKET_MAX_SIZE
        value: "1048576"  # 1MB
      - key: WEBSOCKET_MAX_QUEUE
        value: "32"
      - key: WEBSOCKET_PING_INTERVAL
        value: "20"
      - key: WEBSOCKET_PING_TIMEOUT
        value: "30"

  # ===========================================================================
  # RENDER-SPECIFIC
  # ===========================================================================
  - name: tfb-render
    envVars:
      - key: RENDER
        value: "1"
      - key: RENDER_SERVICE_NAME
        fromService:
          name: tadawul-fast-bridge
          type: web
          property: serviceName
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: tadawul-fast-bridge
          type: web
          property: hostname
      - key: RENDER_API_KEY
        sync: false
      - key: RENDER_SERVICE_ID
        sync: false

# =============================================================================
# NOTIFICATIONS
# =============================================================================
notification:
  email:
    - admin@tadawulfb.com
  slack:
    - webhookUrl: https://hooks.slack.com/services/...  # Set in dashboard
      channel: "#deployments"
      events:
        - deploy_success
        - deploy_failure
        - health_alert
        - scaling_event

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================
environments:
  # Production environment
  - name: production
    envVars:
      - key: LOG_LEVEL
        value: "INFO"
      - key: LOG_JSON
        value: "1"
      - key: WORKERS
        value: "4"
      - key: WEB_CONCURRENCY
        value: "4"
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "0"
      - key: CORS_ORIGINS
        value: "https://app.tadawulfb.com,https://tadawulfb.com"
    
    services:
      - name: tadawul-fast-bridge
        plan: starter
        scaling:
          minInstances: 2
          maxInstances: 5
  
  # Staging environment
  - name: staging
    envVars:
      - key: LOG_LEVEL
        value: "DEBUG"
      - key: LOG_JSON
        value: "0"
      - key: WORKERS
        value: "2"
      - key: WEB_CONCURRENCY
        value: "2"
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "1"
      - key: CORS_ORIGINS
        value: "*"
      - key: DEFER_ROUTER_MOUNT
        value: "1"
    
    services:
      - name: tadawul-fast-bridge
        plan: starter
        scaling:
          minInstances: 1
          maxInstances: 2
  
  # Development environment (for PR previews)
  - name: development
    envVars:
      - key: LOG_LEVEL
        value: "DEBUG"
      - key: LOG_JSON
        value: "0"
      - key: WORKERS
        value: "1"
      - key: WEB_CONCURRENCY
        value: "1"
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "1"
      - key: CORS_ORIGINS
        value: "*"
      - key: DEFER_ROUTER_MOUNT
        value: "1"
      - key: INIT_ENGINE_ON_BOOT
        value: "0"
    
    services:
      - name: tadawul-fast-bridge
        plan: free
        scaling:
          minInstances: 1
          maxInstances: 1

# =============================================================================
# BACKGROUND JOBS
# =============================================================================
cronJobs:
  # Daily cache cleanup
  - name: cache-cleanup
    schedule: "0 3 * * *"  # 3 AM daily
    command: python scripts/cleanup_cache.py
  
  # Performance report generation
  - name: performance-report
    schedule: "0 1 * * 0"  # 1 AM Sunday
    command: python scripts/generate_report.py
  
  # Data refresh
  - name: refresh-provider-data
    schedule: "*/30 * * * *"  # Every 30 minutes
    command: python scripts/refresh_data.py

# =============================================================================
# MAINTENANCE PAGES
# =============================================================================
maintenance:
  path: /maintenance
  statusCode: 503
  body: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>Maintenance - Tadawul Fast Bridge</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #2c3e50; }
            .message { color: #34495e; margin: 20px 0; }
        </style>
    </head>
    <body>
        <h1>ðŸ”„ System Maintenance</h1>
        <div class="message">We're performing scheduled maintenance. Please check back shortly.</div>
        <div>Riyadh Time: {{ .now | date "2006-01-02 15:04:05" }}</div>
    </body>
    </html>

# =============================================================================
# BACKUP CONFIGURATION (for databases)
# =============================================================================
# Uncomment when database is added
# backup:
#   schedule: "0 2 * * *"  # 2 AM daily
#   retention: 7  # Keep for 7 days
#   databases:
#     - name: tadawul-db
#       excludeTables:
#         - temp_data
#         - cache

# =============================================================================
# SECURITY SCANNING
# =============================================================================
security:
  # Enable automatic security scanning
  vulnerabilityScanning: true
  
  # Dependency scanning
  dependencyScanning:
    enabled: true
    schedule: "0 0 * * *"  # Daily
  
  # Container scanning
  containerScanning:
    enabled: true
    schedule: "0 0 * * 0"  # Weekly

# =============================================================================
# COMPLIANCE
# =============================================================================
compliance:
  # GDPR compliance
  gdpr:
    enabled: true
    dataRetentionDays: 30
  
  # SOC2 compliance
  soc2:
    enabled: true
    auditLogging: true

# =============================================================================
# METADATA
# =============================================================================
version: 2.5.0
lastUpdated: 2024-03-20
author: Tadawul Fast Bridge Team
repository: https://github.com/tadawul-fast-bridge/api
documentation: https://docs.tadawulfb.com
