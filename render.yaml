# =============================================================================
# Tadawul Fast Bridge - Enhanced Render Deployment Configuration
# Version: 3.1.0 | Python: 3.11.9 | Environment: Production
# =============================================================================

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    # =========================================================================
    # Enhanced Build Configuration with Fixes
    # =========================================================================
    buildCommand: |
      echo "ðŸš€ Building Tadawul Fast Bridge v3.1.0..."
      echo "ðŸ Python 3.11.9 | FastAPI | Production"
      echo "ðŸ”§ Fixing Google Sheets compatibility issues..."
      
      # Upgrade pip and install dependencies
      pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt
      
      # Create necessary directories
      mkdir -p logs cache_backups scripts static
      echo "âœ… Project structure created"
      
      # Create enhanced dependency validation script
      cat > scripts/dependency_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Enhanced Dependency Validation with Google Sheets Compatibility Check
      """
      import sys
      import platform
      import json
      
      def check_dependencies():
          print(f'ðŸ Python {sys.version}')
          print(f'ðŸ’» Platform: {platform.system()} {platform.release()}')
          
          # Core package checks with version validation
          required_packages = [
              ('fastapi', '0.104.1'),
              ('uvicorn', '0.24.0'),
              ('gspread', '5.12.4'),  # Compatible version
              ('google.auth', None),
              ('pandas', '2.1.4'),
              ('aiohttp', '3.8.6'),
              ('pydantic', '2.5.3'),
              ('pydantic_settings', '2.1.0')
          ]
          
          missing = []
          version_mismatch = []
          
          for package, expected_version in required_packages:
              try:
                  module = __import__(package.replace('-', '_').split('.')[0])
                  version = getattr(module, '__version__', 'unknown')
                  
                  if expected_version and version != expected_version:
                      version_mismatch.append(f'{package} (expected: {expected_version}, got: {version})')
                      print(f'âš ï¸  {package}: {version} (version mismatch)')
                  else:
                      print(f'âœ… {package}: {version}')
                      
              except ImportError as e:
                  missing.append(package)
                  print(f'âŒ {package}: MISSING - {e}')
          
          # Check for gspread APIError compatibility
          try:
              from gspread.exceptions import APIError, SpreadsheetNotFound
              print("âœ… gspread exceptions: APIError, SpreadsheetNotFound available")
          except ImportError:
              try:
                  from gspread import APIError, SpreadsheetNotFound
                  print("âœ… gspread exceptions: APIError, SpreadsheetNotFound available (legacy)")
              except ImportError:
                  print("âŒ gspread exceptions: APIError not available")
                  missing.append('gspread-APIError')
          
          if missing or version_mismatch:
              if missing:
                  print(f'ðŸš¨ Missing packages: {missing}')
              if version_mismatch:
                  print(f'ðŸš¨ Version mismatches: {version_mismatch}')
              return False
          else:
              print('âœ… All core dependencies verified and compatible')
              return True
      
      if __name__ == "__main__":
          success = check_dependencies()
          sys.exit(0 if success else 1)
      EOF
      
      # Create Google Sheets credentials validator
      cat > scripts/validate_credentials.py << 'EOF'
      #!/usr/bin/env python3
      """
      Google Sheets Credentials Validation Script
      """
      import os
      import json
      import sys
      
      def validate_google_credentials():
          credentials_str = os.getenv('GOOGLE_SHEETS_CREDENTIALS')
          if not credentials_str:
              print("âŒ GOOGLE_SHEETS_CREDENTIALS environment variable is not set")
              return False
          
          try:
              credentials = json.loads(credentials_str)
              print("âœ… Google Sheets credentials JSON format is valid")
              
              # Check required fields
              required_fields = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email']
              missing_fields = [field for field in required_fields if field not in credentials]
              
              if missing_fields:
                  print(f"âŒ Missing required fields: {missing_fields}")
                  return False
              
              # Validate private key format
              private_key = credentials.get('private_key', '')
              if not private_key.startswith('-----BEGIN PRIVATE KEY-----'):
                  print("âŒ Private key format invalid - must start with '-----BEGIN PRIVATE KEY-----'")
                  return False
              
              if '-----END PRIVATE KEY-----' not in private_key:
                  print("âŒ Private key format invalid - must end with '-----END PRIVATE KEY-----'")
                  return False
              
              print("âœ… Private key format is valid")
              print(f"âœ… Service account: {credentials.get('client_email')}")
              return True
              
          except json.JSONDecodeError as e:
              print(f"âŒ Invalid JSON in GOOGLE_SHEETS_CREDENTIALS: {e}")
              return False
          except Exception as e:
              print(f"âŒ Error validating credentials: {e}")
              return False
      
      if __name__ == "__main__":
          success = validate_google_credentials()
          sys.exit(0 if success else 1)
      EOF
      
      # Create enhanced startup health check
      cat > scripts/startup_check.py << 'EOF'
      #!/usr/bin/env python3
      """
      Enhanced Startup Health Check for Tadawul Fast Bridge
      """
      import os
      import sys
      
      def check_environment():
          required_vars = ['SPREADSHEET_ID', 'GOOGLE_APPS_SCRIPT_URL']
          optional_vars = ['GOOGLE_SHEETS_CREDENTIALS', 'APP_TOKEN']
          
          missing = [var for var in required_vars if not os.getenv(var)]
          missing_optional = [var for var in optional_vars if not os.getenv(var)]
          
          if missing:
              print(f"âŒ Missing required environment variables: {missing}")
              return False
          
          if missing_optional:
              print(f"âš ï¸  Missing optional environment variables: {missing_optional}")
          else:
              print("âœ… All environment variables check passed")
          
          return True
      
      if __name__ == "__main__":
          success = check_environment()
          sys.exit(0 if success else 1)
      EOF
      
      # Run validation scripts
      echo "ðŸ”§ Running dependency checks..."
      python scripts/dependency_check.py
      
      echo "ðŸ”§ Running environment checks..."
      python scripts/startup_check.py
      
      echo "âœ… Build completed successfully with all fixes"

    # =========================================================================
    # Enhanced Start Command with Error Handling
    # =========================================================================
    startCommand: |
      echo "ðŸ”§ Starting Tadawul Fast Bridge v3.1.0"
      echo "ðŸŒ Environment: ${ENVIRONMENT:-production}"
      echo "ðŸ‘¥ Workers: ${WEB_CONCURRENCY:-2}"
      echo "ðŸ”— Port: $PORT"
      echo "ðŸ“Š Log Level: ${LOG_LEVEL:-info}"
      
      # Validate Google Sheets credentials format
      echo "ðŸ”§ Validating Google Sheets credentials..."
      python scripts/validate_credentials.py
      
      # Run startup checks
      echo "ðŸ”§ Running startup checks..."
      python scripts/startup_check.py
      
      # Start the application with enhanced configuration and fallback
      echo "ðŸš€ Starting FastAPI application..."
      uvicorn main:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers ${WEB_CONCURRENCY:-2} \
        --proxy-headers \
        --forwarded-allow-ips="*" \
        --log-level ${LOG_LEVEL:-info} \
        --access-log \
        --loop asyncio \
        --timeout-keep-alive 60 \
        --timeout-graceful-shutdown 30 \
        --header x-powered-by:"TadawulFastBridge/3.1.0" \
        --header x-server:"FastAPI-Uvicorn" || \
      
      {
        echo "âš ï¸  Primary start failed, starting with single worker..."
        uvicorn main:app \
          --host 0.0.0.0 \
          --port $PORT \
          --workers 1 \
          --log-level warning \
          --access-log
      }

    autoDeploy: true
    
    # =========================================================================
    # Enhanced Health Check Configuration
    # =========================================================================
    healthCheckPath: /health
    healthCheckTimeout: 25
    healthCheckInterval: 60
    initialDelay: 45  # Increased for Google Sheets initialization

    # =========================================================================
    # Optimized Environment Variables
    # =========================================================================
    envVars:
      # === Core Application Configuration ===
      - key: SERVICE_NAME
        value: "Tadawul Fast Bridge"
      - key: SERVICE_VERSION
        value: "3.1.0"
      - key: ENVIRONMENT
        value: "production"
      - key: APP_HOST
        value: "0.0.0.0"
      - key: APP_PORT
        value: "8000"

      # === FastAPI & Server Configuration ===
      - key: WEB_CONCURRENCY
        value: "2"
      - key: LOG_LEVEL
        value: "INFO"
      - key: ENABLE_SWAGGER
        value: "true"
      - key: ENABLE_REDOC
        value: "true"
      - key: PYTHONUNBUFFERED
        value: "true"

      # === Security & Authentication ===
      - key: REQUIRE_AUTH
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: RATE_LIMIT_REQUESTS_PER_MINUTE
        value: "120"

      # === CORS Configuration ===
      - key: CORS_ORIGINS
        value: '["http://localhost:3000", "https://tadawul-fast-1.onrender.com", "https://your-app.com"]'

      # === Cache Configuration ===
      - key: CACHE_DEFAULT_TTL
        value: "1800"
      - key: CACHE_MAX_SIZE
        value: "50000"
      - key: CACHE_BACKUP_ENABLED
        value: "true"
      - key: CACHE_CLEANUP_INTERVAL
        value: "300"

      # === Google Sheets Integration ===
      - key: SPREADSHEET_ID
        value: "19oloY3fehdFnSRMysqd-EZ2l7FL-GRAd8GJhYUt8tmw"
      - key: GOOGLE_APPS_SCRIPT_URL
        value: "https://script.google.com/macros/s/AKfycbwnIX0hIaffDJVnHZUxej4zoLPQZgpdMMpkA9YP1xPQVxqwvEAXuIHWcF7qBIVsntnLkg/exec"
      - key: GOOGLE_APPS_SCRIPT_BACKUP_URL
        value: "https://script.google.com/macros/s/AKfycbyI7a_xj7zvCa10CnzJP9wf8N1qPG3DYYb-LVkUCOEVEHjALzZq_Ox9YUJgbkzq86py6g/exec"

      # === Performance & HTTP Configuration ===
      - key: HTTP_TIMEOUT
        value: "30"
      - key: MAX_RETRIES
        value: "3"
      - key: RETRY_DELAY
        value: "1.0"
      - key: CONNECTION_POOL_SIZE
        value: "100"

      # === Tadawul-Specific Settings ===
      - key: TADAWUL_MARKET_ENABLED
        value: "true"
      - key: TADAWUL_REFRESH_INTERVAL
        value: "60"
      - key: TADAWUL_MAX_SYMBOLS
        value: "200"
      - key: TZ
        value: "Asia/Riyadh"

      # === Monitoring & Health ===
      - key: HEALTH_CHECK_INTERVAL
        value: "30"
      - key: HEALTH_MONITOR_TIMEOUT
        value: "10"
      - key: ENABLE_HEALTH_MONITOR
        value: "true"

      # === Feature Flags with Fallbacks ===
      - key: ENABLE_CACHE_WORKER
        value: "true"
      - key: ENABLE_BACKUP_SCHEDULER
        value: "true"
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      - key: ENABLE_MULTI_SOURCE_DATA
        value: "true"
      - key: GOOGLE_SHEETS_FALLBACK_ENABLED
        value: "true"  # New: Allow fallback if Google Sheets fails

      # === Logging Configuration ===
      - key: LOG_ENABLE_FILE
        value: "false"
      - key: LOG_FORMAT
        value: "detailed"
      - key: LOG_RETENTION_DAYS
        value: "7"

    # =========================================================================
    # Secrets Management
    # =========================================================================
    secrets:
      # Authentication Tokens
      - key: APP_TOKEN
        fromSecret: tadawul-app-token
      - key: BACKUP_APP_TOKEN
        fromSecret: tadawul-backup-token

      # Google Services - Use GOOGLE_SHEETS_CREDENTIALS to match our AppConfig
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

      # Optional Financial APIs
      - key: ALPHA_VANTAGE_API_KEY
        fromSecret: alpha-vantage-api-key
      - key: FINNHUB_API_KEY
        fromSecret: finnhub-api-key
      - key: EODHD_API_KEY
        fromSecret: eodhd-api-key
      - key: TWELVEDATA_API_KEY
        fromSecret: twelvedata-api-key
      - key: MARKETSTACK_API_KEY
        fromSecret: marketstack-api-key
      - key: FMP_API_KEY
        fromSecret: fmp-api-key

    # =========================================================================
    # Enhanced Health Check Configuration
    # =========================================================================
    healthCheck:
      path: /health
      initialDelay: 45  # Increased for Google Sheets init
      period: 60
      timeout: 25
      successThreshold: 1
      failureThreshold: 3
      headers:
        - name: User-Agent
          value: "Render-Health-Check/1.0"
        - name: X-Health-Check
          value: "true"

    # =========================================================================
    # Security Headers
    # =========================================================================
    headers:
      - path: "/*"
        name: "X-Frame-Options"
        value: "DENY"
      - path: "/*"
        name: "X-Content-Type-Options"
        value: "nosniff"
      - path: "/*"
        name: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - path: "/*"
        name: "X-XSS-Protection"
        value: "1; mode=block"
      - path: "/health"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
      - path: "/*"
        name: "X-Powered-By"
        value: "TadawulFastBridge/3.1.0"

    # =========================================================================
    # Scaling Configuration
    # =========================================================================
    scaling:
      minInstances: 1
      maxInstances: 1
      targetMemoryPercent: 70
      targetCPUPercent: 70

# =============================================================================
# Background Worker Services (Optional - Comment out if not needed)
# =============================================================================
  - type: worker
    name: tadawul-cache-worker
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      python scripts/dependency_check.py
    
    startCommand: |
      echo "ðŸ”§ Starting Cache Worker with fallback..."
      python scripts/cache_manager.py --mode worker --cleanup-interval 300 || \
      echo "âš ï¸ Cache worker failed, continuing without cache management"
    
    envVars:
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"
      - key: ENABLE_GOOGLE_SHEETS_FALLBACK
        value: "true"

    secrets:
      - key: GOOGLE_SHEETS_CREDENTIALS
        fromSecret: google-sheets-credentials-json

# =============================================================================
# Health Monitoring Worker (Optional)
# =============================================================================
  - type: worker
    name: tadawul-health-monitor
    env: python
    plan: free
    region: oregon
    runtime:
      pythonVersion: "3.11.9"
    
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    
    startCommand: |
      echo "ðŸ”§ Starting Health Monitor..."
      python scripts/health_monitor.py \
        --api-url https://tadawul-fast-bridge.onrender.com \
        --interval 30 \
        --timeout 10 \
        --retries 3
    
    envVars:
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"
      - key: HEALTH_MONITOR_ENABLED
        value: "true"

# =============================================================================
# Cron Jobs for Maintenance (Optional)
# =============================================================================
jobs:
  - name: health-monitoring
    plan: free
    schedule: "*/15 * * * *"
    command: |
      echo "ðŸ¥ Running scheduled health check..."
      curl -f -H "X-Health-Check: true" \
        --retry 2 --retry-delay 5 \
        "https://tadawul-fast-bridge.onrender.com/health" || \
      echo "âš ï¸ Health check failed"
    
    envVars:
      - key: ENVIRONMENT
        value: production

  - name: cache-cleanup
    plan: free
    schedule: "0 2 * * *"  # Daily at 2 AM
    command: |
      echo "ðŸ§¹ Running cache cleanup..."
      curl -X POST -H "Authorization: Bearer $APP_TOKEN" \
        --retry 2 \
        "https://tadawul-fast-bridge.onrender.com/v1/cache/cleanup" || \
      echo "âš ï¸ Cache cleanup failed"
    
    envVars:
      - key: ENVIRONMENT
        value: production
    secrets:
      - key: APP_TOKEN
        fromSecret: tadawul-app-token

# =============================================================================
# Database & Persistent Storage (If needed)
# =============================================================================
databases:
  - name: tadawul-cache-db
    plan: free
    region: oregon
    ipAllowList: []
    # Uncomment if you need persistent database storage
    # databaseName: tadawul_cache
    # user: tadawul_user
