# ============================================================
# Tadawul Fast Bridge (FastAPI) â€” Render Blueprint
# EDITION: Advanced Production (v1.4.0)
# ============================================================
#
# Key Features:
# - Auto-Scaling: Uses start_web.sh for CPU-aware worker tuning.
# - High Performance: Optimized Uvicorn settings (keep-alive, backlog).
# - Full Coverage: Maps all v12.2 Financial Leader env vars.
# - Localization: Enforces Asia/Riyadh timezone.
#
# Notes:
# - Secrets (API Keys, Google Creds) must be set in the Render Dashboard.
# - Do NOT commit actual keys here; use 'sync: false' placeholder.

services:
  - type: web
    name: tadawul-fast-bridge
    env: python
    plan: free # or starter/standard for production
    autoDeploy: true
    region: frankfurt # Lower latency to KSA than US regions

    # 1. Build Phase
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # 2. Start Phase (Delegates to hardened shell script)
    startCommand: sh scripts/start_web.sh

    # 3. Health Check (Ensures Engine is fully booted)
    healthCheckPath: /readyz
    healthCheckTimeout: 15

    envVars:
      # --- Runtime Core ---
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: TZ
        value: "Asia/Riyadh"
      - key: APP_ENV
        value: "production"
      
      # --- Identity ---
      - key: APP_NAME
        value: "Tadawul Fast Bridge"
      - key: APP_VERSION
        value: "6.2.0"

      # --- Server Tuning (Uvicorn) ---
      # Leave WEB_CONCURRENCY empty to let start_web.sh auto-detect cores
      - key: WEB_CONCURRENCY
        value: "" 
      - key: UVICORN_KEEPALIVE
        value: "120"
      - key: UVICORN_TIMEOUT
        value: "120"
      - key: UVICORN_Backlog
        value: "2048"
      
      # --- Application Features ---
      - key: ADVISOR_ENABLED
        value: "true"
      - key: AI_ANALYSIS_ENABLED
        value: "true"
      - key: ADVANCED_ANALYSIS_ENABLED
        value: "true"
      - key: ENABLE_RATE_LIMITING
        value: "true"
      - key: MAX_REQUESTS_PER_MINUTE
        value: "300"

      # --- Fast Boot Optimization ---
      - key: DEFER_ROUTER_MOUNT
        value: "true"
      - key: INIT_ENGINE_ON_BOOT
        value: "true"

      # --- Data Providers (Routing) ---
      - key: ENABLED_PROVIDERS
        value: "eodhd,finnhub"
      - key: KSA_PROVIDERS
        value: "yahoo_chart,argaam"
      - key: PRIMARY_PROVIDER
        value: "eodhd"
      
      # --- KSA Specifics ---
      - key: KSA_DISALLOW_EODHD
        value: "true"
      - key: ENABLE_YAHOO_CHART_KSA
        value: "true"
      
      # --- Security (Secrets - Set in Dashboard) ---
      - key: APP_TOKEN
        sync: false
      - key: BACKUP_APP_TOKEN
        sync: false
      
      # --- API Keys (Secrets - Set in Dashboard) ---
      - key: EODHD_API_KEY
        sync: false
      - key: FINNHUB_API_KEY
        sync: false
      - key: ARGAAM_API_KEY
        sync: false
      - key: FMP_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false

      # --- Provider Endpoints (Optional Overrides) ---
      - key: ARGAAM_QUOTE_URL
        sync: false
      - key: ARGAAM_PROFILE_URL
        sync: false

      # --- Google Integration (Secrets - Set in Dashboard) ---
      - key: GOOGLE_SHEETS_CREDENTIALS
        sync: false
      - key: DEFAULT_SPREADSHEET_ID
        sync: false

      # --- Batch Processing Limits ---
      - key: AI_BATCH_SIZE
        value: "25"
      - key: AI_MAX_TICKERS
        value: "800"
      - key: AI_BATCH_CONCURRENCY
        value: "8"
      
      # --- CORS Security ---
      - key: ENABLE_CORS_ALL_ORIGINS
        value: "true"
      - key: CORS_ORIGINS
        value: "*"
