<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadawul Fast Bridge â€“ Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1020;
      --bg-alt: #141a33;
      --card-bg: #181f3b;
      --border: #222b4d;
      --accent: #4fd1c5;
      --accent-soft: rgba(79, 209, 197, 0.1);
      --accent-strong: #38b2ac;
      --text: #edf2f7;
      --muted: #a0aec0;
      --danger: #fc8181;
      --warning: #ecc94b;
      --success: #68d391;
      --ksa: #f6ad55;
      --global: #63b3ed;
      --radius-lg: 14px;
      --shadow-soft: 0 15px 35px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1a2038, #050812 55%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .title-block h1 {
      margin: 0 0 6px;
      font-size: 1.8rem;
      letter-spacing: 0.02em;
      background: linear-gradient(90deg, var(--text), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title-block p {
      margin: 0;
      color: var(--muted);
      font-size: 0.92rem;
      max-width: 600px;
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(72, 187, 120, 0.1);
      color: var(--success);
      border: 1px solid rgba(72, 187, 120, 0.25);
      transition: all 0.3s ease;
    }

    .pill.disconnected {
      background: rgba(252, 129, 129, 0.1);
      color: var(--danger);
      border-color: rgba(252, 129, 129, 0.25);
    }

    .pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 8px currentColor;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 3.2fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(145deg, #181f3b, #0f1426);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, var(--accent), transparent);
      opacity: 0.5;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      font-weight: 600;
    }

    .card-header small { font-size: 0.75rem; color: var(--muted); opacity: 0.8; }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(11, 16, 32, 0.6);
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .row > div { flex: 1 1 140px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--accent-strong);
      background: rgba(56, 178, 172, 0.15);
      color: var(--accent);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--accent-strong);
      color: #000;
      transform: translateY(-1px);
    }

    .btn.secondary {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }
    .btn.secondary:hover {
      border-color: var(--muted);
      color: var(--text);
    }

    .btn.sm { padding: 6px 12px; font-size: 0.8rem; }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
    }

    .status-card {
      padding: 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
    }

    .status-card h3 {
      margin: 0 0 6px;
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
    }

    .status-card .value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }
    .status-card .value.ok { color: var(--success); }
    .status-card .value.bad { color: var(--danger); }

    pre {
      background: #080c17;
      border-radius: 8px;
      padding: 12px;
      font-family: 'Menlo', 'Monaco', monospace;
      font-size: 0.8rem;
      color: #a0aec0;
      overflow-x: auto;
      border: 1px solid var(--border);
      margin-top: 10px;
      max-height: 300px;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    th, td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: #151b33;
      color: var(--accent);
      position: sticky;
      top: 0;
    }

    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }

    .chip-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 99px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
    }
    .chip.ksa { color: var(--ksa); border-color: rgba(246, 173, 85, 0.3); }
    .chip.global { color: var(--global); border-color: rgba(99, 179, 237, 0.3); }

    .error-text { color: var(--danger); font-size: 0.85rem; margin-top: 8px; display: block; }
    
    footer {
      margin-top: 40px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--muted);
      opacity: 0.6;
    }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="title-block">
      <h1>Tadawul Fast Bridge</h1>
      <p>Unified Data Engine v2 Control Panel. Manages KSA (.SR) & Global data flows for the Ultimate Investment Dashboard.</p>
    </div>
    <div class="pill disconnected" id="connection-pill">
      <span class="dot"></span>
      <span id="connection-pill-text">Disconnected</span>
    </div>
  </header>

  <main>
    <!-- LEFT COLUMN -->
    <section>
      
      <!-- CONFIGURATION -->
      <div class="card">
        <div class="card-header">
          <h2>API Connection</h2>
          <small id="cfg-status">Not tested</small>
        </div>
        <div class="row">
          <div>
            <label>Backend URL</label>
            <input id="baseUrl" type="text" placeholder="http://127.0.0.1:8000" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>App Token (Optional)</label>
            <input id="token" type="password" placeholder="X-APP-TOKEN" />
          </div>
        </div>
        <div class="row" style="justify-content: flex-end;">
          <button class="btn secondary sm" id="clearCfgBtn">Reset</button>
          <button class="btn sm" id="saveCfgBtn">Connect</button>
        </div>
        <div id="cfg-error" class="error-text" style="display:none;"></div>
      </div>

      <!-- SYSTEM STATUS -->
      <div class="card">
        <div class="card-header">
          <h2>System Status</h2>
          <button class="btn secondary sm" id="refreshStatusBtn">Refresh</button>
        </div>
        <div class="status-grid">
          <div class="status-card">
            <h3>Backend</h3>
            <div class="value" id="status-env">-</div>
          </div>
          <div class="status-card">
            <h3>Engine Mode</h3>
            <div class="value" id="status-engine">-</div>
          </div>
          <div class="status-card">
            <h3>Google Sheets</h3>
            <div class="value" id="status-sheets">-</div>
          </div>
        </div>
        <div style="margin-top:15px">
            <label>Route Health</label>
            <div class="status-grid">
                <div class="status-card">
                    <h3>Enriched</h3>
                    <div class="value" id="health-enriched">-</div>
                </div>
                <div class="status-card">
                    <h3>AI Analysis</h3>
                    <div class="value" id="health-ai">-</div>
                </div>
                <div class="status-card">
                    <h3>Advanced</h3>
                    <div class="value" id="health-adv">-</div>
                </div>
            </div>
        </div>
      </div>

    </section>

    <!-- RIGHT COLUMN -->
    <section>
      
      <!-- QUICK CHECK -->
      <div class="card">
        <div class="card-header">
          <h2>Quick Symbol Check</h2>
        </div>
        <div class="row">
          <div style="flex: 2;">
            <label>Symbol</label>
            <input id="quickSymbol" type="text" placeholder="e.g. 1120.SR or AAPL" />
          </div>
          <div style="flex: 3;">
            <label>Route</label>
            <select id="quickType">
              <option value="enriched">Enriched Quote (/v1/enriched)</option>
              <option value="analysis">AI Analysis (/v1/analysis)</option>
              <option value="advanced">Advanced Score (/v1/advanced)</option>
            </select>
          </div>
          <div style="flex: 0;">
            <label>&nbsp;</label>
            <button class="btn sm" id="runQuickBtn">Fetch</button>
          </div>
        </div>
        <pre id="quickResult">// Response will appear here...</pre>
      </div>

      <!-- BATCH PREVIEW -->
      <div class="card">
        <div class="card-header">
          <h2>Sheet Rows Preview</h2>
          <small>Batch processing & sorting</small>
        </div>
        <div class="row">
            <div>
                <label>Target Sheet Type</label>
                <select id="batchType">
                    <option value="enriched">Global/KSA/Funds (Enriched)</option>
                    <option value="analysis">Insights (AI Analysis)</option>
                    <option value="advanced">Advanced Analysis</option>
                </select>
            </div>
        </div>
        <label>Tickers (One per line)</label>
        <textarea id="batchTickers" rows="5" placeholder="1120.SR&#10;1180.SR&#10;AAPL&#10;MSFT"></textarea>
        
        <div class="chip-row" id="tickerSplitRow" style="display:none;"></div>
        
        <div class="row" style="justify-content: flex-end; margin-top:10px;">
            <button class="btn secondary sm" id="clearBatchBtn">Clear</button>
            <button class="btn sm" id="runBatchBtn">Preview Rows</button>
        </div>
        
        <div id="batchError" class="error-text" style="display:none;"></div>
        <div class="table-container" id="batchTableContainer" style="display:none;"></div>
      </div>

    </section>
  </main>

  <footer>
    Tadawul Fast Bridge v4.0.0 &bull; Powered by DataEngine V2 &bull; KSA-Safe
  </footer>
</div>

<script>
  (function() {
    // --- STATE ---
    const state = { baseUrl: "", token: "" };
    
    // --- ELEMENTS ---
    const el = (id) => document.getElementById(id);
    const ui = {
      baseUrl: el('baseUrl'), token: el('token'),
      cfgStatus: el('cfgStatus'), cfgError: el('cfgError'),
      saveCfg: el('saveCfgBtn'), clearCfg: el('clearCfgBtn'),
      pill: el('connection-pill'), pillText: el('connection-pill-text'),
      
      // Status
      stEnv: el('status-env'), stEngine: el('status-engine'), stSheets: el('status-sheets'),
      hEnriched: el('health-enriched'), hAi: el('health-ai'), hAdv: el('health-adv'),
      refreshStatus: el('refreshStatusBtn'),
      
      // Quick
      qSym: el('quickSymbol'), qType: el('quickType'), qRun: el('runQuickBtn'), qRes: el('quickResult'),
      
      // Batch
      bType: el('batchType'), bTickers: el('batchTickers'), bRun: el('runBatchBtn'), 
      bClear: el('clearBatchBtn'), bErr: el('batchError'), bTable: el('batchTableContainer'),
      bSplit: el('tickerSplitRow')
    };

    // --- CONFIG LOGIC ---
    function loadConfig() {
      state.baseUrl = localStorage.getItem("tfb_base_url") || window.location.origin;
      state.token = localStorage.getItem("tfb_app_token") || "";
      ui.baseUrl.value = state.baseUrl;
      ui.token.value = state.token;
    }

    function saveConfig() {
      state.baseUrl = ui.baseUrl.value.replace(/\/$/, "");
      state.token = ui.token.value.trim();
      localStorage.setItem("tfb_base_url", state.baseUrl);
      localStorage.setItem("tfb_app_token", state.token);
      checkConnectivity();
    }

    async function fetchAPI(endpoint, opts = {}) {
      const url = `${state.baseUrl}${endpoint}`;
      const headers = { 'Content-Type': 'application/json', ...opts.headers };
      if (state.token) headers['X-APP-TOKEN'] = state.token;
      
      try {
        const res = await fetch(url, { ...opts, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
        return data;
      } catch (e) {
        throw e;
      }
    }

    function updatePill(ok) {
      if (ok) {
        ui.pill.classList.remove('disconnected');
        ui.pillText.textContent = "Connected";
        ui.cfgStatus.textContent = "Online";
        ui.cfgStatus.style.color = "var(--success)";
        ui.cfgError.style.display = 'none';
      } else {
        ui.pill.classList.add('disconnected');
        ui.pillText.textContent = "Disconnected";
        ui.cfgStatus.textContent = "Offline";
        ui.cfgStatus.style.color = "var(--danger)";
      }
    }

    // --- OPERATIONS ---
    async function checkConnectivity() {
      ui.stEnv.textContent = "...";
      ui.stEngine.textContent = "...";
      ui.hEnriched.textContent = "...";
      
      try {
        // 1. Root Status
        const root = await fetchAPI('/');
        ui.stEnv.textContent = `v${root.version}`;
        ui.stEngine.textContent = root.engine || "Unknown";
        
        // 2. Health Checks
        const [hE, hA, hAdv] = await Promise.allSettled([
            fetchAPI('/v1/enriched/health'),
            fetchAPI('/v1/analysis/health'),
            fetchAPI('/v1/advanced/health')
        ]);
        
        const setH = (el, res) => {
            el.textContent = res.status === 'fulfilled' ? 'OK' : 'ERR';
            el.className = `value ${res.status === 'fulfilled' ? 'ok' : 'bad'}`;
        };
        
        setH(ui.hEnriched, hE);
        setH(ui.hAi, hA);
        setH(ui.hAdv, hAdv);
        
        // Check legacy status for sheets info if available
        try {
            // Note: If legacy doesn't exist, this fails silently
            // Since main.py root doesn't return sheets status yet, we assume configured if root worked
            ui.stSheets.textContent = "Assumed OK"; 
            ui.stSheets.className = "value ok";
        } catch(e) {}

        updatePill(true);
      } catch (e) {
        console.error(e);
        ui.cfgError.textContent = `Connection Failed: ${e.message}`;
        ui.cfgError.style.display = 'block';
        updatePill(false);
      }
    }

    async function runQuick() {
      const sym = ui.qSym.value.trim();
      if (!sym) return;
      
      ui.qRes.textContent = "Loading...";
      const type = ui.qType.value;
      let path = "";
      
      if (type === 'enriched') path = `/v1/enriched/quote?symbol=${sym}`;
      else if (type === 'analysis') path = `/v1/analysis/quote?symbol=${sym}`;
      else if (type === 'advanced') path = `/v1/advanced/scoreboard?tickers=${sym}&top_n=1`;
      
      try {
        const data = await fetchAPI(path);
        // Clean up response if it's the scoreboard wrapper
        const display = (type === 'advanced' && data.items) ? data.items[0] : data;
        ui.qRes.textContent = JSON.stringify(display, null, 2);
      } catch (e) {
        ui.qRes.textContent = `Error: ${e.message}`;
      }
    }

    async function runBatch() {
      const txt = ui.bTickers.value;
      const tickers = txt.split('\n').map(t => t.trim()).filter(t => t);
      if (!tickers.length) return;

      ui.bErr.style.display = 'none';
      ui.bTable.style.display = 'none';
      ui.bRun.textContent = "Processing...";
      ui.bRun.disabled = true;

      const type = ui.bType.value;
      const endpoint = `/v1/${type}/sheet-rows`; // All follow this convention now

      try {
        const data = await fetchAPI(endpoint, {
            method: 'POST',
            body: { tickers, sheet_name: "Preview_Test" } // Dummy sheet name required by backend
        });

        // Render Table
        let html = '<table><thead><tr>';
        data.headers.forEach(h => html += `<th>${h}</th>`);
        html += '</tr></thead><tbody>';
        
        data.rows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
                const val = (cell === null || cell === undefined) ? '' : cell;
                html += `<td>${val}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        ui.bTable.innerHTML = html;
        ui.bTable.style.display = 'block';
      } catch (e) {
        ui.bErr.textContent = `Batch Error: ${e.message}`;
        ui.bErr.style.display = 'block';
      } finally {
        ui.bRun.textContent = "Preview Rows";
        ui.bRun.disabled = false;
      }
    }

    function updateSplit() {
      const txt = ui.bTickers.value;
      const tickers = txt.split('\n').map(t => t.trim()).filter(t => t);
      const ksa = tickers.filter(t => t.toUpperCase().endsWith('.SR') || /^\d+$/.test(t));
      const glob = tickers.filter(t => !t.toUpperCase().endsWith('.SR') && !/^\d+$/.test(t));
      
      let html = '';
      if (ksa.length) html += `<div class="chip ksa">KSA: ${ksa.length}</div>`;
      if (glob.length) html += `<div class="chip global">Global: ${glob.length}</div>`;
      
      ui.bSplit.innerHTML = html;
      ui.bSplit.style.display = html ? 'flex' : 'none';
    }

    // --- EVENTS ---
    ui.saveCfg.onclick = saveConfig;
    ui.clearCfg.onclick = () => { localStorage.clear(); location.reload(); };
    ui.refreshStatus.onclick = checkConnectivity;
    ui.qRun.onclick = runQuick;
    ui.bRun.onclick = runBatch;
    ui.bClear.onclick = () => { ui.bTickers.value = ''; updateSplit(); ui.bTable.style.display='none'; };
    ui.bTickers.oninput = updateSplit;

    // --- INIT ---
    loadConfig();
    checkConnectivity();
  })();
</script>
</body>
</html>
