<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadawul Fast Bridge – Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1020;
      --bg-alt: #141a33;
      --card-bg: #181f3b;
      --border: #222b4d;
      --accent: #4fd1c5;
      --accent-soft: rgba(79, 209, 197, 0.1);
      --accent-strong: #38b2ac;
      --text: #edf2f7;
      --muted: #a0aec0;
      --danger: #fc8181;
      --warning: #ecc94b;
      --success: #68d391;
      --ksa: #f6ad55;
      --global: #63b3ed;
      --radius-lg: 14px;
      --shadow-soft: 0 15px 35px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #1a2038, #050812 55%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .title-block h1 {
      margin: 0 0 6px;
      font-size: 1.8rem;
      letter-spacing: 0.02em;
    }

    .title-block p {
      margin: 0;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: rgba(72, 187, 120, 0.1);
      color: var(--success);
      border: 1px solid rgba(72, 187, 120, 0.35);
    }

    .pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--success);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(145deg, #181f3b, #0f1426);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .card-header small {
      font-size: 0.8rem;
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(160, 174, 192, 0.25);
      background: rgba(26, 32, 44, 0.8);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(160, 174, 192, 0.65);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 209, 197, 0.35);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1 1 150px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      background: radial-gradient(circle at top left, var(--accent), #2b6cb0);
      color: #0a101c;
      font-weight: 600;
      font-size: 0.83rem;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        filter 0.08s ease;
      box-shadow: 0 8px 18px rgba(45, 212, 191, 0.35);
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 11px 24px rgba(45, 212, 191, 0.5);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(45, 212, 191, 0.3);
    }

    .btn.secondary {
      background: transparent;
      color: var(--accent);
      border-color: rgba(129, 230, 217, 0.6);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(79, 209, 197, 0.08);
      box-shadow: 0 8px 18px rgba(66, 153, 225, 0.25);
    }

    .btn.sm {
      padding: 4px 9px;
      font-size: 0.75rem;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(160, 174, 192, 0.45);
      font-size: 0.7rem;
      color: var(--muted);
      gap: 4px;
    }

    .tag span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
    }

    .tag.ksat {
      border-color: rgba(246, 173, 85, 0.6);
      color: var(--ksa);
    }

    .tag.ksat span.dot {
      background: var(--ksa);
    }

    .tag.global {
      border-color: rgba(99, 179, 237, 0.6);
      color: var(--global);
    }

    .tag.global span.dot {
      background: var(--global);
    }

    .tag.error {
      border-color: rgba(252, 129, 129, 0.6);
      color: var(--danger);
    }

    .tag.ok {
      border-color: rgba(104, 211, 145, 0.6);
      color: var(--success);
    }

    .muted {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }

    .status-card {
      padding: 8px 10px;
      border-radius: 10px;
      background: radial-gradient(circle at top left, #1a2038, #0c101f);
      border: 1px solid rgba(160, 174, 192, 0.2);
      font-size: 0.78rem;
    }

    .status-card h3 {
      margin: 0 0 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status-card .value {
      font-size: 0.8rem;
    }

    .status-card .value.ok {
      color: var(--success);
    }

    .status-card .value.bad {
      color: var(--danger);
    }

    pre {
      background: #050812;
      border-radius: 10px;
      border: 1px solid #222b4d;
      padding: 10px;
      color: #cbd5f5;
      font-size: 0.78rem;
      max-height: 260px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th,
    td {
      border: 1px solid rgba(45, 55, 72, 0.7);
      padding: 4px 6px;
      text-align: left;
    }

    th {
      background: #1a223e;
      color: #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tbody tr:nth-child(even) {
      background: #050914;
    }

    tbody tr:nth-child(odd) {
      background: #080d1a;
    }

    .table-container {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-top: 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip-row .chip {
      font-size: 0.75rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(160, 174, 192, 0.16);
      border: 1px solid rgba(160, 174, 192, 0.3);
    }

    .chip-row .chip.ksa {
      border-color: rgba(246, 173, 85, 0.6);
      background: rgba(246, 173, 85, 0.08);
      color: var(--ksa);
    }

    .chip-row .chip.global {
      border-color: rgba(99, 179, 237, 0.6);
      background: rgba(99, 179, 237, 0.08);
      color: var(--global);
    }

    .error-text {
      color: var(--danger);
      font-size: 0.79rem;
      margin-top: 4px;
    }

    .small-note {
      font-size: 0.76rem;
      color: var(--muted);
      margin-top: 4px;
    }

    footer {
      margin-top: 16px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Tadawul Fast Bridge – Control Panel</h1>
      <p>
        Unified Data Engine v2 for KSA (.SR) & Global markets –
        powering your 9-page Ultimate Investment Dashboard, Google Sheets, and AI analysis.
      </p>
    </div>
    <div>
      <div class="pill" id="connection-pill">
        <span class="dot"></span>
        <span id="connection-pill-text">Backend & Sheets Console</span>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT COLUMN: SETTINGS + HEALTH + STATUS -->
    <section>
      <!-- Connection card -->
      <div class="card" id="cfg-card">
        <div class="card-header">
          <h2>Connection</h2>
          <small id="cfg-status" class="muted">Not tested yet</small>
        </div>
        <div class="row">
          <div>
            <label for="baseUrl">Backend Base URL</label>
            <input id="baseUrl" type="text" placeholder="https://tadawul-fast-bridge.onrender.com" />
            <div class="small-note">
              If empty, uses the current origin (<code>window.location.origin</code>).
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="token">APP Token (X-APP-TOKEN)</label>
            <input id="token" type="password" placeholder="Required if backend enforces token" />
            <div class="small-note">
              Stored only in your browser (localStorage).
            </div>
          </div>
        </div>
        <div class="row" style="justify-content: flex-end;">
          <button class="btn secondary sm" id="clearCfgBtn">Reset</button>
          <button class="btn sm" id="saveCfgBtn">Save & Test</button>
        </div>
        <div id="cfg-error" class="error-text" style="display:none;"></div>
      </div>

      <!-- Module Health -->
      <div class="card">
        <div class="card-header">
          <h2>Module Health</h2>
          <small>Checks /v1/enriched, /v1/analysis, /v1/advanced, /v1/argaam</small>
        </div>
        <div class="status-grid" id="healthGrid">
          <div class="status-card">
            <h3>Enriched Quotes</h3>
            <div class="value" id="health-enriched">–</div>
          </div>
          <div class="status-card">
            <h3>AI Analysis</h3>
            <div class="value" id="health-ai">–</div>
          </div>
          <div class="status-card">
            <h3>Advanced Analysis</h3>
            <div class="value" id="health-adv">–</div>
          </div>
          <div class="status-card">
            <h3>KSA / Argaam</h3>
            <div class="value" id="health-argaam">–</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button class="btn secondary sm" id="refreshHealthBtn">Refresh Health</button>
        </div>
      </div>

      <!-- Service Status (/v1/status) -->
      <div class="card">
        <div class="card-header">
          <h2>Service Status</h2>
          <small>/v1/status snapshot (backend + Google Sheets)</small>
        </div>
        <div class="status-grid">
          <div class="status-card">
            <h3>Environment / Version</h3>
            <div class="value" id="status-env">–</div>
          </div>
          <div class="status-card">
            <h3>Google Sheets</h3>
            <div class="value" id="status-sheets">–</div>
          </div>
          <div class="status-card">
            <h3>Default Spreadsheet</h3>
            <div class="value" id="status-spreadsheet">–</div>
          </div>
          <div class="status-card">
            <h3>Auth / Tokens</h3>
            <div class="value" id="status-auth">–</div>
          </div>
        </div>
        <div class="row" style="margin-top:8px; justify-content:flex-end;">
          <button class="btn secondary sm" id="refreshStatusBtn">Refresh Status</button>
        </div>
        <div class="small-note">
          Reflects how the backend sees configuration for your 9 Google Sheets pages
          (KSA_Tadawul, Global_Markets, Mutual_Funds, Commodities_FX, My_Portfolio,
          Insights_Analysis, Investment_Advisor, Economic_Calendar, Income Statement, etc.).
        </div>
        <pre id="statusRaw" style="margin-top:6px;">{}</pre>
      </div>
    </section>

    <!-- RIGHT COLUMN: OPERATIONS -->
    <section>
      <!-- Quick symbol check -->
      <div class="card">
        <div class="card-header">
          <h2>Quick Symbol Check</h2>
          <small>Test single symbol from Enriched / AI / Advanced / KSA Gateway</small>
        </div>
        <div class="row">
          <div>
            <label for="quickSymbol">Symbol</label>
            <input id="quickSymbol" type="text" placeholder="1120.SR or AAPL" />
          </div>
          <div>
            <label for="quickType">Endpoint</label>
            <select id="quickType">
              <option value="enriched">Enriched Quote (/v1/enriched/quote)</option>
              <option value="analysis">AI Analysis (/v1/analysis/quote)</option>
              <option value="advanced">Advanced (/v1/advanced/symbol)</option>
              <option value="argaam">KSA Gateway (/v1/argaam/quote)</option>
            </select>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn sm" id="runQuickBtn">Run</button>
        </div>
        <div class="small-note">
          KSA symbols end with <code>.SR</code> and use Tadawul/Argaam providers internally.
          The unified data engine never calls EODHD for KSA tickers.
        </div>
        <pre id="quickResult" style="margin-top:8px;">{}</pre>
      </div>

      <!-- Batch sheet-rows preview -->
      <div class="card">
        <div class="card-header">
          <h2>Batch Sheet Rows Preview</h2>
          <small>Same structure as the 9 Google Sheets pages (/sheet-rows)</small>
        </div>
        <div class="row">
          <div>
            <label for="batchType">Data Type</label>
            <select id="batchType">
              <option value="enriched">Enriched Quotes (/v1/enriched/sheet-rows)</option>
              <option value="analysis">AI Analysis (/v1/analysis/sheet-rows)</option>
              <option value="advanced">Advanced (/v1/advanced/sheet-rows)</option>
            </select>
          </div>
        </div>
        <label for="batchTickers">Tickers (one per line)</label>
        <textarea id="batchTickers" placeholder="1120.SR&#10;1180.SR&#10;AAPL&#10;MSFT"></textarea>
        <div class="chip-row" id="tickerSplitRow" style="display:none;"></div>
        <div class="row" style="justify-content:flex-end; margin-top:8px;">
          <button class="btn secondary sm" id="clearBatchBtn">Clear</button>
          <button class="btn sm" id="runBatchBtn">Preview</button>
        </div>
        <div id="batchError" class="error-text" style="display:none;"></div>
        <div class="table-container" id="batchTableContainer" style="display:none;"></div>
      </div>
    </section>
  </main>

  <footer>
    KSA tickers (<code>.SR</code>) are routed to Tadawul/Argaam providers via the KSA gateway –
    no direct EODHD usage for KSA. Global tickers use EODHD + FMP, with /sheet-rows powering
    your 9 Google Sheets pages and Investment Advisor logic.
  </footer>
</div>

<script>
  (function () {
    const state = {
      baseUrl: "",
      token: "",
    };

    const els = {
      // config
      baseUrl: document.getElementById("baseUrl"),
      token: document.getElementById("token"),
      cfgStatus: document.getElementById("cfg-status"),
      cfgError: document.getElementById("cfg-error"),
      saveCfgBtn: document.getElementById("saveCfgBtn"),
      clearCfgBtn: document.getElementById("clearCfgBtn"),
      connectionPill: document.getElementById("connection-pill"),
      connectionPillText: document.getElementById("connection-pill-text"),

      // health
      healthEnriched: document.getElementById("health-enriched"),
      healthAi: document.getElementById("health-ai"),
      healthAdv: document.getElementById("health-adv"),
      healthArgaam: document.getElementById("health-argaam"),
      refreshHealthBtn: document.getElementById("refreshHealthBtn"),

      // status (/v1/status)
      statusEnv: document.getElementById("status-env"),
      statusSheets: document.getElementById("status-sheets"),
      statusSpreadsheet: document.getElementById("status-spreadsheet"),
      statusAuth: document.getElementById("status-auth"),
      refreshStatusBtn: document.getElementById("refreshStatusBtn"),
      statusRaw: document.getElementById("statusRaw"),

      // quick symbol
      quickSymbol: document.getElementById("quickSymbol"),
      quickType: document.getElementById("quickType"),
      runQuickBtn: document.getElementById("runQuickBtn"),
      quickResult: document.getElementById("quickResult"),

      // batch
      batchType: document.getElementById("batchType"),
      batchTickers: document.getElementById("batchTickers"),
      runBatchBtn: document.getElementById("runBatchBtn"),
      clearBatchBtn: document.getElementById("clearBatchBtn"),
      batchError: document.getElementById("batchError"),
      batchTableContainer: document.getElementById("batchTableContainer"),
      tickerSplitRow: document.getElementById("tickerSplitRow"),
    };

    // --------------------------------------------------------
    // Config helpers
    // --------------------------------------------------------
    function loadConfig() {
      const storedBase = localStorage.getItem("tfb_base_url");
      const storedToken = localStorage.getItem("tfb_app_token");
      state.baseUrl = storedBase || window.location.origin;
      state.token = storedToken || "";
      els.baseUrl.value = storedBase || "";
      els.token.value = storedToken || "";
      els.cfgStatus.textContent = "Loaded config, not tested";
    }

    function saveConfig() {
      const base = els.baseUrl.value.trim();
      state.baseUrl = base || window.location.origin;
      state.token = els.token.value.trim();
      localStorage.setItem("tfb_base_url", base);
      localStorage.setItem("tfb_app_token", state.token);
    }

    function resetConfig() {
      localStorage.removeItem("tfb_base_url");
      localStorage.removeItem("tfb_app_token");
      state.baseUrl = window.location.origin;
      state.token = "";
      els.baseUrl.value = "";
      els.token.value = "";
      els.cfgStatus.textContent = "Reset to defaults, not tested";
      els.cfgError.style.display = "none";
      els.cfgError.textContent = "";
      if (els.connectionPillText) {
        els.connectionPillText.textContent = "Backend & Sheets Console";
      }
    }

    // --------------------------------------------------------
    // Fetch helper
    // --------------------------------------------------------
    async function apiFetch(path, options = {}) {
      const base = (state.baseUrl || window.location.origin).replace(/\/$/, "");
      const url = base + path;
      const opts = Object.assign({ method: "GET" }, options);
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        opts.headers || {}
      );
      if (state.token) {
        headers["X-APP-TOKEN"] = state.token;
      }
      opts.headers = headers;

      if (opts.body && typeof opts.body !== "string") {
        opts.body = JSON.stringify(opts.body);
      }

      const resp = await fetch(url, opts);
      const text = await resp.text();
      let data;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (e) {
        data = text;
      }
      if (!resp.ok) {
        const err = new Error("HTTP " + resp.status);
        err.status = resp.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    // --------------------------------------------------------
    // Helpers
    // --------------------------------------------------------
    function classifyTickers(tickers) {
      const ksa = [];
      const global = [];
      (tickers || []).forEach((raw) => {
        const t = (raw || "").trim();
        if (!t) return;
        if (t.toUpperCase().endsWith(".SR")) {
          ksa.push(t.toUpperCase());
        } else {
          global.push(t.toUpperCase());
        }
      });
      return { ksa, global };
    }

    function setConnectionPill(ok) {
      if (!els.connectionPill || !els.connectionPillText) return;
      if (ok) {
        els.connectionPillText.textContent = "Connected to backend";
      } else {
        els.connectionPillText.textContent = "Connection error";
      }
    }

    // --------------------------------------------------------
    // Health & Status
    // --------------------------------------------------------
    async function updateHealthCard(kind) {
      const idMap = {
        enriched: els.healthEnriched,
        analysis: els.healthAi,
        advanced: els.healthAdv,
        argaam: els.healthArgaam,
      };
      const el = idMap[kind];
      if (!el) return;
      el.textContent = "Checking...";
      el.classList.remove("ok", "bad");

      let path;
      if (kind === "enriched") path = "/v1/enriched/health";
      else if (kind === "analysis") path = "/v1/analysis/health";
      else if (kind === "advanced") path = "/v1/advanced/health";
      else path = "/v1/argaam/health";

      try {
        const data = await apiFetch(path);
        const okText = data && data.status ? data.status : "OK";
        el.textContent = okText;
        el.classList.add("ok");
      } catch (e) {
        el.textContent = "Error";
        el.classList.add("bad");
      }
    }

    async function updateStatusCard() {
      if (!els.statusEnv || !els.statusRaw) return;
      els.statusEnv.textContent = "Loading...";
      els.statusSheets.textContent = "Loading...";
      els.statusSpreadsheet.textContent = "Loading...";
      els.statusAuth.textContent = "Loading...";
      els.statusEnv.classList.remove("ok", "bad");
      els.statusSheets.classList.remove("ok", "bad");
      els.statusSpreadsheet.classList.remove("ok", "bad");
      els.statusAuth.classList.remove("ok", "bad");
      els.statusRaw.textContent = "Loading /v1/status...";

      try {
        const data = await apiFetch("/v1/status");
        els.statusRaw.textContent = JSON.stringify(data, null, 2);

        const env = data.environment || data.env || "-";
        const version = data.version || "-";
        els.statusEnv.textContent = env + " / " + version;
        els.statusEnv.classList.add("ok");

        const services = data.services || {};
        const sheetsOk = !!services.google_sheets;
        els.statusSheets.textContent = sheetsOk ? "Configured" : "Missing";
        els.statusSheets.classList.add(sheetsOk ? "ok" : "bad");

        const sheetsMeta = data.sheets || {};
        const hasDefault = !!sheetsMeta.has_default_spreadsheet;
        const sheetId = sheetsMeta.default_spreadsheet_id || "(not set)";
        els.statusSpreadsheet.textContent = hasDefault ? sheetId : "Not configured";
        els.statusSpreadsheet.classList.add(hasDefault ? "ok" : "bad");

        const auth = data.auth || {};
        const hasToken = !!auth.has_secure_token;
        els.statusAuth.textContent = hasToken ? "Tokens configured" : "No token";
        els.statusAuth.classList.add(hasToken ? "ok" : "bad");
      } catch (e) {
        els.statusEnv.textContent = "Error";
        els.statusSheets.textContent = "Error";
        els.statusSpreadsheet.textContent = "Error";
        els.statusAuth.textContent = "Error";
        els.statusEnv.classList.add("bad");
        els.statusSheets.classList.add("bad");
        els.statusSpreadsheet.classList.add("bad");
        els.statusAuth.classList.add("bad");
        els.statusRaw.textContent =
          "Error calling /v1/status: " +
          (e.data ? JSON.stringify(e.data) : e.toString());
      }
    }

    async function testConfigAndHealth() {
      els.cfgError.style.display = "none";
      els.cfgError.textContent = "";
      els.cfgStatus.textContent = "Testing...";
      setConnectionPill(false);
      try {
        await Promise.all([
          updateHealthCard("enriched"),
          updateHealthCard("analysis"),
          updateHealthCard("advanced"),
          updateHealthCard("argaam"),
          updateStatusCard(),
        ]);
        els.cfgStatus.textContent = "Connection OK";
        setConnectionPill(true);
      } catch (e) {
        els.cfgStatus.textContent = "Health check failed";
        els.cfgError.style.display = "block";
        els.cfgError.textContent =
          "Health check failed. Check base URL / token or backend logs.";
        setConnectionPill(false);
      }
    }

    // --------------------------------------------------------
    // Quick symbol check
    // --------------------------------------------------------
    async function runQuickCheck() {
      const symbol = els.quickSymbol.value.trim();
      const type = els.quickType.value;
      if (!symbol) {
        els.quickResult.textContent = "Please enter a symbol.";
        return;
      }
      els.quickResult.textContent = "Loading...";
      let path;
      if (type === "enriched") {
        path = "/v1/enriched/quote?symbol=" + encodeURIComponent(symbol);
      } else if (type === "analysis") {
        path = "/v1/analysis/quote?symbol=" + encodeURIComponent(symbol);
      } else if (type === "advanced") {
        path = "/v1/advanced/symbol?symbol=" + encodeURIComponent(symbol);
      } else {
        // KSA Gateway – routes directly to Argaam/Tadawul gateway
        path = "/v1/argaam/quote?symbol=" + encodeURIComponent(symbol);
      }

      try {
        const data = await apiFetch(path);
        els.quickResult.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        els.quickResult.textContent =
          "Error: " +
          (e.status ? "HTTP " + e.status + " " : "") +
          (e.data ? JSON.stringify(e.data, null, 2) : e.toString());
      }
    }

    // --------------------------------------------------------
    // Batch preview (sheet-rows)
    // --------------------------------------------------------
    function renderTickerSplit() {
      const raw = els.batchTickers.value.split("\n");
      const { ksa, global } = classifyTickers(raw);
      const row = els.tickerSplitRow;
      row.innerHTML = "";
      if (!ksa.length && !global.length) {
        row.style.display = "none";
        return;
      }
      if (ksa.length) {
        const chip = document.createElement("div");
        chip.className = "chip ksa";
        chip.textContent = "KSA (.SR): " + ksa.length;
        row.appendChild(chip);
      }
      if (global.length) {
        const chip = document.createElement("div");
        chip.className = "chip global";
        chip.textContent = "Global: " + global.length;
        row.appendChild(chip);
      }
      row.style.display = "flex";
    }

    async function runBatchPreview() {
      els.batchError.style.display = "block";
      els.batchError.style.color = "#fc8181";
      els.batchError.textContent = "";
      els.batchTableContainer.style.display = "none";
      els.batchTableContainer.innerHTML = "";

      const raw = els.batchTickers.value.split("\n");
      const tickers = [];
      raw.forEach((line) => {
        const t = (line || "").trim();
        if (t) tickers.push(t);
      });
      if (!tickers.length) {
        els.batchError.textContent = "Please enter at least one ticker.";
        return;
      }

      const type = els.batchType.value;
      let endpoint;
      if (type === "enriched") {
        endpoint = "/v1/enriched/sheet-rows";
      } else if (type === "analysis") {
        endpoint = "/v1/analysis/sheet-rows";
      } else {
        endpoint = "/v1/advanced/sheet-rows";
      }

      els.batchError.textContent = "Loading from backend...";

      try {
        const payload = { tickers: tickers };
        const data = await apiFetch(endpoint, {
          method: "POST",
          body: payload,
        });

        const headers = data.headers || [];
        const rows = data.rows || [];

        if (!headers.length) {
          throw new Error("Backend returned no headers.");
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        headers.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          (row || []).forEach((cell) => {
            const td = document.createElement("td");
            td.textContent =
              cell === null || typeof cell === "undefined" ? "" : String(cell);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        els.batchTableContainer.innerHTML = "";
        els.batchTableContainer.appendChild(table);
        els.batchTableContainer.style.display = "block";
        els.batchError.textContent =
          "OK – previewing the exact headers/rows used by the Google Sheets pages.";
        els.batchError.style.color = "#68d391";
      } catch (e) {
        els.batchError.style.color = "#fc8181";
        els.batchError.textContent =
          "Error loading /sheet-rows: " +
          (e.data ? JSON.stringify(e.data) : e.toString());
      }
    }

    function clearBatch() {
      els.batchTickers.value = "";
      els.batchTableContainer.innerHTML = "";
      els.batchTableContainer.style.display = "none";
      els.batchError.style.display = "none";
      els.batchError.textContent = "";
      els.tickerSplitRow.style.display = "none";
      els.tickerSplitRow.innerHTML = "";
    }

    // --------------------------------------------------------
    // Events & init
    // --------------------------------------------------------
    function initEvents() {
      els.saveCfgBtn.addEventListener("click", async () => {
        saveConfig();
        await testConfigAndHealth();
      });

      els.clearCfgBtn.addEventListener("click", () => {
        resetConfig();
      });

      els.refreshHealthBtn.addEventListener("click", async () => {
        await testConfigAndHealth();
      });

      els.refreshStatusBtn.addEventListener("click", async () => {
        await updateStatusCard();
      });

      els.runQuickBtn.addEventListener("click", runQuickCheck);

      els.batchTickers.addEventListener("input", renderTickerSplit);
      els.runBatchBtn.addEventListener("click", runBatchPreview);
      els.clearBatchBtn.addEventListener("click", clearBatch);
    }

    function init() {
      loadConfig();
      initEvents();
      renderTickerSplit();
      // Optional: initial lightweight status load (no error if fails)
      updateStatusCard().catch(() => {});
    }

    init();
  })();
</script>
</body>
</html>
