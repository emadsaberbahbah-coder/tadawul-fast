You are absolutely right. The previous service only handled one or two sheets. To make your **"Ultimate Investment Dashboard"** work completely, the Python backend needs to know how to talk to **all 9 sheets** (tabs) in your Excel file.

Here is the **Full, Final `google_sheets_service.py`**.
It is upgraded to handle **all 9 pages**:

1.  `Dashboard_Overview`
2.  `KSA_Tadawul`
3.  `Global_Markets`
4.  `My_Portfolio`
5.  `Mutual_Funds`
6.  `Commodities_FX`
7.  `Insights_Analysis`
8.  `Investment_Advisor`
9.  `Investment_Advisor_Assumptions`

**Action:** Replace your current `google_sheets_service.py` with this entire script.

### `google_sheets_service.py` (Full 9-Page Support)

```python
"""
google_sheets_service.py
Enhanced Async Google Sheets Service - Full 9-Page Support
Version: 4.2.0
Description: Handles reading/writing for the entire Investment Dashboard ecosystem.
"""

import os
import json
import time
import asyncio
import logging
import hashlib
from typing import List, Dict, Any, Optional, Union
from datetime import datetime, timezone
from pathlib import Path
from contextlib import asynccontextmanager

import aiofiles
import pandas as pd
from pydantic import BaseModel, Field, validator
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type

# Configure logger
logger = logging.getLogger(__name__)

# ======================================================================
# 1. Configuration & Sheet Definitions
# ======================================================================

class SheetsConfig(BaseModel):
    """Configuration for all 9 dashboard sheets."""

    # Authentication
    credentials_json: Optional[str] = Field(None, description="JSON string of service account")
    credentials_path: Optional[str] = Field(None, description="Path to service account file")
    spreadsheet_id: str = Field(..., description="Main Spreadsheet ID")

    # Sheet Names (Tabs) - Matches your Excel file structure
    sheet_dashboard: str = "Dashboard_Overview"
    sheet_ksa: str = "KSA_Tadawul"
    sheet_global: str = "Global_Markets"
    sheet_portfolio: str = "My_Portfolio"
    sheet_funds: str = "Mutual_Funds"
    sheet_commodities: str = "Commodities_FX"
    sheet_insights: str = "Insights_Analysis"
    sheet_advisor: str = "Investment_Advisor"
    sheet_assumptions: str = "Investment_Advisor_Assumptions"

    # Settings
    cache_ttl: int = 300
    request_timeout: int = 30
    max_retries: int = 3
    cache_enabled: bool = True
    cache_dir: str = ".cache/sheets"

    @validator("credentials_json", pre=True, always=True)
    def validate_creds(cls, v, values):
        if v: return v
        # Try env vars
        env_json = os.getenv("GOOGLE_SHEETS_CREDENTIALS") or os.getenv("GOOGLE_SHEETS_CREDENTIALS_JSON")
        if env_json: return env_json
        env_path = os.getenv("GOOGLE_CREDENTIALS_PATH")
        if env_path: values["credentials_path"] = env_path
        return v

    @classmethod
    def from_env(cls) -> "SheetsConfig":
        return cls(
            spreadsheet_id=os.getenv("SPREADSHEET_ID", ""),
            # Defaults will pick up the standard names
        )

# ======================================================================
# 2. Service Class
# ======================================================================

class AsyncGoogleSheetsService:
    """
    Controller for the 9-page Investment Dashboard.
    """

    # Column mappings to standardize data access across different sheet types
    COLUMN_MAPPINGS = {
        "KSA": {
            "symbol": ["Symbol", "Code"],
            "price": ["Price", "Last Price"],
            "change": ["Change"],
            "change_pct": ["Change %"],
            "volume": ["Volume"],
            "market_cap": ["Market Cap"],
            "sector": ["Sector"],
            "opportunity": ["Opportunity Score"],
            "quality": ["Data Quality"]
        },
        "GLOBAL": {
            "symbol": ["Ticker", "Symbol"],
            "price": ["Current Price", "Price"],
            "change": ["Price Change", "Change"],
            "change_pct": ["Percent Change", "Change %"],
            "volume": ["Volume"],
            "pe": ["P/E Ratio"],
            "sector": ["Sector"],
            "opportunity": ["Overall Score", "Opportunity Score"]
        },
        "PORTFOLIO": {
            "symbol": ["Symbol", "Ticker"],
            "qty": ["Quantity"],
            "avg_cost": ["Average Cost", "Avg Cost"],
            "market_value": ["Market Value"],
            "unrealized": ["Unrealized P&L"],
            "allocation": ["Portfolio %"]
        }
    }

    def __init__(self, config: Optional[SheetsConfig] = None):
        self.config = config or SheetsConfig.from_env()
        self._validate_config()
        
        # Cache setup
        self.cache_dir = Path(self.config.cache_dir)
        self.cache_dir.mkdir(parents=True, exist_ok=True)
        self._memory_cache = {}
        
        # Service instance
        self._service = None
        self._service_lock = asyncio.Lock()
        
        logger.info(f"Sheets Service initialized for ID: {self.config.spreadsheet_id[:8]}...")

    def _validate_config(self):
        if not self.config.spreadsheet_id:
            logger.warning("SPREADSHEET_ID is missing. Service will be disabled.")

    async def _get_service(self):
        """Lazy load Google API service."""
        if self._service: return self._service
        
        async with self._service_lock:
            if self._service: return self._service
            
            try:
                loop = asyncio.get_running_loop()
                self._service = await loop.run_in_executor(None, self._init_sync)
                return self._service
            except Exception as e:
                logger.error(f"Failed to auth Google Sheets: {e}")
                raise

    def _init_sync(self):
        """Synchronous auth (runs in thread)."""
        scopes = ["https://www.googleapis.com/auth/spreadsheets"]
        
        if self.config.credentials_json:
            creds = Credentials.from_service_account_info(
                json.loads(self.config.credentials_json), scopes=scopes
            )
        elif self.config.credentials_path:
            creds = Credentials.from_service_account_file(
                self.config.credentials_path, scopes=scopes
            )
        else:
            # Fallback to default (e.g. Render environment/gcloud)
            import google.auth
            creds, _ = google.auth.default(scopes=scopes)
            
        return build("sheets", "v4", credentials=creds)

    # ------------------------------------------------------------------
    # Core Read/Write Methods (Generic)
    # ------------------------------------------------------------------

    async def read_range(self, sheet_name: str, range_name: str = "A:Z") -> List[Dict[str, Any]]:
        """Read data from any sheet and return as list of dicts."""
        cache_key = f"{sheet_name}!{range_name}"
        if self.config.cache_enabled:
            cached = self._get_from_cache(cache_key)
            if cached: return cached

        service = await self._get_service()
        full_range = f"{sheet_name}!{range_name}"
        
        try:
            loop = asyncio.get_running_loop()
            result = await loop.run_in_executor(
                None, 
                lambda: service.spreadsheets().values().get(
                    spreadsheetId=self.config.spreadsheet_id, range=full_range
                ).execute()
            )
            rows = result.get('values', [])
            
            if len(rows) < 2: return []
            
            headers = rows[0]
            data = [dict(zip(headers, row)) for row in rows[1:] if row]
            
            self._save_to_cache(cache_key, data)
            return data
            
        except Exception as e:
            logger.error(f"Error reading {full_range}: {e}")
            return []

    async def write_data(self, sheet_name: str, data: List[Dict[str, Any]], start_cell: str = "A2"):
        """Write list of dicts to a sheet (clears old data first usually)."""
        if not data: return
        
        service = await self._get_service()
        
        # 1. Get Headers from first row or config
        headers = list(data[0].keys())
        values = [headers] + [[str(row.get(h, '')) for h in headers] for row in data]
        
        body = {'values': values}
        range_name = f"{sheet_name}!{start_cell}"
        
        try:
            loop = asyncio.get_running_loop()
            # Clear first? Optional, but good for full updates
            await loop.run_in_executor(
                None,
                lambda: service.spreadsheets().values().update(
                    spreadsheetId=self.config.spreadsheet_id,
                    range=range_name,
                    valueInputOption="USER_ENTERED",
                    body=body
                ).execute()
            )
            logger.info(f"Updated {sheet_name} with {len(values)-1} rows.")
        except Exception as e:
            logger.error(f"Error writing to {sheet_name}: {e}")

    # ------------------------------------------------------------------
    # Page-Specific Methods (The 9 Pages)
    # ------------------------------------------------------------------

    # 1. Dashboard Overview
    async def update_dashboard(self, metrics: Dict[str, Any]):
        """Updates the high-level dashboard metrics."""
        # This usually updates specific cells, e.g., Portfolio Value in B6
        updates = [
            {"range": f"{self.config.sheet_dashboard}!B6", "values": [[metrics.get("portfolio_value", 0)]]},
            {"range": f"{self.config.sheet_dashboard}!D6", "values": [[metrics.get("daily_change", 0)]]},
            {"range": f"{self.config.sheet_dashboard}!F6", "values": [[metrics.get("ytd_return", 0)]]},
        ]
        await self._batch_update(updates)

    # 2. KSA Tadawul
    async def get_ksa_market(self) -> pd.DataFrame:
        data = await self.read_range(self.config.sheet_ksa)
        return pd.DataFrame(data)
        
    async def update_ksa_market(self, quotes: List[Dict[str, Any]]):
        # Format for KSA sheet columns
        formatted = []
        for q in quotes:
            formatted.append({
                "Symbol": q.get("symbol"),
                "Company Name": q.get("name"),
                "Sector": q.get("sector"),
                "Price": q.get("price"),
                "Change %": q.get("change_pct"),
                "Volume": q.get("volume"),
                "Data Quality": q.get("data_quality"),
                "Last Updated": datetime.now().isoformat()
            })
        await self.write_data(self.config.sheet_ksa, formatted, "A5") # Assuming data starts A5

    # 3. Global Markets
    async def get_global_market(self) -> pd.DataFrame:
        data = await self.read_range(self.config.sheet_global)
        return pd.DataFrame(data)

    async def update_global_market(self, quotes: List[Dict[str, Any]]):
        formatted = []
        for q in quotes:
            formatted.append({
                "Ticker": q.get("symbol"),
                "Company Name": q.get("name"),
                "Sector": q.get("sector"),
                "Current Price": q.get("price"),
                "Percent Change": q.get("change_pct"),
                "P/E Ratio": q.get("pe_ratio"),
                "Overall Score": q.get("opportunity_score")
            })
        await self.write_data(self.config.sheet_global, formatted, "A5")

    # 4. My Portfolio
    async def get_portfolio(self) -> pd.DataFrame:
        data = await self.read_range(self.config.sheet_portfolio)
        return pd.DataFrame(data)

    # 5. Mutual Funds
    async def update_funds(self, funds_data: List[Dict[str, Any]]):
        await self.write_data(self.config.sheet_funds, funds_data, "A2")

    # 6. Commodities & FX
    async def update_commodities(self, comm_data: List[Dict[str, Any]]):
        await self.write_data(self.config.sheet_commodities, comm_data, "A6")

    # 7. Insights Analysis
    async def update_insights(self, analysis_data: List[Dict[str, Any]]):
        await self.write_data(self.config.sheet_insights, analysis_data, "A10")

    # 8. Investment Advisor
    async def get_advisor_recommendations(self) -> List[Dict[str, Any]]:
        return await self.read_range(self.config.sheet_advisor)

    # 9. Advisor Assumptions
    async def get_assumptions(self) -> Dict[str, Any]:
        data = await self.read_range(self.config.sheet_assumptions)
        # Convert list of key-value pairs to dict
        return {row.get("Parameter"): row.get("Value") for row in data if "Parameter" in row}

    # ------------------------------------------------------------------
    # Internal Helpers
    # ------------------------------------------------------------------

    async def _batch_update(self, data_list: List[Dict[str, Any]]):
        service = await self._get_service()
        body = {
            "valueInputOption": "USER_ENTERED",
            "data": data_list
        }
        loop = asyncio.get_running_loop()
        await loop.run_in_executor(
            None,
            lambda: service.spreadsheets().values().batchUpdate(
                spreadsheetId=self.config.spreadsheet_id, body=body
            ).execute()
        )

    def _get_from_cache(self, key: str):
        if key in self._memory_cache:
            data, ts = self._memory_cache[key]
            if time.time() - ts < self.config.cache_ttl:
                return data
        return None

    def _save_to_cache(self, key: str, data: Any):
        self._memory_cache[key] = (data, time.time())

# ======================================================================
# Global Instance & Convenience
# ======================================================================

_service_instance = None

async def get_google_sheets_service():
    global _service_instance
    if not _service_instance:
        _service_instance = AsyncGoogleSheetsService()
    return _service_instance

if __name__ == "__main__":
    # Quick Test
    async def test():
        svc = AsyncGoogleSheetsService()
        print(f"Connected to Sheet ID: {svc.config.spreadsheet_id}")
        # Try reading KSA
        try:
            ksa = await svc.read_range("KSA_Tadawul", "A1:C5")
            print(f"KSA Sample: {ksa}")
        except Exception as e:
            print(f"Read failed (expected if creds missing): {e}")

    asyncio.run(test())
```
